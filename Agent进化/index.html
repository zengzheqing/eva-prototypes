<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVA · Agent进化</title>

    <!--
    ============================================================
    EVA 原型模板 v1.1 · Agent进化模块
    ============================================================
    设计规范: ../EVA-Design-System.md (第10节)
    协作规范: ../../AI协作/AI-Collaboration-Guide.md (第8节)
    模板上下文: 功能模块/Agent进化/_CONTEXT.md
    对照取舍: 功能模块/Agent进化/_MERGE-NOTES.md

    说明:
    - 本文件为唯一入口（主线原型）
    - 交互模式: 可点击能力卡片（手风琴展开），支持进化、升级动效与结果反馈
    - 画板模式: 展示关键页面状态与弹窗快照
    ============================================================
    -->

    <!-- ========== @FROZEN: 设计系统核心样式 ========== -->
    <!-- ========== 内联样式 (生成于 2026-02-01 21:59) ========== -->
<style>
/* ========== eva-base.css ========== */
/**
 * EVA Design System - Base Styles
 * Version: 2.0
 *
 * 使用说明: 在 HTML 的 <head> 中引用
 * <link rel="stylesheet" href="eva-base.css">
 *
 * 规范文档: EVA-Design-System.md
 * 视觉参考: eva-enterprise-onboarding (Google AI Studio)
 */

/* ========== @FROZEN: 色彩系统 ========== */
/* 说明: 所有颜色值遵循 EVA-Design-System.md */
:root {
    /* 背景色 */
    --bg: #f8fafc;
    --bg-elevated: #ffffff;
    --bg-subtle: #f1f5f9;

    /* 文字色 */
    --text: #0f172a;
    --text-secondary: #64748b;
    --text-muted: #94a3b8;

    /* 主色调 */
    --accent: #6366f1;
    --accent-light: #e0e7ff;
    --accent-glow: rgba(99, 102, 241, 0.15);
    --accent-hover: #4f46e5;

    /* 功能色 */
    --success: #10b981;
    --success-light: #ecfdf5;
    --warning: #f59e0b;
    --warning-light: #fffbeb;
    --danger: #ef4444;
    --danger-light: #fef2f2;

    /* 边框色 */
    --border: #e2e8f0;
    --border-subtle: #f1f5f9;

    /* 阴影 - 升级版 */
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
    --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    --shadow-accent: 0 10px 40px -10px rgba(99, 102, 241, 0.3);
    --shadow-inner: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05);

    /* 圆角 - 升级版（更大更现代） */
    --radius-sm: 12px;
    --radius: 16px;
    --radius-lg: 24px;
    --radius-xl: 32px;
    --radius-2xl: 40px;
    --radius-3xl: 48px;
    --radius-full: 9999px;

    /* 间距系统 */
    --space-1: 4px;
    --space-2: 8px;
    --space-3: 12px;
    --space-4: 16px;
    --space-5: 20px;
    --space-6: 24px;
    --space-8: 32px;
    --space-10: 40px;
    --space-12: 48px;
    --space-16: 64px;

    /* 过渡时间 */
    --duration-fast: 0.15s;
    --duration: 0.3s;
    --duration-slow: 0.5s;
    --duration-slower: 0.7s;
}

/* ========== @END-FROZEN ========== */


/* ========== @FROZEN: 全局重置 ========== */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
}

/* ========== @END-FROZEN ========== */


/* ========== @FROZEN: 排版系统 ========== */
.title {
    font-size: 32px;
    font-weight: 700;
    color: var(--text);
    line-height: 1.2;
    margin-bottom: 12px;
    letter-spacing: -0.025em;
}

.title-xl {
    font-size: 40px;
    font-weight: 900;
    color: var(--text);
    line-height: 1.1;
    letter-spacing: -0.03em;
}

.subtitle {
    font-size: 16px;
    color: var(--text-secondary);
    line-height: 1.7;
    margin-bottom: 40px;
}

.label {
    display: block;
    font-size: 11px;
    font-weight: 700;
    color: var(--text-secondary);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
}

/* 字体工具类 */
.font-black {
    font-weight: 900;
}

.font-bold {
    font-weight: 700;
}

.font-semibold {
    font-weight: 600;
}

.font-medium {
    font-weight: 500;
}

.tracking-tighter {
    letter-spacing: -0.05em;
}

.tracking-tight {
    letter-spacing: -0.025em;
}

.tracking-normal {
    letter-spacing: 0;
}

.tracking-wide {
    letter-spacing: 0.025em;
}

.tracking-wider {
    letter-spacing: 0.05em;
}

.tracking-widest {
    letter-spacing: 0.1em;
}

.uppercase {
    text-transform: uppercase;
}

.capitalize {
    text-transform: capitalize;
}

/* ========== @END-FROZEN ========== */


/* ========== @FROZEN: 按钮系统 ========== */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 18px 40px;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: var(--radius-xl);
    font-weight: 700;
    cursor: pointer;
    font-size: 16px;
    letter-spacing: -0.01em;
    transition: all var(--duration);
    text-decoration: none;
}

.btn:hover {
    background: var(--accent-hover);
    transform: translateY(-2px) scale(1.02);
    box-shadow: var(--shadow-accent);
}

.btn:active {
    transform: translateY(0) scale(0.98);
}

.btn-lg {
    padding: 22px 48px;
    font-size: 18px;
    font-weight: 900;
    border-radius: var(--radius-2xl);
}

.btn-secondary {
    background: transparent;
    color: var(--text);
    border: 2px solid var(--border);
}

.btn-secondary:hover {
    background: var(--bg-subtle);
    border-color: var(--accent);
    box-shadow: none;
}

.btn-ghost {
    background: transparent;
    color: var(--text-secondary);
    padding: 10px 20px;
}

.btn-ghost:hover {
    color: var(--accent);
    background: var(--accent-light);
    box-shadow: none;
    transform: none;
}

.btn-sm {
    padding: 12px 24px;
    font-size: 13px;
    font-weight: 600;
}

.btn-full {
    width: 100%;
}

.btn-dark {
    background: var(--text);
    color: white;
}

.btn-dark:hover {
    background: #1e293b;
    box-shadow: var(--shadow-lg);
}

/* ========== @END-FROZEN ========== */


/* ========== @FROZEN: 输入框系统 ========== */
.input-box {
    margin-bottom: 28px;
}

.input {
    width: 100%;
    padding: 18px 20px;
    border: 2px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    font-size: 16px;
    outline: none;
    transition: all var(--duration);
    background: var(--bg);
    color: var(--text);
}

.input::placeholder {
    color: var(--text-muted);
}

.input:focus {
    background: white;
    border-color: var(--accent);
    box-shadow: 0 0 0 4px var(--accent-light);
}

.input:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

textarea.input {
    min-height: 120px;
    resize: vertical;
}

.input-lg {
    padding: 20px 24px;
    font-size: 18px;
    border-radius: var(--radius-xl);
}

/* ========== @END-FROZEN ========== */


/* ========== @FROZEN: 卡片系统 ========== */
.card {
    background: var(--bg-elevated);
    padding: 32px;
    border-radius: var(--radius-2xl);
    box-shadow: var(--shadow-card);
    border: 2px solid transparent;
    transition: all var(--duration-slow);
    position: relative;
    overflow: hidden;
}

.card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
}

.card.active {
    border-color: var(--success);
    transform: translateY(-4px) scale(1.02);
    box-shadow: var(--shadow-lg);
}

.card.active::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--success);
}

.card.dim {
    opacity: 0.5;
    transform: scale(0.98);
    filter: grayscale(0.3);
}

.card-lg {
    padding: 40px;
    border-radius: var(--radius-3xl);
}

.card-interactive {
    cursor: pointer;
}

.card-interactive:hover {
    border-color: var(--accent);
}

/* ========== @END-FROZEN ========== */


/* ========== @FROZEN: 标签/徽章系统 ========== */
.tag {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    padding: 4px 10px;
    border-radius: 6px;
    background: var(--bg-subtle);
    color: var(--text-secondary);
    border: 1px solid var(--border);
}

.tag.core {
    background: #eef2ff;
    color: var(--accent);
    border-color: #c7d2fe;
    font-weight: 600;
}

.badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    font-weight: 500;
    padding: 2px 8px;
    border-radius: 20px;
}

.badge.success {
    background: rgba(16, 185, 129, 0.15);
    color: var(--success);
}

.badge.warning {
    background: rgba(245, 158, 11, 0.15);
    color: var(--warning);
}

.badge.danger {
    background: rgba(239, 68, 68, 0.15);
    color: var(--danger);
}

.badge.info {
    background: var(--accent-light);
    color: var(--accent);
}

/* ========== @END-FROZEN ========== */


/* ========== @FROZEN: 进度指示器 ========== */
.stepper {
    display: flex;
    gap: 8px;
    margin-bottom: 40px;
}

.step-dot {
    width: 32px;
    height: 6px;
    background: var(--border);
    border-radius: 3px;
    transition: all var(--duration);
}

.step-dot.active {
    background: var(--accent);
    width: 48px;
}

.step-dot.done {
    background: var(--success);
}

/* ========== @END-FROZEN ========== */


/* ========== @FROZEN: 图标容器 ========== */
.icon-box {
    width: 48px;
    height: 48px;
    background: var(--bg-subtle);
    border-radius: var(--radius);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    transition: all var(--duration);
}

.icon-box.active {
    background: var(--success-light);
    color: var(--success);
}

.icon-box.accent {
    background: var(--accent-light);
    color: var(--accent);
}

/* ========== @END-FROZEN ========== */


/* ========== @FROZEN: 网格系统 ========== */
.grid {
    display: grid;
    gap: 20px;
}

.grid-2 {
    grid-template-columns: repeat(2, 1fr);
}

.grid-3 {
    grid-template-columns: repeat(3, 1fr);
}

.grid-4 {
    grid-template-columns: repeat(4, 1fr);
}

.grid-12 {
    grid-template-columns: repeat(12, 1fr);
}

.col-2 {
    grid-column: span 2;
}

.col-3 {
    grid-column: span 3;
}

.col-4 {
    grid-column: span 4;
}

.col-6 {
    grid-column: span 6;
}

.col-8 {
    grid-column: span 8;
}

.col-12 {
    grid-column: span 12;
}

/* ========== @END-FROZEN ========== */


/* ========== @FROZEN: 工具类 ========== */
/* Flex */
.flex {
    display: flex;
}

.flex-col {
    flex-direction: column;
}

.items-center {
    align-items: center;
}

.justify-center {
    justify-content: center;
}

.justify-between {
    justify-content: space-between;
}

.gap-sm {
    gap: 8px;
}

.gap-md {
    gap: 16px;
}

.gap-lg {
    gap: 24px;
}

/* Spacing */
.mt-sm {
    margin-top: 8px;
}

.mt-md {
    margin-top: 16px;
}

.mt-lg {
    margin-top: 24px;
}

.mt-xl {
    margin-top: 32px;
}

.mb-sm {
    margin-bottom: 8px;
}

.mb-md {
    margin-bottom: 16px;
}

.mb-lg {
    margin-bottom: 24px;
}

.mb-xl {
    margin-bottom: 32px;
}

/* Text */
.text-center {
    text-align: center;
}

.text-muted {
    color: var(--text-muted);
}

.text-secondary {
    color: var(--text-secondary);
}

.text-accent {
    color: var(--accent);
}

.text-success {
    color: var(--success);
}

.font-bold {
    font-weight: 600;
}

/* Display */
.hidden {
    display: none;
}

.block {
    display: block;
}

/* ========== @END-FROZEN ========== */


/* ========== @STABLE: 页面切换 ========== */
/* 说明: 可以调整动画参数，但不要删除 */
.page {
    display: none;
}

.page.active {
    display: flex;
}

/* ========== @END-STABLE ========== */

/* ========== eva-animations.css ========== */
/**
 * EVA Design System - Animations
 * Version: 2.0
 *
 * 使用说明: 在 HTML 的 <head> 中引用（在 eva-base.css 之后）
 * <link rel="stylesheet" href="eva-animations.css">
 *
 * 来源: 深色版的优秀视觉效果 + 白色版的轨道动画 + Google AI Studio 版本动效
 */

/* ========== @FROZEN: 环境动画背景 (来源: 深色版) ========== */
/* 说明: 已适配浅色主题，创造柔和的动态背景效果 */
.ambient {
    position: fixed;
    inset: 0;
    overflow: hidden;
    pointer-events: none;
    z-index: 0;
}

.ambient::before {
    content: '';
    position: absolute;
    width: 800px;
    height: 800px;
    background: radial-gradient(circle, rgba(99, 102, 241, 0.08), transparent 65%);
    top: -20%;
    left: -15%;
    animation: drift1 40s ease-in-out infinite;
}

.ambient::after {
    content: '';
    position: absolute;
    width: 600px;
    height: 600px;
    background: radial-gradient(circle, rgba(236, 72, 153, 0.05), transparent 65%);
    bottom: -15%;
    right: -10%;
    animation: drift2 35s ease-in-out infinite;
}

/* 环境圆（白色版原有的，保留兼容） */
.ambient-circle {
    position: absolute;
    border-radius: 50%;
    filter: blur(80px);
    opacity: 0.6;
    z-index: 0;
}

.ac-1 {
    width: 600px;
    height: 600px;
    background: rgba(99, 102, 241, 0.08);
    top: -10%;
    right: 10%;
}

.ac-2 {
    width: 500px;
    height: 500px;
    background: rgba(236, 72, 153, 0.05);
    bottom: -10%;
    left: 20%;
}

/* ========== @END-FROZEN ========== */


/* ========== @FROZEN: 漂移动画关键帧 ========== */
@keyframes drift1 {

    0%,
    100% {
        transform: translate(0, 0);
    }

    50% {
        transform: translate(50px, 50px);
    }
}

@keyframes drift2 {

    0%,
    100% {
        transform: translate(0, 0);
    }

    50% {
        transform: translate(-30px, -30px);
    }
}

/* ========== @END-FROZEN ========== */


/* ========== @FROZEN: 轨道动画 (来源: 白色版) ========== */
/* 说明: 用于 Hero 区域的装饰性动画 */
.hero-illustration {
    position: relative;
    width: 500px;
    height: 500px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.orbit {
    position: absolute;
    border: 1px dashed #cbd5e1;
    border-radius: 50%;
}

.o1 {
    width: 280px;
    height: 280px;
    animation: spin 20s linear infinite;
}

.o2 {
    width: 460px;
    height: 460px;
    animation: spin 30s linear infinite reverse;
}

.agent-center {
    width: 140px;
    height: 140px;
    background: white;
    border-radius: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 60px;
    box-shadow: 0 20px 60px rgba(99, 102, 241, 0.15);
    z-index: 2;
}

.orbit-item {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 40px;
    height: 40px;
    background: white;
    border-radius: 10px;
    box-shadow: var(--shadow-card, 0 4px 6px -1px rgba(0, 0, 0, 0.05));
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
}

/* ========== @END-FROZEN ========== */


/* ========== @FROZEN: 通用动画关键帧 ========== */
/* 旋转 */
@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

/* 淡入 */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* 淡入（无位移） */
@keyframes fadeInSimple {
    from {
        opacity: 0;
    }

    to {
        opacity: 1;
    }
}

/* 脉冲 */
@keyframes pulse {

    0%,
    100% {
        opacity: 1;
    }

    50% {
        opacity: 0.5;
    }
}

/* 弹跳 */
@keyframes bounce {

    0%,
    100% {
        transform: translateY(0);
    }

    50% {
        transform: translateY(-10px);
    }
}

/* 缩放脉冲 */
@keyframes scalePulse {

    0%,
    100% {
        transform: scale(1);
    }

    50% {
        transform: scale(1.05);
    }
}

/* 闪烁 */
@keyframes blink {

    0%,
    100% {
        opacity: 1;
    }

    50% {
        opacity: 0;
    }
}

/* 滑入（从右） */
@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(20px);
    }

    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* 滑入（从左） */
@keyframes slideInLeft {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }

    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* ========== @END-FROZEN ========== */


/* ========== @FROZEN: 动画工具类 ========== */
/* 基础淡入 */
.fade-in {
    animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
}

.fade-in-fast {
    animation: fadeIn 0.3s ease forwards;
}

.fade-in-slow {
    animation: fadeIn 1s ease forwards;
}

/* 脉冲 */
.pulse {
    animation: pulse 2s infinite;
}

/* 旋转 */
.spin {
    animation: spin 1s linear infinite;
}

.spin-slow {
    animation: spin 3s linear infinite;
}

/* 弹跳 */
.bounce {
    animation: bounce 2s ease-in-out infinite;
}

/* 滑入 */
.slide-in-right {
    animation: slideInRight 0.4s ease forwards;
}

.slide-in-left {
    animation: slideInLeft 0.4s ease forwards;
}

/* ========== @END-FROZEN ========== */


/* ========== @FROZEN: 加载指示器 ========== */
.loader {
    width: 20px;
    height: 20px;
    border: 2px solid var(--accent, #6366f1);
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

.loader-sm {
    width: 14px;
    height: 14px;
    border-width: 1.5px;
}

.loader-lg {
    width: 32px;
    height: 32px;
    border-width: 3px;
}

/* 状态监视器 */
.status-monitor {
    background: white;
    border-radius: 16px;
    padding: 16px 24px;
    box-shadow: var(--shadow-lg, 0 20px 25px -5px rgba(0, 0, 0, 0.1));
    display: flex;
    align-items: center;
    gap: 16px;
    border: 1px solid var(--border, #e2e8f0);
}

/* ========== @END-FROZEN ========== */


/* ========== @STABLE: 延迟动画 ========== */
/* 说明: 用于序列化动画效果，可根据需要调整延迟值 */
.delay-100 {
    animation-delay: 0.1s;
}

.delay-200 {
    animation-delay: 0.2s;
}

.delay-300 {
    animation-delay: 0.3s;
}

.delay-400 {
    animation-delay: 0.4s;
}

.delay-500 {
    animation-delay: 0.5s;
}

.delay-600 {
    animation-delay: 0.6s;
}

.delay-700 {
    animation-delay: 0.7s;
}

.delay-800 {
    animation-delay: 0.8s;
}

.delay-900 {
    animation-delay: 0.9s;
}

.delay-1000 {
    animation-delay: 1s;
}

/* ========== @END-STABLE ========== */


/* ========== @STABLE: 高级动画 (来源: Google AI Studio) ========== */
/* 滑入淡出 - 从底部 */
@keyframes slideInFromBottom {
    from {
        opacity: 0;
        transform: translateY(20px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* 缩放淡入 */
@keyframes zoomIn {
    from {
        opacity: 0;
        transform: scale(0.95);
    }

    to {
        opacity: 1;
        transform: scale(1);
    }
}

/* 缩放淡出 */
@keyframes zoomOut {
    from {
        opacity: 1;
        transform: scale(1);
    }

    to {
        opacity: 0;
        transform: scale(0.95);
    }
}

/* 进度条条纹动画 */
@keyframes progressBarStripes {
    from {
        background-position: 24px 0;
    }

    to {
        background-position: 0 0;
    }
}

/* 脉冲指示器 */
@keyframes ping {

    75%,
    100% {
        transform: scale(2);
        opacity: 0;
    }
}

/* 打字光标闪烁 */
@keyframes cursorBlink {

    0%,
    100% {
        opacity: 1;
    }

    50% {
        opacity: 0;
    }
}

/* 滑动上升 */
@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* ========== @END-STABLE ========== */


/* ========== @STABLE: 组合动画工具类 ========== */
/* animate-in 系列 - 参考 Tailwind animate-in */
.animate-in {
    animation-duration: 0.5s;
    animation-timing-function: cubic-bezier(0.16, 1, 0.3, 1);
    animation-fill-mode: forwards;
}

.animate-in.fade-in {
    animation-name: fadeIn;
}

.animate-in.zoom-in {
    animation-name: zoomIn;
}

.animate-in.slide-in-from-bottom {
    animation-name: slideInFromBottom;
}

.animate-in.slide-in-from-top {
    animation-name: slideInFromBottom;
    animation-direction: reverse;
}

/* 脉冲指示器 */
.animate-ping {
    animation: ping 1s cubic-bezier(0, 0, 0.2, 1) infinite;
}

/* 呼吸脉冲 */
.animate-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

/* 慢速旋转 */
.animate-spin-slow {
    animation: spin 3s linear infinite;
}

/* 打字光标 */
.cursor-blink {
    animation: cursorBlink 1s step-end infinite;
}

/* ========== @END-STABLE ========== */


/* ========== @STABLE: 进度条组件 ========== */
.progress-bar {
    height: 24px;
    background: white;
    border-radius: var(--radius-full, 9999px);
    padding: 4px;
    border: 1px solid var(--border, #e2e8f0);
    box-shadow: var(--shadow-sm, 0 1px 2px 0 rgba(0, 0, 0, 0.05));
    overflow: hidden;
}

.progress-bar-fill {
    height: 100%;
    background: var(--accent, #6366f1);
    border-radius: var(--radius-full, 9999px);
    transition: width 0.5s ease-out;
    box-shadow: 0 0 20px rgba(99, 102, 241, 0.4);
    position: relative;
}

.progress-bar-fill::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(45deg,
            rgba(255, 255, 255, 0.15) 25%,
            transparent 25%,
            transparent 50%,
            rgba(255, 255, 255, 0.15) 50%,
            rgba(255, 255, 255, 0.15) 75%,
            transparent 75%,
            transparent);
    background-size: 24px 24px;
    animation: progressBarStripes 1s linear infinite;
}

/* ========== @END-STABLE ========== */


/* ========== @STABLE: 状态指示器 ========== */
.status-dot {
    position: relative;
    display: inline-flex;
    width: 8px;
    height: 8px;
}

.status-dot::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 50%;
    background: currentColor;
    animation: ping 1s cubic-bezier(0, 0, 0.2, 1) infinite;
    opacity: 0.75;
}

.status-dot::after {
    content: '';
    position: relative;
    display: inline-flex;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: currentColor;
}

.status-dot.success {
    color: var(--success, #10b981);
}

.status-dot.warning {
    color: var(--warning, #f59e0b);
}

.status-dot.danger {
    color: var(--danger, #ef4444);
}

.status-dot.accent {
    color: var(--accent, #6366f1);
}

/* ========== @END-STABLE ========== */


/* ========== @STABLE: 终端日志样式 ========== */
.terminal {
    background: #0f172a;
    border-radius: var(--radius-2xl, 32px);
    padding: 32px;
    font-family: 'JetBrains Mono', 'Fira Code', monospace;
    font-size: 13px;
    color: #e2e8f0;
    overflow-y: auto;
    box-shadow: var(--shadow-xl, 0 25px 50px -12px rgba(0, 0, 0, 0.25));
}

.terminal-header {
    display: flex;
    align-items: center;
    gap: 12px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding-bottom: 16px;
    margin-bottom: 16px;
    color: rgba(255, 255, 255, 0.4);
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
}

.terminal-dots {
    display: flex;
    gap: 6px;
}

.terminal-dots span {
    width: 10px;
    height: 10px;
    border-radius: 50%;
}

.terminal-dots span:nth-child(1) {
    background: rgba(239, 68, 68, 0.5);
}

.terminal-dots span:nth-child(2) {
    background: rgba(245, 158, 11, 0.5);
}

.terminal-dots span:nth-child(3) {
    background: rgba(16, 185, 129, 0.5);
}

.terminal-log {
    display: flex;
    gap: 12px;
    margin-bottom: 12px;
    animation: slideInFromBottom 0.3s ease forwards;
}

.terminal-log-num {
    color: rgba(255, 255, 255, 0.2);
    user-select: none;
}

.terminal-log-success {
    color: #818cf8;
    font-weight: 700;
}

/* ========== @END-STABLE ========== */

</style>
    <style>
        :root {
            /* 主色 */
            --eva-primary: #6366f1;
            --eva-primary-light: #818cf8;
            --eva-primary-dark: #4f46e5;
            --eva-primary-bg: rgba(99, 102, 241, 0.08);
            --eva-primary-glow: rgba(99, 102, 241, 0.15);

            /* 功能色 */
            --eva-success: #10b981;
            --eva-success-bg: rgba(16, 185, 129, 0.08);
            --eva-warning: #f59e0b;
            --eva-warning-bg: rgba(245, 158, 11, 0.08);
            --eva-error: #ef4444;
            --eva-error-bg: rgba(239, 68, 68, 0.08);
            --eva-info: #3b82f6;
            --eva-info-bg: rgba(59, 130, 246, 0.08);

            /* 中性色 */
            --eva-bg: #fafafa;
            --eva-surface: #ffffff;
            --eva-border: #e5e7eb;
            --eva-border-light: #f3f4f6;
            --eva-text-primary: #111827;
            --eva-text-secondary: #6b7280;
            --eva-text-tertiary: #9ca3af;
            --eva-text-disabled: #d1d5db;

            /* 阴影 */
            --eva-shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --eva-shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --eva-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --eva-shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);

            /* 圆角 */
            --eva-radius-sm: 4px;
            --eva-radius-md: 8px;
            --eva-radius-lg: 12px;
            --eva-radius-xl: 16px;
            --eva-radius-full: 9999px;

            /* 间距 */
            --eva-space-xs: 4px;
            --eva-space-sm: 8px;
            --eva-space-md: 16px;
            --eva-space-lg: 24px;
            --eva-space-xl: 32px;
            --eva-space-2xl: 48px;

            /* 过渡 */
            --eva-transition-fast: 150ms ease;
            --eva-transition-normal: 250ms ease;
            --eva-transition-slow: 350ms ease;

            /* 布局 */
            --sidebar-width: 280px;
            --header-height: 64px;
        }

        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 14px; scroll-behavior: smooth; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--eva-bg);
            color: var(--eva-text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            display: flex;
            min-height: 100vh;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--eva-space-sm);
            padding: var(--eva-space-sm) var(--eva-space-md);
            border: none;
            border-radius: var(--eva-radius-md);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--eva-transition-fast);
            text-decoration: none;
            user-select: none;
        }

        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.55;
            transform: none !important;
            box-shadow: none !important;
        }

        .btn-primary { background: var(--eva-primary); color: white; }
        .btn-primary:hover { background: var(--eva-primary-dark); transform: translateY(-1px); box-shadow: var(--eva-shadow-md); }

        .btn-secondary { background: var(--eva-surface); color: var(--eva-text-primary); border: 1px solid var(--eva-border); }
        .btn-secondary:hover { background: var(--eva-border-light); }

        .btn-ghost { background: transparent; color: var(--eva-text-secondary); }
        .btn-ghost:hover { background: var(--eva-border-light); color: var(--eva-text-primary); }

        .btn-danger { background: var(--eva-error); color: white; }
        .btn-danger:hover { filter: brightness(0.95); transform: translateY(-1px); box-shadow: var(--eva-shadow-md); }

        .card {
            background: var(--eva-surface);
            border-radius: var(--eva-radius-lg);
            border: 1px solid var(--eva-border);
            padding: var(--eva-space-lg);
            transition: all var(--eva-transition-fast);
        }

        .card:hover { box-shadow: var(--eva-shadow-md); }

        .input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--eva-border);
            border-radius: var(--eva-radius-md);
            font-size: 14px;
            transition: all var(--eva-transition-fast);
            background: var(--eva-surface);
        }

        .input:focus {
            outline: none;
            border-color: var(--eva-primary);
            box-shadow: 0 0 0 3px var(--eva-primary-bg);
        }

	        .tag {
	            display: inline-flex;
	            align-items: center;
	            padding: 2px 8px;
	            border-radius: var(--eva-radius-full);
	            font-size: 12px;
	            font-weight: 600;
	            border: 1px solid transparent;
	            user-select: none;
	            white-space: nowrap;
	        }

        .tag-primary { background: var(--eva-primary-bg); color: var(--eva-primary); }
        .tag-success { background: var(--eva-success-bg); color: var(--eva-success); }
        .tag-warning { background: var(--eva-warning-bg); color: var(--eva-warning); }
        .tag-error { background: var(--eva-error-bg); color: var(--eva-error); }
        .tag-info { background: var(--eva-info-bg); color: var(--eva-info); }
        .tag-muted { background: var(--eva-border-light); color: var(--eva-text-secondary); }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes heartbeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 5px var(--eva-primary-glow); } 50% { box-shadow: 0 0 20px var(--eva-primary-glow); } }

        .animate-fade-in { animation: fadeIn var(--eva-transition-normal); }
        .animate-slide-up { animation: slideUp var(--eva-transition-normal); }
        .animate-pulse { animation: pulse 2s ease-in-out infinite; }
        .animate-spin { animation: spin 1s linear infinite; }
        .animate-heartbeat { animation: heartbeat 1.5s ease-in-out infinite; }
        .animate-glow { animation: glow 2s ease-in-out infinite; }
    </style>
    <!-- ========== @END-FROZEN: 设计系统核心样式 ========== -->

    <style>
        /* ========== @FROZEN: 侧边栏导航与主布局 ========== */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--eva-surface);
            border-right: 1px solid var(--eva-border);
            position: sticky;
            top: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            z-index: 20;
            flex-shrink: 0;
        }

        .logo {
            height: 72px;
            display: flex;
            align-items: center;
            padding: 0 28px;
            font-weight: 700;
            font-size: 20px;
            border-bottom: 1px solid var(--eva-border);
            gap: 10px;
            color: var(--eva-primary);
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--eva-primary) 0%, var(--eva-primary-dark) 100%);
            border-radius: var(--eva-radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .nav-section { padding: 20px 16px; }
        .nav-section:not(:last-child) { border-bottom: 1px solid var(--eva-border-light); }

        .nav-label {
            font-size: 10px;
            font-weight: 700;
            color: var(--eva-text-tertiary);
            text-transform: uppercase;
            padding: 0 12px 10px;
            letter-spacing: 0.1em;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            font-size: 14px;
            border-radius: var(--eva-radius-md);
            color: var(--eva-text-secondary);
            cursor: pointer;
            transition: all .2s;
            font-weight: 600;
            text-decoration: none;
            position: relative;
        }

        .nav-item:hover { background: var(--eva-border-light); color: var(--eva-text-primary); }
        .nav-item.active { background: var(--eva-primary-bg); color: var(--eva-primary); }

        .nav-item-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--eva-error);
            color: white;
            font-size: 10px;
            font-weight: 800;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            margin-top: auto;
            border-top: 1px solid var(--eva-border);
            cursor: pointer;
            transition: background 0.2s;
        }

        .user-profile:hover { background: var(--eva-border-light); }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4DB6AC, #00897B);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .user-info { flex: 1; min-width: 0; }
        .user-name { font-size: 14px; font-weight: 700; color: var(--eva-text-primary); }
        .user-company { font-size: 12px; color: var(--eva-text-secondary); }
        .user-expand { color: var(--eva-text-tertiary); font-size: 10px; }

        .main { flex: 1; min-width: 0; display: flex; flex-direction: column; }

	        .topbar {
	            height: var(--header-height);
	            background: var(--eva-surface);
	            border-bottom: 1px solid var(--eva-border);
	            display: flex;
	            align-items: center;
	            justify-content: flex-start;
	            padding: 0 32px;
	            position: sticky;
	            top: 0;
	            z-index: 19;
	            gap: 12px;
	        }

	        .topbar-title { font-size: 18px; font-weight: 700; color: var(--eva-text-primary); }

	        .topbar-actions { display: flex; align-items: center; gap: 12px; }

	        .topbar-back {
	            width: 36px;
	            height: 36px;
	            border-radius: 12px;
	            border: 1px solid var(--eva-border);
	            background: white;
	            color: var(--eva-text-primary);
	            cursor: pointer;
	            display: none;
	            align-items: center;
	            justify-content: center;
	            font-size: 16px;
	            box-shadow: var(--eva-shadow-sm);
	        }

	        body.route-tuning .topbar-back { display: inline-flex; }

	        .content {
	            padding: 32px;
	            max-width: 1320px;
	            margin: 0 auto;
	            width: 100%;
	        }
        /* ========== @END-FROZEN ========== */

        /* ========== Agent进化：页面结构（轮播选中能力 + 下方详情） ========== */
        .evolve-hero {
            position: relative;
            overflow: hidden;
            border-radius: var(--eva-radius-xl);
            border: 1px solid rgba(99, 102, 241, 0.18);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.10) 0%, rgba(255,255,255,1) 56%);
            padding: 16px 16px 14px;
            margin-bottom: 14px;
        }

        .evolve-hero::before {
            content: '';
            position: absolute;
            top: -70%;
            right: -22%;
            width: 480px;
            height: 480px;
            background: radial-gradient(circle, var(--eva-primary-glow) 0%, transparent 70%);
            pointer-events: none;
        }

        .evolve-hero-row {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 16px;
        }

        .evolve-title {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 0;
        }

        .evolve-title .icon {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            background: linear-gradient(135deg, #4DB6AC, #00897B);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 10px 24px rgba(99, 102, 241, 0.25);
            flex-shrink: 0;
        }

        .evolve-title h2 { font-size: 18px; font-weight: 900; margin-bottom: 2px; }
        .evolve-title p { font-size: 13px; color: var(--eva-text-secondary); }

        .summary-pills {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .pill {
            background: white;
            border: 1px solid var(--eva-border);
            border-radius: 999px;
            padding: 8px 12px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--eva-shadow-sm);
            user-select: none;
        }

        .pill .k { font-size: 12px; color: var(--eva-text-secondary); font-weight: 800; }
        .pill .v { font-size: 14px; font-weight: 900; letter-spacing: -0.01em; }
        .pill .v.success { color: var(--eva-success); }
        .pill .v.info { color: var(--eva-info); }
	        .pill .v.warning { color: var(--eva-warning); }

	        .ability-switch {
	            border: 1px solid rgba(99, 102, 241, 0.18);
	            background: white;
	            border-radius: var(--eva-radius-xl);
	            padding: 14px;
	            margin-bottom: 14px;
	            box-shadow: var(--eva-shadow-sm);
	        }

	        .ability-tiles {
	            display: grid;
	            grid-template-columns: repeat(4, minmax(0, 1fr));
	            gap: 12px;
	        }

	        .ability-tile {
	            text-align: left;
	            border: 1px solid var(--eva-border);
	            background: white;
	            border-radius: 16px;
	            padding: 14px;
	            cursor: pointer;
	            transition: transform var(--eva-transition-fast), box-shadow var(--eva-transition-fast), border-color var(--eva-transition-fast);
	            position: relative;
	            min-height: 156px;
	            display: flex;
	            flex-direction: column;
	            gap: 10px;
	        }

	        .ability-tile:hover { transform: translateY(-1px); box-shadow: var(--eva-shadow-md); }
	        .ability-tile.is-active { border-color: var(--ability-color-border); box-shadow: 0 0 0 3px var(--ability-color-bg), var(--eva-shadow-lg); }

	        .ability-tile .head { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
	        .ability-tile .left { display: flex; align-items: center; gap: 10px; min-width: 0; }
	        .ability-tile .i {
	            width: 44px; height: 44px; border-radius: 14px;
	            background: var(--ability-color-bg);
	            border: 1px solid var(--ability-color-border);
	            display: inline-flex; align-items: center; justify-content: center;
	            font-size: 20px; flex-shrink: 0;
	        }
	        .ability-tile .n { font-size: 15px; font-weight: 900; color: var(--eva-text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
	        .ability-tile .d { font-size: 12px; color: var(--eva-text-secondary); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

	        .ability-tile .progress-track { height: 14px; }
	        .ability-tile .progress-meta { margin-top: 8px; font-size: 12px; display: flex; justify-content: space-between; color: var(--eva-text-secondary); }
	        .ability-tile .progress-meta .pct { font-weight: 900; color: var(--eva-text-primary); }

	        .tuning-page { display: none; }
	        body.route-tuning #overviewPage { display: none; }
	        body.route-tuning #tuningPage { display: block; }

	        .tuning-shell {
	            border: 1px solid var(--eva-border);
	            border-radius: var(--eva-radius-xl);
	            background: white;
	            box-shadow: var(--eva-shadow-sm);
	            overflow: hidden;
	        }

		        :root {
		            --tuning-queue-w: 228px;
		        }

		        .tuning-wb { grid-template-columns: var(--tuning-queue-w) 1fr; min-height: 520px; }
		        .tuning-wb .wb-side { border-left: none; border-right: 1px solid var(--eva-border); background: linear-gradient(180deg, rgba(99, 102, 241, 0.04), rgba(255,255,255,1) 55%); display: flex; flex-direction: column; }
		        .tuning-wb .wb-list { flex: 1; overflow-y: auto; }
		        .tuning-wb .wb-main { padding: 10px 12px; gap: 8px; }
		        .tuning-wb .wb-question { gap: 8px; }
		        .tuning-wb .wb-side-head { padding: 10px 10px 8px; }
		        .tuning-wb .wb-list { padding: 8px; gap: 6px; }
		        .tuning-wb .wb-item .t { display: flex; align-items: center; gap: 6px; min-width: 0; }
		        .tuning-wb .wb-item .t .t-title { flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

	        .wb-item.leaving { opacity: 0; transform: translateY(-6px) scale(0.985); }

	        .tune-panel { border: 1px solid var(--eva-border); border-radius: 12px; background: white; padding: 10px; }
	        .tune-panel .h { font-weight: 900; color: var(--eva-text-primary); font-size: 13px; }
	        .tune-panel .d { font-size: 12px; color: var(--eva-text-secondary); margin-top: 4px; }
	        .tune-form { margin-top: 8px; display: grid; gap: 8px; }

		        .tune-actionbar {
		            border-top: 1px solid var(--eva-border);
		            padding: 10px 12px;
		            display: flex;
		            align-items: center;
		            justify-content: flex-end;
		            gap: 8px;
		            flex-wrap: wrap;
		            margin: 0 -12px -10px;
		            background: linear-gradient(180deg, rgba(255,255,255,0.72), rgba(255,255,255,1));
		        }

		        .tune-actionbar .left, .tune-actionbar .right {
		            display: inline-flex;
		            align-items: center;
		            gap: 8px;
		            flex-wrap: wrap;
		        }

		        .tune-mode .mode-grid {
		            margin-top: 8px;
		            display: grid;
		            grid-template-columns: 1fr 1fr;
		            align-items: start;
		            grid-auto-rows: min-content;
		            gap: 8px;
		        }

		        .mode-card {
		            width: 100%;
		            display: flex;
		            align-items: flex-start;
		            gap: 10px;
		            padding: 10px;
		            border-radius: 12px;
		            border: 1px solid var(--eva-border);
		            background: white;
		            text-align: left;
		            cursor: pointer;
		            align-self: start;
		            transition: all var(--eva-transition-fast);
		        }

		        .mode-card:hover { transform: translateY(-1px); box-shadow: var(--eva-shadow-sm); }
		        .mode-card .ic {
		            width: 30px;
		            height: 30px;
		            border-radius: 10px;
		            display: inline-flex;
		            align-items: center;
		            justify-content: center;
		            flex-shrink: 0;
		            border: 1px solid var(--eva-border);
		            background: var(--eva-border-light);
		            font-size: 14px;
		        }

		        .mode-card.is-primary { border-color: rgba(99,102,241,0.22); box-shadow: 0 0 0 3px rgba(99,102,241,0.10); }
		        .mode-card .t { font-weight: 900; color: var(--eva-text-primary); font-size: 13px; }
		        .mode-card .s { margin-top: 2px; font-size: 12px; color: var(--eva-text-secondary); }

		        @media (max-width: 860px) {
		            .tune-mode .mode-grid { grid-template-columns: 1fr; }
		        }

	        .pulse { animation: heartbeat 900ms ease-in-out; }

	        @media (max-width: 1120px) {
	            .ability-tiles { grid-template-columns: repeat(2, minmax(0, 1fr)); }
	        }

	        @media (max-width: 720px) {
	            .ability-tiles { grid-template-columns: 1fr; }
	        }

	        .wheel-shell {
	            background: linear-gradient(135deg, rgba(99, 102, 241, 0.08) 0%, rgba(255,255,255,1) 55%);
	            border: 1px solid rgba(99, 102, 241, 0.18);
	            border-radius: var(--eva-radius-xl);
	            padding: 20px 18px;
	            position: relative;
	            overflow: hidden;
	            margin-bottom: 14px;
	        }

        .wheel-shell::before {
            content: '';
            position: absolute;
            top: -70%;
            right: -20%;
            width: 420px;
            height: 420px;
            background: radial-gradient(circle, var(--eva-primary-glow) 0%, transparent 70%);
            pointer-events: none;
        }

	        .wheel-viewport {
            position: relative;
            z-index: 1;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            scroll-snap-type: x mandatory;
            scroll-padding: 40%;
	            padding: 18px 12px 22px;
	            perspective: 1100px;
	            perspective-origin: 50% 44%;
	        }

        .wheel-viewport::-webkit-scrollbar { height: 10px; }
        .wheel-viewport::-webkit-scrollbar-thumb { background: rgba(17,24,39,0.12); border-radius: 999px; }
        .wheel-viewport::-webkit-scrollbar-track { background: rgba(17,24,39,0.05); border-radius: 999px; }

        .wheel-track {
            display: flex;
            align-items: stretch;
            gap: 12px;
            transform-style: preserve-3d;
        }

	        .wheel-item {
            --ability-color: var(--eva-primary);
            --ability-color-light: var(--ability-color);
            --ability-color-bg: rgba(99, 102, 241, 0.08);
            --ability-color-border: rgba(99, 102, 241, 0.22);
            --ability-color-glow: rgba(99, 102, 241, 0.22);
            scroll-snap-align: center;
            flex: 0 0 clamp(340px, 46vw, 520px);
            border-radius: 16px;
            border: 1px solid var(--eva-border);
            background: white;
	            padding: 20px 20px;
	            min-height: 220px;
	            cursor: pointer;
	            transition: transform var(--eva-transition-normal), box-shadow var(--eva-transition-normal), border-color var(--eva-transition-normal), opacity var(--eva-transition-normal);
	            position: relative;
	            text-align: left;
	        }

        .wheel-item:hover { box-shadow: var(--eva-shadow-md); }
        .wheel-item.is-active {
            border-color: var(--ability-color-border);
            box-shadow: 0 0 0 3px var(--ability-color-bg), var(--eva-shadow-lg);
        }

        .wheel-item .row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 14px;
            margin-bottom: 12px;
        }

        .wheel-item .title {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0;
        }

	        .wheel-item .icon {
	            width: 56px;
	            height: 56px;
	            border-radius: 16px;
	            background: var(--ability-color-bg);
	            border: 1px solid var(--ability-color-border);
	            display: inline-flex;
	            align-items: center;
	            justify-content: center;
	            font-size: 24px;
	            flex-shrink: 0;
	        }

	        .wheel-item .name { font-size: 18px; font-weight: 900; letter-spacing: -0.01em; }
	        .wheel-item .desc { font-size: 13px; color: var(--eva-text-secondary); margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 360px; }

        .wheel-item .mini {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

	        .chip {
	            display: inline-flex;
	            align-items: center;
	            gap: 6px;
	            padding: 4px 10px;
	            border-radius: 999px;
	            border: 1px solid var(--eva-border);
	            background: var(--eva-surface);
	            font-size: 13px;
	            font-weight: 800;
	            color: var(--eva-text-secondary);
	            white-space: nowrap;
	        }

        .chip.success { border-color: rgba(16,185,129,0.22); background: var(--eva-success-bg); color: var(--eva-success); }
        .chip.warning { border-color: rgba(245,158,11,0.22); background: var(--eva-warning-bg); color: var(--eva-warning); }
        .chip.primary { border-color: rgba(99,102,241,0.22); background: var(--eva-primary-bg); color: var(--eva-primary); }
        .chip.evolvable {
            padding: 8px 14px;
            font-size: 15px;
            font-weight: 900;
            box-shadow: 0 14px 34px rgba(16, 185, 129, 0.22);
            animation: heartbeat 1.8s ease-in-out infinite;
        }

        .wheel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 2;
            width: 44px;
            height: 44px;
            border-radius: 16px;
            border: 1px solid var(--eva-border);
            background: rgba(255,255,255,0.92);
            box-shadow: var(--eva-shadow-md);
            color: var(--eva-text-primary);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 900;
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
        }

        .wheel-nav:hover { transform: translateY(-50%) scale(1.04); }
        .wheel-nav:active { transform: translateY(-50%) scale(0.98); }
        .wheel-nav.left { left: 10px; }
        .wheel-nav.right { right: 10px; }

        .wheel-item .version-badge {
            border-color: var(--ability-color-border);
            background: var(--ability-color-bg);
            color: var(--ability-color);
        }

        .detail-host {
            border: 1px solid var(--eva-border);
            border-radius: var(--eva-radius-xl);
            background: white;
            box-shadow: var(--eva-shadow-sm);
            overflow: hidden;
        }

        .detail-header {
            padding: 16px;
            border-bottom: 1px solid var(--eva-border);
            background: linear-gradient(135deg, var(--ability-color-bg) 0%, white 70%);
            display: grid;
            grid-template-columns: 1fr auto;
            grid-template-rows: auto auto;
            grid-template-areas:
                "main actions"
                "progress progress";
            align-items: start;
            column-gap: 14px;
            row-gap: 12px;
        }

        .detail-header .detail-main {
            grid-area: main;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 0;
        }

        .detail-header .detail-main .icon {
            width: 48px;
            height: 48px;
            border-radius: 18px;
            background: var(--ability-color-bg);
            border: 1px solid var(--ability-color-border);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            flex-shrink: 0;
        }

        .detail-header .name { font-size: 17px; font-weight: 900; letter-spacing: -0.01em; display: flex; align-items: center; gap: 8px; }
        .detail-header .desc { font-size: 13px; color: var(--eva-text-secondary); margin-top: 3px; }

        .detail-header .detail-actions {
            grid-area: actions;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
            flex-shrink: 0;
        }

        .detail-header .detail-progress {
            grid-area: progress;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

	        .detail-header .detail-progress .progress-track { height: 18px; }

        .detail-progress-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 12px;
            border-radius: 999px;
            border: 1px solid rgba(16,185,129,0.28);
            background: rgba(16,185,129,0.10);
            color: var(--eva-success);
            font-weight: 900;
        }

	        .wheel-item .progress-track { height: 18px; }
	        .wb .progress-track { height: 16px; }
        .wheel-item .progress-meta { font-size: 13px; }
        .detail-header .progress-meta { font-size: 13px; }

        .detail-body { padding: 16px; }

        .detail-body .detail-grid { grid-template-columns: 1.15fr 0.85fr; }

	        @media (max-width: 980px) {
	            .detail-body .detail-grid { grid-template-columns: 1fr; }
	            .wheel-item { flex: 0 0 340px; }
	            .wheel-nav { display: none; }
	        }

        @media (max-width: 720px) {
            .detail-header {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
                grid-template-areas:
                    "main"
                    "actions"
                    "progress";
            }

            .detail-header .detail-actions { align-items: flex-start; }
        }

        .btn-evolve-cta {
            padding: 16px 20px;
            font-size: 16px;
            font-weight: 900;
            border-radius: 14px;
        }

        .btn-evolve-cta:not(:disabled) {
            background: linear-gradient(135deg, var(--ability-color), var(--eva-primary-dark));
            box-shadow: 0 14px 32px var(--ability-color-bg);
        }

        .btn-evolve-cta:not(:disabled):hover {
            transform: translateY(-1px);
            box-shadow: 0 18px 40px var(--ability-color-bg);
        }

        #abilityDetailHost[data-status="evolvable"] .btn-evolve-cta:not(:disabled) {
            background: linear-gradient(135deg, var(--eva-success), #34d399);
            box-shadow: 0 18px 44px rgba(16,185,129,0.22);
            animation: ctaGlow 1.6s ease-in-out infinite;
        }

        #abilityDetailHost[data-status="evolvable"] .btn-evolve-cta:not(:disabled):hover {
            box-shadow: 0 22px 54px rgba(16,185,129,0.26);
        }

        @keyframes ctaGlow {
            0%, 100% { filter: saturate(1); transform: translateY(0); }
            50% { filter: saturate(1.08); transform: translateY(-1px); }
        }

        .tag-evolvable {
            padding: 7px 14px;
            font-size: 15px;
            font-weight: 900;
            box-shadow: 0 10px 24px rgba(16, 185, 129, 0.18);
        }

        .segmented {
            display: inline-flex;
            border: 1px solid var(--eva-border);
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }

        .segmented button {
            border: none;
            background: transparent;
            padding: 8px 10px;
            font-size: 12px;
            font-weight: 800;
            color: var(--eva-text-secondary);
            cursor: pointer;
            transition: all var(--eva-transition-fast);
        }

        .segmented button:hover { background: var(--eva-border-light); color: var(--eva-text-primary); }
        .segmented button.active { background: var(--eva-primary-bg); color: var(--eva-primary); }

        .select {
            border: 1px solid var(--eva-border);
            background: white;
            border-radius: 12px;
            padding: 8px 10px;
            font-size: 12px;
            font-weight: 700;
            color: var(--eva-text-primary);
        }

        .helper {
            font-size: 12px;
            color: var(--eva-text-tertiary);
            display: inline-flex;
            align-items: center;
            gap: 6px;
            user-select: none;
        }

        /* ========== Agent进化：能力手风琴 ========== */
        .abilities-list { display: flex; flex-direction: column; gap: 12px; }

        .ability-card {
            --ability-color: var(--eva-primary);
            --ability-color-light: var(--ability-color);
            --ability-color-bg: rgba(99, 102, 241, 0.08);
            --ability-color-border: rgba(99, 102, 241, 0.22);
            --ability-color-glow: rgba(99, 102, 241, 0.22);
            background: white;
            border: 1px solid var(--eva-border);
            border-radius: 16px;
            overflow: hidden;
            transition: box-shadow var(--eva-transition-fast), transform var(--eva-transition-fast), border-color var(--eva-transition-fast);
        }

        .ability-card:hover { box-shadow: var(--eva-shadow-md); transform: translateY(-1px); }
        .ability-card.is-open {
            border-color: var(--ability-color-border);
            box-shadow: 0 0 0 3px var(--ability-color-bg), var(--eva-shadow-lg);
        }

        .ability-header {
            width: 100%;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 16px 16px 14px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 14px;
            text-align: left;
        }

        .ability-title {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 0;
        }

        .ability-icon {
            width: 40px;
            height: 40px;
            border-radius: 14px;
            background: var(--ability-color-bg);
            border: 1px solid var(--ability-color-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .ability-name-wrap { min-width: 0; }
        .ability-name {
            font-size: 15px;
            font-weight: 900;
            letter-spacing: -0.01em;
            color: var(--eva-text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 0;
        }

        .ability-desc {
            font-size: 12px;
            color: var(--eva-text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 2px;
        }

        .ability-meta {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .version-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid var(--ability-color-border);
            background: var(--ability-color-bg);
            color: var(--ability-color);
            font-weight: 900;
            font-size: 12px;
            letter-spacing: -0.01em;
            overflow: hidden;
        }

        .version-roller {
            position: relative;
            height: 14px;
            line-height: 14px;
            overflow: hidden;
        }

        .version-roller span {
            display: block;
            height: 14px;
            line-height: 14px;
            transform: translateY(0);
        }

        .version-roller.rolling span {
            animation: versionRoll 650ms cubic-bezier(.2,.9,.2,1) both;
        }

        @keyframes versionRoll {
            0% { transform: translateY(0); }
            100% { transform: translateY(-14px); }
        }

        .chev {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--eva-border);
            color: var(--eva-text-secondary);
            background: white;
            transition: all var(--eva-transition-fast);
        }

        .ability-card.is-open .chev { transform: rotate(180deg); background: var(--eva-border-light); }

        .ability-progress-row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 12px;
            align-items: center;
            padding: 0 16px 16px;
        }

        .progress-track {
            height: 14px;
            border-radius: 999px;
            background: var(--eva-border-light);
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            width: 0%;
            border-radius: 999px;
            background: linear-gradient(90deg, var(--ability-color), var(--ability-color-light));
            transition: width 800ms ease-out;
            position: relative;
        }

        .wheel-item.is-active .progress-track,
        #abilityDetailHost .progress-track {
            box-shadow: 0 0 0 3px var(--ability-color-bg);
        }

        .wheel-item[data-status="evolvable"] .progress-track,
        #abilityDetailHost[data-status="evolvable"] .progress-track {
            box-shadow: 0 0 0 4px var(--eva-success-bg), 0 12px 30px rgba(16,185,129,0.20);
        }

        .wheel-item[data-status="evolvable"] .progress-fill,
        #abilityDetailHost[data-status="evolvable"] .progress-fill {
            background: linear-gradient(90deg, var(--eva-success), #34d399);
        }

        .wheel-item[data-status="evolvable"] .progress-meta .pct,
        #abilityDetailHost[data-status="evolvable"] .progress-meta .pct {
            font-size: 22px;
            color: var(--eva-success);
            text-shadow: 0 8px 18px rgba(16,185,129,0.20);
        }

	        .progress-fill::after {
	            content: '';
	            position: absolute;
	            inset: 0;
	            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
	            transform: translateX(-100%);
	            animation: shimmer 2s infinite;
	        }

	        /* Workbench progress should be stable (no shimmer) */
	        .tuning-wb .progress-fill::after { display: none; }

	        @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

        .progress-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--eva-text-secondary);
            font-weight: 700;
            user-select: none;
        }

        .progress-meta .pct { color: var(--eva-text-primary); font-weight: 900; }

        .ability-detail {
            border-top: 1px dashed rgba(229, 231, 235, 1);
            padding: 14px 16px 16px;
            display: none;
            background: linear-gradient(180deg, rgba(250,250,250,0.75), rgba(255,255,255,1));
        }

        .ability-card.is-open .ability-detail { display: block; animation: slideUp var(--eva-transition-normal); }

        .detail-grid {
            display: grid;
            grid-template-columns: 1.25fr 0.75fr;
            gap: 12px;
        }

        .detail-section {
            background: white;
            border: 1px solid var(--eva-border);
            border-radius: 14px;
            padding: 12px;
        }

        .detail-section h4 {
            font-size: 12px;
            font-weight: 900;
            color: var(--eva-text-primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .queue-list { display: flex; flex-direction: column; gap: 8px; }

        /* 一级页面队列空状态引导 */
        .queue-empty-guide { text-align: center; padding: 24px 16px; border: 1px dashed var(--eva-border); border-radius: 12px; background: var(--eva-bg); }
        .queue-empty-icon { font-size: 32px; margin-bottom: 10px; opacity: 0.7; }
        .queue-empty-title { font-size: 13px; font-weight: 700; color: var(--eva-text-primary); margin-bottom: 4px; }
        .queue-empty-desc { font-size: 12px; color: var(--eva-text-secondary); margin-bottom: 14px; line-height: 1.5; }
        .queue-empty-btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; font-size: 12px; font-weight: 600; color: white; background: var(--eva-primary); border: none; border-radius: 8px; cursor: pointer; transition: all var(--eva-transition-fast); }
        .queue-empty-btn:hover { background: var(--eva-primary-dark); transform: translateY(-1px); box-shadow: var(--eva-shadow-sm); }

        /* 一级页面：可升级成功引导 */
        .queue-success-guide { text-align: center; padding: 24px 16px; border: 1px solid var(--eva-success); border-radius: 12px; background: var(--eva-success-bg); }
        .queue-success-icon { font-size: 32px; margin-bottom: 10px; }
        .queue-success-title { font-size: 13px; font-weight: 700; color: var(--eva-success); margin-bottom: 4px; }
        .queue-success-desc { font-size: 12px; color: var(--eva-text-secondary); line-height: 1.5; }

        /* 一级页面：知识缺口横幅 */
        .detail-gap-bar { display: flex; align-items: center; gap: 10px; padding: 10px 12px; margin-bottom: 12px; background: var(--eva-warning-bg); border: 1px solid var(--eva-warning); border-radius: 10px; flex-wrap: wrap; }
        .detail-gap-bar-icon { font-size: 16px; flex-shrink: 0; }
        .detail-gap-bar-text { flex: 1; font-size: 12px; color: var(--eva-text-primary); line-height: 1.5; min-width: 200px; }
        .detail-gap-bar-actions { display: flex; gap: 8px; flex-shrink: 0; }

	        .queue-item {
	            text-align: left;
	            cursor: pointer;
	            padding: 10px 10px;
	            border-radius: 12px;
	            border: 1px solid var(--eva-border);
	            background: white;
	            display: grid;
	            grid-template-columns: 1fr auto;
	            align-items: center;
	            gap: 10px;
	            transition: transform var(--eva-transition-fast), box-shadow var(--eva-transition-fast), border-color var(--eva-transition-fast);
	        }

	        .queue-item:hover { box-shadow: var(--eva-shadow-sm); transform: translateY(-1px); }
	        .queue-item > div:first-child { min-width: 0; }

        .queue-q { font-size: 12px; font-weight: 800; color: var(--eva-text-primary); display: flex; align-items: center; gap: 6px; min-width: 0; white-space: nowrap; }
        .queue-q-title { flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; }
        .queue-meta { font-size: 12px; color: var(--eva-text-secondary); margin-top: 2px; }

        .queue-actions { display: inline-flex; gap: 8px; align-items: center; }
        .queue-actions .btn { padding: 8px 10px; font-size: 12px; border-radius: 10px; }

        .detail-side {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .stat {
            border: 1px solid var(--eva-border);
            border-radius: 12px;
            padding: 10px;
            background: white;
        }
        .stat .k { font-size: 12px; color: var(--eva-text-secondary); font-weight: 700; }
        .stat .v { font-size: 14px; font-weight: 900; margin-top: 4px; }

        .actions { display: flex; gap: 10px; align-items: center; justify-content: flex-end; }

        .actions .btn { border-radius: 12px; padding: 10px 12px; font-size: 13px; font-weight: 800; }

        .inline-note {
            font-size: 12px;
            color: var(--eva-text-tertiary);
            line-height: 1.6;
        }

        .timeline { display: flex; flex-direction: column; gap: 8px; }
        .timeline-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px;
            border-radius: 12px;
            border: 1px solid var(--eva-border);
            background: white;
        }
        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--ability-color);
            margin-top: 3px;
            flex-shrink: 0;
            box-shadow: 0 0 0 4px var(--ability-color-bg);
        }
        .timeline-item .t { font-size: 12px; font-weight: 900; }
        .timeline-item .d { font-size: 12px; color: var(--eva-text-secondary); margin-top: 2px; line-height: 1.5; }

	        /* ========== 进化动效（卡片发光 + 粒子光效 + 进度归零） ========== */
	        .ability-card.is-evolving,
	        .wheel-item.is-evolving,
	        .ability-tile.is-evolving {
	            transform: translateY(-1px);
	            box-shadow: 0 0 0 1px var(--ability-color-border), 0 18px 50px rgba(0,0,0,0.12);
	            border-color: var(--ability-color-border);
	            position: relative;
	        }

	        .ability-card.is-evolving::before,
	        .wheel-item.is-evolving::before,
	        .ability-tile.is-evolving::before {
	            content: '';
	            position: absolute;
	            inset: -2px;
	            border-radius: 18px;
	            background: radial-gradient(circle at 20% 20%, var(--ability-color-glow), transparent 55%),
	                        radial-gradient(circle at 80% 30%, var(--ability-color-bg), transparent 60%),
	                        radial-gradient(circle at 60% 80%, var(--ability-color-bg), transparent 60%);
	            filter: blur(10px);
	            opacity: 0.9;
	            pointer-events: none;
	            animation: evolveGlow 2.2s ease-in-out infinite;
	        }

        @keyframes evolveGlow {
            0%, 100% { opacity: 0.55; transform: scale(0.98); }
            50% { opacity: 1; transform: scale(1.02); }
        }

        .ability-card.is-evolving .chev { animation: spin 1.2s linear infinite; }

        .sparkles {
            position: absolute;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
            border-radius: 16px;
        }

        .sparkle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: var(--ability-color-light);
            box-shadow: 0 0 0 2px var(--ability-color-bg);
            opacity: 0;
            transform: translateY(6px) scale(0.6);
            animation: sparkle 900ms ease-in-out forwards;
        }

        @keyframes sparkle {
            0% { opacity: 0; transform: translateY(6px) scale(0.6); }
            35% { opacity: 0.95; }
            100% { opacity: 0; transform: translateY(-26px) scale(1.2); }
        }

        /* ========== Modal / Toast ========== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(17, 24, 39, 0.55);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 12000;
            padding: 24px;
        }

        .modal-overlay.active { display: flex; animation: fadeIn var(--eva-transition-normal); }

        .modal {
            width: 100%;
            max-width: 760px;
            background: var(--eva-surface);
            border-radius: 20px;
            border: 1px solid var(--eva-border);
            box-shadow: var(--eva-shadow-xl);
            overflow: hidden;
            transform: translateY(6px);
            animation: slideUp var(--eva-transition-normal);
        }

        .modal.small { max-width: 520px; }
        .modal.large { max-width: 1120px; }
        .modal.workbench { height: min(82vh, 880px); display: flex; flex-direction: column; }
        .modal.workbench .modal-body { padding: 0; flex: 1; display: block; }
        .modal.workbench .modal-footer { justify-content: space-between; }

        .wb {
            height: 100%;
            display: grid;
            grid-template-columns: 360px 1fr;
            min-height: 520px;
        }

        .wb-side {
            border-right: 1px solid var(--eva-border);
            background: linear-gradient(180deg, rgba(99, 102, 241, 0.06), rgba(255,255,255,1) 55%);
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .wb-side-head {
            padding: 14px 14px 12px;
            border-bottom: 1px solid var(--eva-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .wb-side-title { font-size: 13px; font-weight: 900; color: var(--eva-text-primary); }
        .wb-side-meta { font-size: 12px; color: var(--eva-text-secondary); }

        /* 演示用清空按钮 */
        .demo-clear-btn { display: inline-flex; align-items: center; gap: 2px; margin-top: 4px; padding: 2px 6px; font-size: 10px; color: var(--eva-text-tertiary); background: var(--eva-border-light); border: 1px dashed var(--eva-border); border-radius: 4px; cursor: pointer; transition: all var(--eva-transition-fast); }
        .demo-clear-btn:hover { color: var(--eva-error); border-color: var(--eva-error); background: var(--eva-error-bg); }

        .wb-list {
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow: auto;
        }

        .wb-item {
            text-align: left;
            border: 1px solid var(--eva-border);
            background: white;
            border-radius: 14px;
            padding: 10px 10px;
            cursor: pointer;
            transition: all var(--eva-transition-fast);
        }

        .wb-item:hover { box-shadow: var(--eva-shadow-sm); transform: translateY(-1px); }
        .wb-item.active { border-color: var(--ability-color-border); box-shadow: 0 0 0 3px var(--ability-color-bg); }

        .wb-item .t {
            font-size: 12px;
            font-weight: 900;
            color: var(--eva-text-primary);
            line-height: 1.5;
        }

        .wb-item .m {
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--eva-text-secondary);
            flex-wrap: wrap;
        }

        .wb-item-comment {
            margin-top: 6px;
            font-size: 11px;
            color: var(--eva-text-tertiary);
            line-height: 1.4;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .wb-main {
            padding: 12px 14px 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 0;
            position: relative;
        }

        .wb-top {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 10px;
            padding-bottom: 12px;
            margin-bottom: 4px;
            border-bottom: 1px solid var(--eva-border);
        }

        .wb-top-left { min-width: 0; }
        .wb-title { font-size: 14px; font-weight: 900; color: var(--eva-text-primary); display: flex; align-items: center; gap: 8px; }
        .wb-sub { font-size: 12px; color: var(--eva-text-secondary); margin-top: 2px; }

        .wb-top-right { display: flex; flex-direction: column; align-items: flex-end; gap: 10px; flex-shrink: 0; }

        .wb-progress { margin-top: 2px; }

        .wb-question {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            min-height: 0;
            overflow: auto;
            padding-bottom: 6px;
            align-content: start;
        }

	        .wb-actions-left { display: inline-flex; gap: 8px; align-items: center; }
	        .wb-actions-right { display: inline-flex; gap: 8px; align-items: center; flex-wrap: wrap; justify-content: flex-end; }

	        .tune-choice {
	            display: grid;
	            grid-template-columns: 1fr 1fr;
	            gap: 8px;
	        }

	        .choice-card {
	            border: 1px solid var(--eva-border);
	            background: white;
	            border-radius: 12px;
	            padding: 10px;
	            text-align: left;
	            cursor: pointer;
	            box-shadow: var(--eva-shadow-sm);
	            transition: all var(--eva-transition-fast);
	        }

	        .choice-card:hover { transform: translateY(-1px); box-shadow: var(--eva-shadow-md); border-color: var(--ability-color-border); }
	        .choice-card .h { font-weight: 900; color: var(--eva-text-primary); font-size: 13px; }
	        .choice-card .d { font-size: 12px; color: var(--eva-text-secondary); margin-top: 4px; }

	        .tune-rate { display: grid; gap: 8px; }
	        .tune-row { display: flex; align-items: center; justify-content: space-between; gap: 8px; flex-wrap: wrap; }
	        .tune-row .k { font-size: 12px; font-weight: 900; color: var(--eva-text-secondary); }

	        .rating { display: inline-flex; gap: 6px; }
	        .star {
	            width: 34px;
	            height: 34px;
	            border-radius: 12px;
	            border: 1px solid var(--eva-border);
	            background: white;
	            cursor: pointer;
	            color: var(--eva-text-tertiary);
	            font-size: 16px;
	            display: inline-flex;
	            align-items: center;
	            justify-content: center;
	            transition: all var(--eva-transition-fast);
	        }
	        .star.on { color: var(--eva-warning); border-color: rgba(245,158,11,0.28); background: var(--eva-warning-bg); }
	        .star:hover { transform: translateY(-1px); box-shadow: var(--eva-shadow-sm); }

	        .tag-pills { display: flex; gap: 8px; flex-wrap: wrap; }
	        .pill-btn {
	            border: 1px solid var(--eva-border);
	            background: white;
	            border-radius: 999px;
	            padding: 7px 10px;
	            font-size: 12px;
	            font-weight: 800;
	            color: var(--eva-text-secondary);
	            cursor: pointer;
	            transition: all var(--eva-transition-fast);
	        }
	        .pill-btn:hover { box-shadow: var(--eva-shadow-sm); transform: translateY(-1px); }
	        .pill-btn.active { border-color: rgba(99,102,241,0.22); background: var(--eva-primary-bg); color: var(--eva-primary); }

	        .tune-actions { display: flex; justify-content: flex-end; gap: 10px; }

	        .tune-bottom-bar {
	            display: flex;
	            align-items: center;
	            justify-content: space-between;
	            gap: 10px;
	            padding: 10px 0 0;
	            border-top: 1px solid var(--eva-border);
	        }
	        .tune-bottom-bar .left, .tune-bottom-bar .right { display: inline-flex; gap: 10px; align-items: center; flex-wrap: wrap; }

	        .wb-overlay {
	            position: absolute;
	            inset: 0;
	            background: rgba(17, 24, 39, 0.45);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 18px;
            z-index: 5;
        }

        .wb-overlay.active { display: flex; }

        .wb-overlay-card {
            width: 100%;
            max-width: 520px;
            background: white;
            border-radius: 18px;
            border: 1px solid var(--eva-border);
            box-shadow: var(--eva-shadow-xl);
            overflow: hidden;
        }

        .wb-overlay-card .h {
            padding: 14px 14px;
            border-bottom: 1px solid var(--eva-border);
            font-weight: 900;
        }

        .wb-overlay-card .b { padding: 14px; display: grid; gap: 10px; }
        .wb-overlay-card .f { padding: 12px 14px; border-top: 1px solid var(--eva-border); display: flex; justify-content: flex-end; gap: 10px; }

	        @media (max-width: 980px) {
	            .modal.large { max-width: 92vw; }
	            .wb { grid-template-columns: 1fr; }
	            .wb-side { border-right: none; border-bottom: 1px solid var(--eva-border); }
	            .tuning-wb .wb-side { border-right: none; border-bottom: none; border-top: 1px solid var(--eva-border); }
	        }

        .modal-header {
            padding: 16px;
            border-bottom: 1px solid var(--eva-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .modal-title { font-size: 14px; font-weight: 900; color: var(--eva-text-primary); }

        .modal-close {
            width: 34px;
            height: 34px;
            border: none;
            background: var(--eva-border-light);
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            color: var(--eva-text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover { background: var(--eva-border); }

        .modal-body { padding: 16px; display: grid; grid-template-columns: 1fr; gap: 12px; }
        .modal-footer { padding: 14px 16px; border-top: 1px solid var(--eva-border); display: flex; justify-content: flex-end; gap: 10px; }

        .callout {
            border: 1px solid var(--eva-border);
            border-radius: 12px;
            padding: 12px;
            background: white;
        }

        .callout-title { font-size: 12px; font-weight: 900; }
        .callout-desc { font-size: 12px; color: var(--eva-text-secondary); margin-top: 4px; line-height: 1.6; min-height: 1.6em; }

        .gap-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 8px;
            background: rgba(239, 68, 68, 0.08);
            border: 1px solid rgba(239, 68, 68, 0.2);
            font-size: 12px;
        }
        .gap-bar-icon { color: var(--eva-error); font-size: 14px; }
        .gap-bar-text { flex: 1; color: var(--eva-text-secondary); }
        .gap-bar-actions { display: flex; gap: 6px; flex-shrink: 0; }

        /* 知识缺口阻断横幅（遮挡选项） */
        .gap-blocking-bar {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            padding: 20px 16px;
            margin-top: 12px;
            background: rgba(239, 68, 68, 0.06);
            border: 1px solid rgba(239, 68, 68, 0.25);
            border-radius: 12px;
            text-align: center;
        }
        .gap-blocking-icon { font-size: 28px; }
        .gap-blocking-title { font-size: 14px; font-weight: 700; color: var(--eva-error); margin-bottom: 4px; }
        .gap-blocking-desc { font-size: 12px; color: var(--eva-text-secondary); line-height: 1.5; }
        .gap-blocking-actions { display: flex; gap: 8px; margin-top: 4px; }

        /* 题目模块 meta 信息排版 */
        .meta-row { display: flex; align-items: flex-start; gap: 10px; margin-top: 8px; font-size: 12px; line-height: 1.5; }
        .meta-label { color: var(--eva-text-tertiary); min-width: 56px; flex-shrink: 0; }
        .meta-value { color: var(--eva-text-primary); }
        .meta-comment { color: var(--eva-text-secondary); background: var(--eva-bg); padding: 6px 10px; border-radius: 6px; margin-top: 4px; font-size: 12px; line-height: 1.5; display: block; }

        .btn-xs { padding: 4px 8px; font-size: 11px; border-radius: 6px; }

        /* 进化中按钮状态 */
        .spinner-small { display: inline-block; width: 12px; height: 12px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; vertical-align: middle; margin-right: 4px; }
        .btn.is-loading { pointer-events: none; opacity: 0.85; }
        /* 升级发布按钮使用绿色（成功状态） */
        .btn-evolve-cta { background: var(--eva-success) !important; }
        .btn-evolve-cta:hover { background: #059669 !important; }

        .feedback-guide {
            display: flex;
            gap: 16px;
            padding: 10px 12px;
            background: var(--eva-border-light);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .guide-item { display: flex; align-items: center; gap: 6px; }
        .guide-icon { font-size: 14px; }
        .guide-text { font-size: 12px; color: var(--eva-text-secondary); }

        .feedback-preview {
            font-size: 12px;
            color: var(--eva-text-secondary);
            padding: 8px 10px;
            background: var(--eva-border-light);
            border-radius: 6px;
            line-height: 1.5;
        }

        .feedback-history {
            margin-top: 8px;
            padding: 8px 10px;
            background: rgba(99, 102, 241, 0.05);
            border-radius: 6px;
            border: 1px dashed var(--eva-border);
        }
        .history-label { font-size: 11px; color: var(--eva-text-tertiary); margin-bottom: 4px; }
        .history-item { font-size: 12px; color: var(--eva-text-secondary); line-height: 1.5; }

        .qa-box {
            border: 1px solid var(--eva-border);
            border-radius: 12px;
            background: white;
            overflow: hidden;
        }
        .qa-head {
            padding: 8px 10px;
            border-bottom: 1px solid var(--eva-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }
        .qa-head .label { font-size: 12px; font-weight: 900; }
        .qa-body { padding: 12px; display: grid; gap: 8px; }
        .bubble {
            border: 1px solid var(--eva-border);
            border-radius: 10px;
            padding: 12px 14px;
            background: white;
            font-size: 13px;
            color: var(--eva-text-primary);
            line-height: 1.7;
            min-height: 120px;
        }
        .options { display: grid; gap: 6px; }
        .opt {
            display: grid;
            grid-template-columns: 18px 1fr;
            gap: 8px;
            padding: 8px 10px;
            border: 1px solid var(--eva-border);
            border-radius: 10px;
            cursor: pointer;
            background: white;
        }
        .opt:hover { background: var(--eva-border-light); }
        .opt input { margin-top: 2px; }
        .opt .t { font-size: 12px; font-weight: 800; color: var(--eva-text-primary); }
        .opt .d { font-size: 12px; color: var(--eva-text-secondary); margin-top: 1px; line-height: 1.5; }
        .opt .cand-wrap { position: relative; }
        .opt .cand-content { font-size: 12px; color: var(--eva-text-secondary); line-height: 1.5; }
        .opt .cand-content.collapsed { max-height: 3.6em; overflow: hidden; }
        .opt .expand-btn { display: inline-block; font-size: 11px; color: var(--eva-primary); cursor: pointer; margin-top: 6px; padding: 2px 6px; background: var(--eva-border-light); border-radius: 4px; user-select: none; }
        .opt .expand-btn:hover { background: var(--eva-primary-bg); }

        /* ========== 题库补充 Modal ========== */
        .qbank-modal { max-width: 680px; }
        .qbank-modal .modal-body { padding: 0; display: flex; flex-direction: column; max-height: 65vh; }
        .qbank-modal .modal-footer { justify-content: space-between; }
        .qbank-tabs { display: flex; gap: 0; border-bottom: 1px solid var(--eva-border); background: var(--eva-bg); }
        .qbank-tab { flex: 1; padding: 12px 16px; font-size: 13px; font-weight: 600; color: var(--eva-text-secondary); background: none; border: none; cursor: pointer; position: relative; transition: all var(--eva-transition-fast); }
        .qbank-tab:hover { color: var(--eva-text-primary); background: var(--eva-border-light); }
        .qbank-tab.active { color: var(--eva-primary); background: white; }
        .qbank-tab.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 2px; background: var(--eva-primary); }
        .qbank-tab .tab-count { font-size: 11px; color: var(--eva-text-tertiary); margin-left: 4px; }
        .qbank-tab.active .tab-count { color: var(--eva-primary); }

        .qbank-filters { display: flex; gap: 10px; padding: 12px 16px; border-bottom: 1px solid var(--eva-border); background: white; flex-wrap: wrap; }
        .qbank-filter-select { padding: 6px 10px; font-size: 12px; border: 1px solid var(--eva-border); border-radius: 8px; background: white; color: var(--eva-text-primary); cursor: pointer; min-width: 100px; }
        .qbank-filter-select:focus { outline: none; border-color: var(--eva-primary); }
        .qbank-search { flex: 1; min-width: 160px; padding: 6px 10px; font-size: 12px; border: 1px solid var(--eva-border); border-radius: 8px; background: white; }
        .qbank-search:focus { outline: none; border-color: var(--eva-primary); }
        .qbank-search::placeholder { color: var(--eva-text-tertiary); }

        .qbank-list-wrap { flex: 1; overflow-y: auto; padding: 8px 12px; }
        .qbank-select-all { display: flex; align-items: center; gap: 8px; padding: 10px 12px; margin-bottom: 6px; background: var(--eva-bg); border-radius: 10px; font-size: 12px; font-weight: 600; color: var(--eva-text-secondary); cursor: pointer; user-select: none; }
        .qbank-select-all:hover { background: var(--eva-border-light); }
        .qbank-select-all input { margin: 0; cursor: pointer; }

        .qbank-item { display: flex; align-items: flex-start; gap: 10px; padding: 12px; border: 1px solid var(--eva-border); border-radius: 10px; margin-bottom: 8px; cursor: pointer; transition: all var(--eva-transition-fast); background: white; }
        .qbank-item:hover { border-color: var(--eva-primary-light); background: var(--eva-primary-bg); }
        .qbank-item.selected { border-color: var(--eva-primary); background: var(--eva-primary-bg); }
        .qbank-item.disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; }
        .qbank-item input { margin: 0; margin-top: 2px; cursor: pointer; flex-shrink: 0; }
        .qbank-item-content { flex: 1; min-width: 0; }
        .qbank-item-title { font-size: 13px; font-weight: 600; color: var(--eva-text-primary); line-height: 1.5; }
        .qbank-item-meta { display: flex; align-items: center; gap: 8px; margin-top: 6px; flex-wrap: wrap; }
        .qbank-item-tag { font-size: 11px; padding: 2px 6px; border-radius: 4px; }
        .qbank-item-tag.suggest { background: var(--eva-error-bg); color: var(--eva-error); }
        .qbank-item-tag.in-queue { background: var(--eva-border-light); color: var(--eva-text-tertiary); }
        .qbank-item-status { font-size: 14px; line-height: 1; }

        .qbank-empty { text-align: center; padding: 40px 20px; color: var(--eva-text-tertiary); }
        .qbank-empty-icon { font-size: 32px; margin-bottom: 8px; }
        .qbank-empty-text { font-size: 13px; }
        .qbank-count { font-size: 12px; color: var(--eva-text-tertiary); flex-shrink: 0; }
        .qbank-pagination { display: flex; align-items: center; justify-content: center; gap: 12px; padding: 12px 0; margin-top: 8px; border-top: 1px solid var(--eva-border); }
        .qbank-page-info { font-size: 12px; color: var(--eva-text-secondary); }

        .qbank-footer { display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; border-top: 1px solid var(--eva-border); background: white; }
        .qbank-footer-info { font-size: 12px; color: var(--eva-text-secondary); }
        .qbank-footer-info strong { color: var(--eva-primary); font-weight: 700; }
        .qbank-footer-actions { display: flex; gap: 10px; }

        /* 左侧列表底部补充按钮 */
        .wb-add-from-qbank { display: flex; align-items: center; justify-content: center; gap: 6px; margin: 8px; padding: 10px 12px; font-size: 12px; font-weight: 600; color: var(--eva-primary); background: var(--eva-primary-bg); border: 1px dashed var(--eva-primary-light); border-radius: 10px; cursor: pointer; transition: all var(--eva-transition-fast); }
        .wb-add-from-qbank:hover { background: white; border-style: solid; }
        .wb-add-from-qbank .icon { font-size: 14px; }

        /* 空状态引导 */
        .wb-empty-guide { text-align: center; padding: 30px 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; min-height: 200px; }
        .wb-empty-guide-icon { font-size: 40px; margin-bottom: 12px; opacity: 0.6; }
        .wb-empty-guide-title { font-size: 14px; font-weight: 700; color: var(--eva-text-primary); margin-bottom: 6px; }
        .wb-empty-guide-desc { font-size: 12px; color: var(--eva-text-secondary); margin-bottom: 16px; line-height: 1.5; }
        .wb-empty-guide-btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 20px; font-size: 13px; font-weight: 600; color: white; background: var(--eva-primary); border: none; border-radius: 10px; cursor: pointer; transition: all var(--eva-transition-fast); }
        .wb-empty-guide-btn:hover { background: var(--eva-primary-dark); transform: translateY(-1px); box-shadow: var(--eva-shadow-sm); }

        /* 来源标签 */
        .source-tag { font-size: 10px; padding: 1px 5px; border-radius: 3px; font-weight: 500; margin-right: 6px; vertical-align: middle; }
        .source-tag.from-qbank { background: var(--eva-primary-bg); color: var(--eva-primary); }
        .source-tag.from-downvote { background: var(--eva-error-bg); color: var(--eva-error); }

        .toast-container {
            position: fixed;
            right: 18px;
            bottom: 18px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 13000;
        }

        .toast {
            background: white;
            border: 1px solid var(--eva-border);
            box-shadow: var(--eva-shadow-lg);
            border-radius: 14px;
            padding: 12px 12px;
            min-width: 280px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            animation: slideUp 220ms ease;
        }

        .toast .icon {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            flex-shrink: 0;
        }

        .toast.success .icon { background: var(--eva-success-bg); color: var(--eva-success); }
        .toast.warning .icon { background: var(--eva-warning-bg); color: var(--eva-warning); }
        .toast.error .icon { background: var(--eva-error-bg); color: var(--eva-error); }
        .toast.info .icon { background: var(--eva-info-bg); color: var(--eva-info); }

        /* 居中大Toast（升级成功） */
        .toast-center-overlay {
            position: fixed;
            inset: 0;
            background: rgba(17, 24, 39, 0.35);
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 80px;
            z-index: 14000;
            animation: fadeIn var(--eva-transition-normal);
        }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .toast-center {
            background: linear-gradient(135deg, #ecfdf5 0%, #ffffff 100%);
            border: 2px solid var(--eva-success);
            box-shadow: 0 20px 50px rgba(16, 185, 129, 0.25), 0 8px 20px rgba(0, 0, 0, 0.08);
            border-radius: 20px;
            padding: 28px 36px;
            min-width: 300px;
            max-width: 400px;
            text-align: center;
            animation: slideDown 0.35s ease-out;
        }
        .toast-center .tc-icon { font-size: 56px; margin-bottom: 12px; filter: drop-shadow(0 4px 8px rgba(16, 185, 129, 0.3)); }
        .toast-center .tc-title { font-size: 20px; font-weight: 900; color: var(--eva-success); margin-bottom: 10px; letter-spacing: -0.01em; }
        .toast-center .tc-desc { font-size: 14px; color: var(--eva-text-secondary); line-height: 1.7; }

        .toast .content { flex: 1; }
        .toast .title { font-size: 12px; font-weight: 900; }
        .toast .msg { font-size: 12px; color: var(--eva-text-secondary); margin-top: 2px; line-height: 1.5; }
        .toast .close { color: var(--eva-text-tertiary); cursor: pointer; font-size: 18px; padding: 0 4px; }

        /* ========== 响应式 ========== */
        @media (max-width: 980px) {
            .sidebar { display: none; }
            body { display: block; }
            .topbar { padding: 0 16px; }
            .content { padding: 16px; }
            .detail-grid { grid-template-columns: 1fr; }
        }

        /* ========== @FROZEN: 画板模式核心架构 ========== */
        .mode-switcher {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: none;
            gap: 8px;
            background: white;
            padding: 8px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            border: 1px solid #e5e7eb;
        }

        body.proto-tools .mode-switcher { display: flex; }

        .mode-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s ease;
            background: #f3f4f6;
            color: #6b7280;
        }

        .mode-btn:hover { background: #e5e7eb; color: #374151; }
        .mode-btn.active { background: var(--eva-primary); color: white; }

        .mode-btn-export {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .mode-btn-export:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .artboard-container {
            display: none;
            padding: 40px;
            background: #f8fafc;
            min-height: 100vh;
            width: 100%;
        }

        .artboard-container.active { display: block; }

        body.artboard-mode { display: block; }
        body.artboard-mode .sidebar,
        body.artboard-mode .main { display: none; }

        .artboard-header {
            text-align: center;
            margin-bottom: 48px;
            padding: 32px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .artboard-header h1 { font-size: 28px; font-weight: 800; color: #1f2937; margin-bottom: 8px; }
        .artboard-header p { color: #6b7280; font-size: 15px; }

        .artboard-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 32px;
            justify-content: flex-start;
            max-width: 1800px;
            margin: 0 auto;
        }

        .artboard-section-title {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 0;
            margin-top: 24px;
            border-bottom: 2px solid var(--eva-primary);
        }

        .artboard-section-title:first-child { margin-top: 0; }
        .artboard-section-title span { font-size: 24px; }
        .artboard-section-title::after { content: attr(data-title); font-size: 18px; font-weight: 700; color: #374151; }

        .artboard {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .artboard:hover { transform: translateY(-4px); box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12); }

        .artboard-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-bottom: 1px solid #e5e7eb;
            font-size: 13px;
            font-weight: 700;
            color: #374151;
        }

        .artboard-label-id {
            background: var(--eva-primary);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 800;
        }

        .artboard-label-right { display: flex; align-items: center; gap: 8px; }

        .artboard-download-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: var(--eva-surface);
            border: 1px solid var(--eva-border);
            border-radius: 6px;
            cursor: pointer;
            transition: all var(--eva-transition-fast);
            font-size: 14px;
        }

        .artboard-download-btn:hover {
            background: var(--eva-primary);
            border-color: var(--eva-primary);
            color: white;
            transform: scale(1.05);
        }

        .artboard-download-btn.loading { pointer-events: none; opacity: 0.6; }

        .artboard-content { background: #f8fafc; position: relative; overflow: hidden; }
        .artboard-content.tall { max-height: 560px; overflow: auto; }
        .artboard-page-preview { padding: 16px; }
        /* ========== @END-FROZEN: 画板模式核心架构 ========== */
    </style>
</head>

<body>
    <!-- html2canvas库用于截图下载 -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <!-- ========== 模式切换器 ========== -->
    <div class="mode-switcher">
        <button class="mode-btn active" onclick="switchMode('interactive')">
            <span style="margin-right: 4px">&#128421;</span> 交互模式
        </button>
        <button class="mode-btn" onclick="switchMode('artboard')">
            <span style="margin-right: 4px">&#128203;</span> 画板模式
        </button>
        <button class="mode-btn mode-btn-export" onclick="printArtboards()">
            <span style="margin-right: 4px">&#128424;</span> 打印导出
        </button>
    </div>

    <!-- ========== 画板容器（关键状态）========== -->
    <div class="artboard-container" id="artboardContainer">
        <div class="artboard-header">
            <h1>Agent进化 · 原型画板</h1>
            <p>关键页面状态与弹窗 · 手风琴交互 + 进化动效</p>
        </div>

        <div class="artboard-grid">
            <div class="artboard-section-title" data-title="页面状态"><span>&#128196;</span></div>

            <div class="artboard" id="artboard-1">
                <div class="artboard-label">
                    <span>Agent进化 · 默认状态（四能力列表）</span>
                    <span class="artboard-label-id">#1</span>
                </div>
                <div class="artboard-content tall">
                    <div class="artboard-page-preview">
                        <div style="background:white;border:1px solid #e5e7eb;border-radius:16px;padding:16px;margin-bottom:12px;">
                            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
                                <div style="display:flex;align-items:center;gap:10px;">
                                    <div style="width:36px;height:36px;border-radius:14px;background:#ecfdf5;border:1px solid rgba(16,185,129,.2);display:flex;align-items:center;justify-content:center;">&#128172;</div>
                                    <div>
                                        <div style="font-weight:900;">智能客服 <span style="margin-left:8px;font-size:12px;color:#10b981;">v3.0</span></div>
                                    </div>
                                </div>
                                <div style="width:28px;height:28px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;display:flex;align-items:center;justify-content:center;color:#6b7280;">&#9660;</div>
                            </div>
                            <div style="display:flex;align-items:center;gap:12px;">
                                <div style="flex:1;height:10px;border-radius:999px;background:#f3f4f6;overflow:hidden;">
                                    <div style="height:100%;width:68%;background:linear-gradient(90deg,#10b981,#6ee7b7);border-radius:999px;"></div>
                                </div>
                                <div style="font-size:12px;font-weight:800;color:#111827;">68%</div>
                            </div>
                        </div>

                        <div style="background:white;border:1px solid #e5e7eb;border-radius:16px;padding:16px;margin-bottom:12px;">
                            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
                                <div style="display:flex;align-items:center;gap:10px;">
                                    <div style="width:36px;height:36px;border-radius:14px;background:#eff6ff;border:1px solid rgba(59,130,246,.2);display:flex;align-items:center;justify-content:center;">&#9997;</div>
                                    <div>
                                        <div style="font-weight:900;">内容营销 <span style="margin-left:8px;font-size:12px;color:#3b82f6;">v2.0</span></div>
                                    </div>
                                </div>
                                <div style="width:28px;height:28px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;display:flex;align-items:center;justify-content:center;color:#6b7280;">&#9660;</div>
                            </div>
                            <div style="display:flex;align-items:center;gap:12px;">
                                <div style="flex:1;height:10px;border-radius:999px;background:#f3f4f6;overflow:hidden;">
                                    <div style="height:100%;width:32%;background:linear-gradient(90deg,#3b82f6,#93c5fd);border-radius:999px;"></div>
                                </div>
                                <div style="font-size:12px;font-weight:800;color:#111827;">32%</div>
                            </div>
                        </div>

                        <div style="background:white;border:1px solid #e5e7eb;border-radius:16px;padding:16px;">
                            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
                                <div style="display:flex;align-items:center;gap:10px;">
                                    <div style="width:36px;height:36px;border-radius:14px;background:#f5f3ff;border:1px solid rgba(139,92,246,.2);display:flex;align-items:center;justify-content:center;">&#128188;</div>
                                    <div>
                                        <div style="font-weight:900;">销售推广 <span style="margin-left:8px;font-size:12px;color:#8b5cf6;">v2.0</span> <span style="margin-left:8px;font-size:12px;color:#10b981;">可升级</span></div>
                                    </div>
                                </div>
                                <div style="width:28px;height:28px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;display:flex;align-items:center;justify-content:center;color:#6b7280;">&#9660;</div>
                            </div>
                            <div style="display:flex;align-items:center;gap:12px;">
                                <div style="flex:1;height:10px;border-radius:999px;background:#f3f4f6;overflow:hidden;">
                                    <div style="height:100%;width:100%;background:linear-gradient(90deg,#8b5cf6,#c4b5fd);border-radius:999px;"></div>
                                </div>
                                <div style="font-size:12px;font-weight:800;color:#111827;">100%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="artboard" id="artboard-2">
                <div class="artboard-label">
                    <span>Agent进化 · 展开状态（队列+操作）</span>
                    <span class="artboard-label-id">#2</span>
                </div>
                <div class="artboard-content tall">
                    <div class="artboard-page-preview">
                        <div style="background:white;border:1px solid rgba(139,92,246,.25);border-radius:16px;padding:16px;">
                            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
                                <div style="display:flex;align-items:center;gap:10px;">
                                    <div style="width:36px;height:36px;border-radius:14px;background:#f5f3ff;border:1px solid rgba(139,92,246,.2);display:flex;align-items:center;justify-content:center;">&#128188;</div>
                                    <div>
                                        <div style="font-weight:900;">销售推广 <span style="margin-left:8px;font-size:12px;color:#8b5cf6;">v2.0</span></div>
                                        <div style="font-size:12px;color:#6b7280;">已处理 50 / 待处理 0 · 可升级</div>
                                    </div>
                                </div>
                                <div style="width:28px;height:28px;border-radius:10px;border:1px solid #e5e7eb;background:#f3f4f6;display:flex;align-items:center;justify-content:center;color:#6b7280;">&#9650;</div>
                            </div>
                            <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                                <div style="flex:1;height:10px;border-radius:999px;background:#f3f4f6;overflow:hidden;">
                                    <div style="height:100%;width:100%;background:linear-gradient(90deg,#8b5cf6,#c4b5fd);border-radius:999px;"></div>
                                </div>
                                <div style="font-size:12px;font-weight:800;color:#111827;">100%</div>
                            </div>
                            <div style="border-top:1px dashed #e5e7eb;padding-top:12px;display:grid;grid-template-columns:1.2fr .8fr;gap:10px;">
                                <div style="background:white;border:1px solid #e5e7eb;border-radius:14px;padding:10px;">
                                    <div style="font-size:12px;font-weight:900;margin-bottom:8px;">&#128203; 待处理题目</div>
                                    <div style="font-size:12px;color:#6b7280;line-height:1.6;">暂无待处理题目。可从题库补充题目，或等待新的点踩进入队列。</div>
                                </div>
                                <div style="background:white;border:1px solid #e5e7eb;border-radius:14px;padding:10px;">
                                    <div style="font-size:12px;font-weight:900;margin-bottom:8px;">&#10024; 操作</div>
                                    <div style="display:flex;justify-content:flex-end;gap:8px;">
                                        <div style="padding:8px 10px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;font-size:12px;font-weight:800;color:#374151;">补充题目</div>
                                        <div style="padding:8px 10px;border-radius:12px;background:#8b5cf6;font-size:12px;font-weight:900;color:#fff;">升级</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="artboard-section-title" data-title="弹窗"><span>&#128172;</span></div>

            <div class="artboard" id="artboard-3">
                <div class="artboard-label">
                    <span>进化工作台（静态示例题）</span>
                    <span class="artboard-label-id">#3</span>
                </div>
                <div class="artboard-content">
                    <div class="artboard-page-preview">
                        <div style="background:white;border:1px solid #e5e7eb;border-radius:16px;overflow:hidden;">
                            <div style="padding:12px 14px;border-bottom:1px solid #e5e7eb;font-weight:900;">进化：智能客服</div>
                            <div style="padding:14px;display:grid;gap:10px;">
                                <div style="font-size:12px;font-weight:900;">&#128203; 题目</div>
                                <div style="font-size:12px;color:#374151;line-height:1.6;">用户说“我不满意”，你要怎么安抚？</div>
                                <div style="font-size:12px;font-weight:900;">&#129302; Agent 回答</div>
                                <div style="border:1px solid #e5e7eb;border-radius:14px;padding:10px 12px;background:rgba(99,102,241,.05);font-size:12px;color:#6b7280;line-height:1.6;">好的，我帮您查一下订单情况。请问您的订单号是多少？</div>
                                <div style="font-size:12px;font-weight:900;">&#10024; 请选择更好的回答</div>
                                <div style="display:grid;gap:8px;">
                                    <div style="border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff;font-size:12px;"><b>A</b> 非常抱歉给您带来不好的体验，我完全理解您的心情。</div>
                                    <div style="border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff;font-size:12px;"><b>B</b> 理解您的心情，遇到这种情况确实让人着急。</div>
                                </div>
                            </div>
                            <div style="padding:12px 14px;border-top:1px solid #e5e7eb;display:flex;justify-content:flex-end;gap:10px;">
                                <div style="padding:8px 10px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;font-size:12px;font-weight:800;">移除此题</div>
                                <div style="padding:8px 10px;border-radius:10px;background:#6366f1;color:#fff;font-size:12px;font-weight:900;">提交</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="artboard" id="artboard-4">
                <div class="artboard-label">
                    <span>升级动效（静态示意）</span>
                    <span class="artboard-label-id">#4</span>
                </div>
                <div class="artboard-content">
                    <div class="artboard-page-preview">
                        <div style="background:white;border:1px solid #e5e7eb;border-radius:16px;overflow:hidden;">
                            <div style="padding:12px 14px;border-bottom:1px solid #e5e7eb;font-weight:900;">升级中...</div>
                            <div style="padding:14px;display:grid;gap:10px;">
                                <div style="font-size:12px;color:#374151;">正在将「销售推广」升级至 <b>v3.0</b>（约2-3秒）。</div>
                                <div style="border:1px solid #e5e7eb;border-radius:14px;padding:10px;background:rgba(139,92,246,.06);">
                                    <div style="font-size:12px;font-weight:900;margin-bottom:8px;">&#10024; 升级动效</div>
                                    <div style="font-size:12px;color:#6b7280;line-height:1.7;">卡片发光 · 版本号滚动 · 进度归零</div>
                                </div>
                                <div style="padding:10px 12px;border-radius:12px;background:#111827;color:#fff;font-size:12px;display:flex;justify-content:space-between;align-items:center;">
                                    <div><b>升级成功</b> · 「销售推广」已升级至 v3.0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="artboard" id="artboard-5">
                <div class="artboard-label">
                    <span>知识缺口阻拦（静态示意）</span>
                    <span class="artboard-label-id">#5</span>
                </div>
                <div class="artboard-content">
                    <div class="artboard-page-preview">
                        <div style="background:white;border:1px solid #e5e7eb;border-radius:16px;overflow:hidden;">
                            <div style="padding:12px 14px;border-bottom:1px solid #e5e7eb;font-weight:900;">知识缺口（阻拦中）</div>
                            <div style="padding:14px;display:grid;gap:10px;">
                                <div style="padding:10px 12px;border-radius:12px;background:rgba(245,158,11,.12);border:1px solid rgba(245,158,11,.35);">
                                    <div style="font-size:12px;font-weight:900;margin-bottom:6px;">⚠️ 知识库资料不足，建议先补充</div>
                                    <div style="font-size:12px;color:#6b7280;line-height:1.7;">为避免进化“治标不治本”，默认禁用操作，需先选择下一步。</div>
                                    <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:10px;">
                                        <div style="padding:8px 10px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;font-size:12px;font-weight:800;">忽略提示</div>
                                        <div style="padding:8px 10px;border-radius:10px;background:#3b82f6;color:#fff;font-size:12px;font-weight:900;">去补充</div>
                                    </div>
                                </div>
                                <div style="font-size:12px;color:#9ca3af;">（示意：Banner显示时，推荐答案/移除此题/提交按钮禁用）</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== 侧边栏导航 ========== -->
    <div class="sidebar" id="sidebar">
        <div class="logo">
            <div class="logo-icon">E</div>
            <span>EVA</span>
        </div>

        <nav class="nav-section">
            <div class="nav-label">主导航</div>
            <a href="#" class="nav-item">
                <span class="nav-item-icon">&#127968;</span>
                <span>控制台</span>
            </a>
            <a href="#" class="nav-item">
                <span class="nav-item-icon">&#128172;</span>
                <span>Agent效果体验</span>
            </a>
            <a href="#" class="nav-item">
                <span class="nav-item-icon">&#128218;</span>
                <span>知识库</span>
            </a>
            <a href="#" class="nav-item active">
                <span class="nav-item-icon">&#10024;</span>
                <span>Agent进化</span>
            </a>
            <a href="#" class="nav-item">
                <span class="nav-item-icon">&#128221;</span>
                <span>题库</span>
            </a>
            <a href="#" class="nav-item">
                <span class="nav-item-icon">&#128490;</span>
                <span>会话记录</span>
            </a>
            <a href="#" class="nav-item">
                <span class="nav-item-icon">&#128640;</span>
                <span>部署</span>
            </a>
            <a href="#" class="nav-item">
                <span class="nav-item-icon">&#128274;</span>
                <span>安全合规</span>
            </a>
        </nav>

        <div class="user-profile">
            <div class="user-avatar">硯</div>
            <div class="user-info">
                <div class="user-name">硯寒清</div>
                <div class="user-company">深圳语境天择</div>
            </div>
            <span class="user-expand">&#9660;</span>
        </div>
    </div>

    <!-- ========== 主内容区域 ========== -->
	    <div class="main" id="main">
	        <header class="topbar">
	            <button class="topbar-back" id="topbarBack" type="button" onclick="goOverview()" aria-label="返回">&#8592;</button>
	            <h1 class="topbar-title" id="topbarTitle">Agent进化</h1>
	        </header>

	        <div class="content" id="mainContent">
	            <div id="overviewPage">
	                <section class="evolve-hero" aria-label="汇总与操作">
	                <div class="evolve-hero-row">
	                    <div class="evolve-title">
	                        <div class="icon">&#10024;</div>
	                        <div style="min-width:0;">
	                            <h2>能力进化</h2>
	                            <p></p>
	                        </div>
	                    </div>

                    <div class="summary-pills" aria-label="汇总指标">
                        <div class="pill"><span class="k">可升级</span><span class="v success" id="metricEvolvable">-</span></div>
                        <div class="pill"><span class="k">待处理题目</span><span class="v info" id="metricPending">-</span></div>
                        <div class="pill" title="今日已完成的进化次数"><span class="k">今日已升级</span><span class="v warning" id="metricToday">-</span></div>
                    </div>
                </div>
	                </section>

	                <section class="ability-switch" aria-label="能力选择">
	                    <div class="ability-tiles" id="abilitySwitchHost"></div>
	                </section>

	                <section class="detail-host" id="abilityDetailHost" aria-label="选中能力详情"></section>
	            </div>

	            <div id="tuningPage" class="tuning-page">
	                <section class="tuning-shell" aria-label="进化工作台">
	                    <div id="tuningHost"></div>
	                </section>
	            </div>
	        </div>
	    </div>

    <!-- ========== Modal（复用容器） ========== -->
    <div class="modal-overlay" id="modalOverlay" onclick="onOverlayClick(event)">
        <div class="modal" id="modalRoot" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">-</div>
	                <button class="modal-close" type="button" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" id="modalFooter"></div>
        </div>
    </div>

    <!-- ========== Toast ========== -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // ========== 模式切换 ==========
        let currentMode = 'interactive';

        function switchMode(mode) {
            currentMode = mode;
            const container = document.getElementById('artboardContainer');
            const buttons = document.querySelectorAll('.mode-btn');

            buttons.forEach((btn, index) => {
                btn.classList.remove('active');
                if ((mode === 'interactive' && index === 0) || (mode === 'artboard' && index === 1)) {
                    btn.classList.add('active');
                }
            });

            if (mode === 'artboard') {
                document.body.classList.add('artboard-mode');
                container.classList.add('active');
            } else {
                document.body.classList.remove('artboard-mode');
                container.classList.remove('active');
            }
        }

        function printArtboards() {
            switchMode('artboard');
            setTimeout(() => window.print(), 300);
        }

        async function downloadArtboard(artboardId) {
            const artboard = document.getElementById(artboardId);
            if (!artboard) return;

            const btn = artboard.querySelector('.artboard-download-btn');
            const originalContent = btn ? btn.innerHTML : '';
            if (btn) {
                btn.classList.add('loading');
                btn.innerHTML = '&#8987;';
            }

            try {
                const label = artboard.querySelector('.artboard-label span:first-child');
                const filename = label ? label.textContent.trim().replace(/[\/\\:*?"<>|]/g, '-') : artboardId;

                const pagePreview = artboard.querySelector('.artboard-page-preview');
                const content = artboard.querySelector('.artboard-content');

                const originalTransform = pagePreview ? pagePreview.style.transform : '';
                const originalOverflow = content.style.overflow;
                const originalMaxHeight = content.style.maxHeight;

                if (pagePreview) pagePreview.style.transform = 'none';
                content.style.overflow = 'visible';
                content.style.maxHeight = 'none';

                const targetElement = pagePreview || content;
                const canvas = await html2canvas(targetElement, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    logging: false,
                    ignoreElements: (el) => el.classList && el.classList.contains('artboard-download-btn')
                });

                if (pagePreview) pagePreview.style.transform = originalTransform;
                content.style.overflow = originalOverflow;
                content.style.maxHeight = originalMaxHeight;

                const link = document.createElement('a');
                link.download = `${filename}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();

                if (btn) {
                    btn.innerHTML = '&#10003;';
                    setTimeout(() => {
                        btn.innerHTML = originalContent;
                        btn.classList.remove('loading');
                    }, 1500);
                }
            } catch (error) {
                console.error('下载失败:', error);
                if (btn) {
                    btn.innerHTML = '&#10005;';
                    setTimeout(() => {
                        btn.innerHTML = originalContent;
                        btn.classList.remove('loading');
                    }, 1500);
                }
            }
        }

        // ========== 原型数据（可交互演示） ==========
        const abilitiesSeed = [
            {
                id: 'customer_service',
                name: '智能客服',
                icon: '&#128172;',
                color: '#10B981',
                description: '',
                progress: 68,
                version: 'v3.0',
                roundTotal: 50,
                pending: 16,
                solved: 34,
                lastTunedAt: '2天前',
                tuningStats: { total: 0, chosen: 0, custom: 0, removed: 0 },
	                history: [
	                    { from: 'v1.0', to: 'v2.0', at: '2025-12-15', stats: { total: 45, chosen: 28, custom: 15, removed: 2 } },
	                    { from: 'v2.0', to: 'v3.0', at: '2026-01-09', stats: { total: 50, chosen: 32, custom: 18, removed: 0 } }
	                ],
	                queue: [
	                    { id: 'q1', source: '题库', channel: 'official', tag: '缺关键点', title: '跨境订单的退换货时效如何计算？', agentAnswer: '退换货时效一般以签收时间为准，具体以平台规则为准。' },
	                    { id: 'q2', source: '用户点踩', channel: 'c_downvote', tag: '缺同理心', title: '用户说"我不满意"，你要怎么安抚？', userComment: '你这回答太冷冰冰了。', agentAnswer: '好的，我知道了。请描述下问题。' },
	                    { id: 'q3', source: '题库', channel: 'official', tag: '缺步骤', title: '用户要修改收货地址，需要哪些信息？', agentAnswer: '你把新地址发给我就行。' },
	                    { id: 'q4', source: '效果体验点踩', channel: 'playground_downvote', tag: '缺边界', title: '保修范围包含哪些情况？不包含哪些？', userComment: '没有说清楚哪些不保。', agentAnswer: '我们提供保修服务，具体请咨询客服。' },
	                    { id: 'q5', source: '题库', channel: 'official', tag: '缺确认', title: '用户反馈物流延迟，你要如何安抚并给出处理路径？', agentAnswer: '我催一下物流。' },
	                    { id: 'q6', source: '题库', channel: 'official', tag: '缺关键点', title: '如何开具发票？支持哪些发票类型？', agentAnswer: '可以开票，请提供抬头。' },
	                    { id: 'q7', source: '用户点踩', channel: 'c_downvote', tag: '缺同理心', title: '用户情绪激动辱骂客服，如何回应并引导？', userComment: '你别教训我，我只想解决问题。', agentAnswer: '请您注意言辞，否则我将结束对话。' },
	                    { id: 'q8', source: '题库', channel: 'official', tag: '缺规则', title: '优惠券能否叠加使用？如果不能如何解释？', agentAnswer: '看情况。' }
	                ]
	            },
            {
                id: 'content_marketing',
                name: '内容营销',
                icon: '&#9997;',
                color: '#3B82F6',
                description: '',
                progress: 32,
                version: 'v2.0',
                roundTotal: 50,
                pending: 34,
                solved: 12,
                lastTunedAt: '昨天',
                tuningStats: { total: 0, chosen: 0, custom: 0, removed: 0 },
	                history: [
	                    { from: 'v1.0', to: 'v2.0', at: '2025-12-28', stats: { total: 40, chosen: 22, custom: 16, removed: 2 } }
	                ],
	                queue: [
	                    { id: 'q1', source: '题库', channel: 'official', tag: '缺结构', title: '为新品蓝牙耳机写一条小红书种草文案。', agentAnswer: '这款耳机很好用，快来买。' },
	                    { id: 'q2', source: '用户点踩', channel: 'c_downvote', tag: '缺吸引力', title: '把"限时折扣"写得更有紧迫感。', userComment: '一点都不想点进去。', agentAnswer: '现在有优惠，欢迎购买。' },
	                    { id: 'q3', source: '题库', channel: 'official', tag: '缺卖点', title: '用 3 个要点总结这款耳机的核心卖点。', agentAnswer: '音质好、续航强、颜值高。' },
	                    { id: 'q4', source: '效果体验点踩', channel: 'playground_downvote', tag: '缺风格', title: '把文案改成"更高级、更克制"的语气。', userComment: '太像低价促销文案了。', agentAnswer: '超级无敌划算，赶紧冲！' },
	                    { id: 'q5', source: '题库', channel: 'official', tag: '缺行动号召', title: '为活动海报写一句更有转化的 CTA。', agentAnswer: '欢迎了解详情。' },
	                    { id: 'q6', source: '题库', channel: 'official', tag: '缺信息层级', title: '把一段长文案改成分点结构，突出重点。', agentAnswer: '我帮你改一下：……' },
	                    { id: 'q7', source: '用户点踩', channel: 'c_downvote', tag: '缺场景', title: '为"通勤场景"写一段代入感更强的文案。', userComment: '没有画面感。', agentAnswer: '通勤的时候用这款耳机很方便。' },
	                    { id: 'q8', source: '题库', channel: 'official', tag: '缺对比', title: '写一段"旧款 vs 新款"的对比卖点文案。', agentAnswer: '新款更好。' }
	                ]
	            },
            {
                id: 'sales_promotion',
                name: '销售推广',
                icon: '&#128188;',
                color: '#8B5CF6',
                description: '',
                progress: 100,
                version: 'v2.0',
                roundTotal: 50,
                pending: 0,
                solved: 50,
                lastTunedAt: '今天',
                tuningStats: { total: 50, chosen: 32, custom: 18, removed: 0 },
                history: [
                    { from: 'v1.0', to: 'v2.0', at: '2026-01-16', stats: { total: 50, chosen: 31, custom: 17, removed: 2 } }
                ],
                queue: []
            },
            {
                id: 'business_intelligence',
                name: '商业情报',
                icon: '&#128202;',
                color: '#F59E0B',
                description: '',
                progress: 45,
                version: 'v1.0',
                roundTotal: 40,
                pending: 22,
                solved: 8,
                lastTunedAt: '5天前',
                tuningStats: { total: 0, chosen: 0, custom: 0, removed: 0 },
	                history: [],
	                queue: [
		                    { id: 'q1', source: '题库', channel: 'official', tag: '缺数据', title: '给出三家竞品的价格区间对比。', agentAnswer: '大概都差不多。', kbCoverage: 'missing', gapReason: '缺少竞品价格数据口径/来源' },
		                    { id: 'q2', source: '用户点踩', channel: 'c_downvote', tag: '缺依据', title: '你的结论依据是什么？请给出数据口径。', userComment: '你这结论张口就来。', agentAnswer: '这是我的经验判断。', kbCoverage: 'missing', gapReason: '缺少结论的证据口径/来源' },
	                    { id: 'q3', source: '题库', channel: 'official', tag: '缺结构', title: '把竞品分析输出成"结论-证据-建议"的结构。', agentAnswer: '我觉得A最好。' },
	                    { id: 'q4', source: '题库', channel: 'official', tag: '缺对比', title: '对比三家竞品的目标用户与核心卖点。', agentAnswer: '各有优劣。' },
	                    { id: 'q5', source: '效果体验点踩', channel: 'playground_downvote', tag: '缺细节', title: '补充渠道策略：线上/线下分别怎么打？', userComment: '完全没落地细节。', agentAnswer: '线上线下都要做。' },
	                    { id: 'q6', source: '题库', channel: 'official', tag: '缺风险', title: '给出进入该市场的 3 个主要风险与对策。', agentAnswer: '风险很多，需要评估。' }
	                ]
	            }
	        ];

        // ========== 题库数据（按能力分组） ==========
        const questionBanks = {
            // 题库（MVP仅官方题库）
            official: {
                customer_service: [
                    { id: 'ob1', title: '处理退换货请求的标准话术模板。', status: 'pass' },
                    { id: 'ob2', title: '如何识别并安抚情绪激动的客户？', status: 'fail' },
                    { id: 'ob3', title: '客服场景中的禁忌用语有哪些？', status: 'pass' },
                    { id: 'ob4', title: '如何处理客户的无理要求？', status: 'fail' },
                    { id: 'ob5', title: '多渠道客服的一致性回复策略。', status: 'pass' },
                    { id: 'ob6', title: '客户满意度提升的关键话术。', status: 'pass' },
                    { id: 'ob7', title: '退款超时的解释与补偿方案。', status: 'fail' },
                    { id: 'ob8', title: '物流延迟的标准安抚话术。', status: 'pass' },
                    { id: 'ob9', title: '如何引导客户完成自助服务？', status: 'pass' },
                    { id: 'ob10', title: '处理重复投诉的升级策略。', status: 'fail' },
                    { id: 'ob11', title: '夜间客服的特殊应对技巧。', status: 'pass' },
                    { id: 'ob12', title: '如何婉拒超出服务范围的请求？', status: 'fail' },
                    { id: 'ob13', title: '客户等待时的话术填充技巧。', status: 'pass' },
                    { id: 'ob14', title: '处理价格异议的标准回复。', status: 'pass' },
                    { id: 'ob15', title: '如何将投诉转化为好评机会？', status: 'fail' },
                    { id: 'ob16', title: '多次购买客户的专属服务话术。', status: 'pass' },
                    { id: 'ob17', title: '缺货商品的替代推荐策略。', status: 'pass' },
                    { id: 'ob18', title: '如何处理恶意差评威胁？', status: 'fail' },
                    { id: 'ob19', title: '客服交接时的信息同步规范。', status: 'pass' },
                    { id: 'ob20', title: '节假日高峰期的快速响应模板。', status: 'pass' },
                    { id: 'ob21', title: '如何解释复杂的售后政策？', status: 'fail' },
                    { id: 'ob22', title: '客户信息核实的标准流程。', status: 'pass' },
                    { id: 'ob23', title: '处理订单修改请求的规范。', status: 'pass' },
                    { id: 'ob24', title: '如何应对客户的比价行为？', status: 'fail' },
                    { id: 'ob25', title: '售后服务满意度回访话术。', status: 'pass' },
                    { id: 'ob26', title: '处理商品质量投诉的流程。', status: 'pass' },
                    { id: 'ob27', title: '如何安抚因系统故障受影响的客户？', status: 'fail' },
                    { id: 'ob28', title: '客户要求加急处理时的应对。', status: 'pass' },
                    { id: 'ob29', title: '处理发票相关问题的标准答复。', status: 'pass' },
                    { id: 'ob30', title: '如何引导客户提供有效的问题描述？', status: 'pass' },
                    { id: 'ob31', title: '处理客户隐私泄露担忧的话术。', status: 'fail' },
                    { id: 'ob32', title: '跨境订单的特殊客服注意事项。', status: 'pass' },
                    { id: 'ob33', title: '如何处理客户的过度要求？', status: 'fail' },
                    { id: 'ob34', title: '会员权益咨询的标准解答。', status: 'pass' },
                    { id: 'ob35', title: '处理支付问题的排查引导。', status: 'pass' },
                ],
                content_marketing: [
                    { id: 'ob1', title: '电商大促文案的 5 个核心要素。', status: 'pass' },
                    { id: 'ob2', title: '短视频脚本的"钩子-内容-CTA"结构。', status: 'fail' },
                    { id: 'ob3', title: '不同平台的文案风格差异指南。', status: 'pass' },
                    { id: 'ob4', title: '如何写出高点击率的标题？', status: 'pass' },
                    { id: 'ob5', title: '用户证言文案的撰写技巧。', status: 'fail' },
                    { id: 'ob6', title: '小红书种草笔记的爆款公式。', status: 'pass' },
                    { id: 'ob7', title: '如何用数据提升文案说服力？', status: 'fail' },
                    { id: 'ob8', title: '品牌故事的叙事框架设计。', status: 'pass' },
                    { id: 'ob9', title: '节日营销文案的提前规划。', status: 'pass' },
                    { id: 'ob10', title: '如何写出有温度的品牌文案？', status: 'fail' },
                    { id: 'ob11', title: '产品卖点的差异化表达技巧。', status: 'pass' },
                    { id: 'ob12', title: '朋友圈营销文案的最佳实践。', status: 'pass' },
                    { id: 'ob13', title: '如何避免文案中的违禁词？', status: 'pass' },
                    { id: 'ob14', title: '情感共鸣型文案的创作方法。', status: 'fail' },
                    { id: 'ob15', title: 'A/B测试优化文案的实操指南。', status: 'pass' },
                    { id: 'ob16', title: '如何为不同用户群体定制文案？', status: 'fail' },
                    { id: 'ob17', title: '直播预告文案的吸睛技巧。', status: 'pass' },
                    { id: 'ob18', title: '产品详情页文案的转化优化。', status: 'pass' },
                    { id: 'ob19', title: '如何用场景化文案激发需求？', status: 'fail' },
                    { id: 'ob20', title: '用户痛点挖掘与文案转化。', status: 'pass' },
                    { id: 'ob21', title: '品牌slogan的创作原则。', status: 'pass' },
                    { id: 'ob22', title: '如何写出"有梗"的社媒文案？', status: 'fail' },
                    { id: 'ob23', title: '长文案的结构与节奏把控。', status: 'pass' },
                    { id: 'ob24', title: '限时促销的紧迫感营造技巧。', status: 'pass' },
                    { id: 'ob25', title: '如何让文案更具行动号召力？', status: 'fail' },
                    { id: 'ob26', title: '新品上市文案的预热策略。', status: 'pass' },
                    { id: 'ob27', title: 'KOL合作文案的品牌调性把控。', status: 'pass' },
                    { id: 'ob28', title: '如何写出符合SEO的产品描述？', status: 'pass' },
                    { id: 'ob29', title: '用户评价的引导与展示技巧。', status: 'fail' },
                    { id: 'ob30', title: '品牌周年庆文案的情感表达。', status: 'pass' },
                    { id: 'ob31', title: '如何用对比突出产品优势？', status: 'pass' },
                    { id: 'ob32', title: '会员专属文案的尊贵感营造。', status: 'fail' },
                    { id: 'ob33', title: '跨平台内容分发的适配策略。', status: 'pass' },
                    { id: 'ob34', title: '如何写出引发UGC的互动文案？', status: 'pass' },
                    { id: 'ob35', title: '品牌危机公关文案的要点。', status: 'fail' },
                ],
                sales_promotion: [
                    { id: 'ob1', title: 'SPIN销售法在电商场景的应用。', status: 'pass' },
                    { id: 'ob2', title: '如何通过提问挖掘客户真实需求？', status: 'fail' },
                    { id: 'ob3', title: '限时优惠的话术设计与节奏把控。', status: 'pass' },
                    { id: 'ob4', title: '处理"我再考虑考虑"的5种策略。', status: 'pass' },
                    { id: 'ob5', title: '如何做好产品的价值塑造？', status: 'fail' },
                    { id: 'ob6', title: '客户犹豫时的临门一脚话术。', status: 'pass' },
                    { id: 'ob7', title: '交叉销售的时机与技巧。', status: 'pass' },
                    { id: 'ob8', title: '如何应对"太贵了"的价格异议？', status: 'fail' },
                    { id: 'ob9', title: '老客户复购的激活策略。', status: 'pass' },
                    { id: 'ob10', title: '如何建立客户信任感？', status: 'pass' },
                    { id: 'ob11', title: '处理竞品对比时的话术技巧。', status: 'fail' },
                    { id: 'ob12', title: '赠品策略的设计与话术。', status: 'pass' },
                    { id: 'ob13', title: '如何让客户主动推荐？', status: 'pass' },
                    { id: 'ob14', title: '新客户破冰的开场话术。', status: 'fail' },
                    { id: 'ob15', title: '套餐组合的推荐逻辑。', status: 'pass' },
                    { id: 'ob16', title: '如何处理"我朋友买更便宜"？', status: 'fail' },
                    { id: 'ob17', title: '直播间逼单的节奏控制。', status: 'pass' },
                    { id: 'ob18', title: '高客单价产品的销售策略。', status: 'pass' },
                    { id: 'ob19', title: '如何挽回即将流失的客户？', status: 'fail' },
                    { id: 'ob20', title: '会员升级的推荐话术。', status: 'pass' },
                    { id: 'ob21', title: '如何制造稀缺感提升转化？', status: 'pass' },
                    { id: 'ob22', title: '处理退款挽留的标准流程。', status: 'fail' },
                    { id: 'ob23', title: '节日促销的预热与引爆。', status: 'pass' },
                    { id: 'ob24', title: '如何让客户感受到专属服务？', status: 'pass' },
                    { id: 'ob25', title: '分期付款的推荐时机与话术。', status: 'fail' },
                    { id: 'ob26', title: '库存紧张的真实性表达。', status: 'pass' },
                    { id: 'ob27', title: '如何处理"等活动再买"？', status: 'fail' },
                    { id: 'ob28', title: '私域流量的转化话术。', status: 'pass' },
                    { id: 'ob29', title: '新品首发的预售策略。', status: 'pass' },
                    { id: 'ob30', title: '如何用案例增强说服力？', status: 'pass' },
                    { id: 'ob31', title: '处理"我只是随便看看"的话术。', status: 'fail' },
                    { id: 'ob32', title: '满减凑单的引导技巧。', status: 'pass' },
                    { id: 'ob33', title: '如何让客户感受到紧迫感？', status: 'pass' },
                    { id: 'ob34', title: '售后增值服务的推荐时机。', status: 'fail' },
                    { id: 'ob35', title: '社群团购的成交技巧。', status: 'pass' },
                ],
                business_intelligence: [
                    { id: 'ob1', title: '竞品分析报告的标准框架。', status: 'pass' },
                    { id: 'ob2', title: '如何从财报中提取关键竞争信息？', status: 'fail' },
                    { id: 'ob3', title: '市场趋势预测的常用分析方法。', status: 'pass' },
                    { id: 'ob4', title: '消费者洞察报告的撰写要点。', status: 'fail' },
                    { id: 'ob5', title: '行业分析的"五力模型"应用。', status: 'pass' },
                    { id: 'ob6', title: 'SWOT分析的实战应用技巧。', status: 'pass' },
                    { id: 'ob7', title: '如何评估市场进入壁垒？', status: 'fail' },
                    { id: 'ob8', title: '用户画像的构建方法论。', status: 'pass' },
                    { id: 'ob9', title: '竞品定价策略的分析框架。', status: 'pass' },
                    { id: 'ob10', title: '如何识别行业拐点信号？', status: 'fail' },
                    { id: 'ob11', title: '市场规模测算的三种方法。', status: 'pass' },
                    { id: 'ob12', title: '供应链风险的评估指标。', status: 'pass' },
                    { id: 'ob13', title: '如何分析竞品的营销策略？', status: 'fail' },
                    { id: 'ob14', title: '行业报告的快速阅读技巧。', status: 'pass' },
                    { id: 'ob15', title: '消费趋势的数据来源与分析。', status: 'pass' },
                    { id: 'ob16', title: '如何评估新技术的商业潜力？', status: 'fail' },
                    { id: 'ob17', title: '竞品产品功能的对比矩阵。', status: 'pass' },
                    { id: 'ob18', title: '市场调研问卷的设计原则。', status: 'pass' },
                    { id: 'ob19', title: '如何从社媒数据洞察品牌口碑？', status: 'fail' },
                    { id: 'ob20', title: '行业生命周期的判断方法。', status: 'pass' },
                    { id: 'ob21', title: '竞品组织架构的分析价值。', status: 'pass' },
                    { id: 'ob22', title: '如何预测竞品的下一步动作？', status: 'fail' },
                    { id: 'ob23', title: '渠道分析的关键指标体系。', status: 'pass' },
                    { id: 'ob24', title: '政策法规对行业的影响分析。', status: 'pass' },
                    { id: 'ob25', title: '如何做好竞品的PEST分析？', status: 'fail' },
                    { id: 'ob26', title: '用户需求变化的监测方法。', status: 'pass' },
                    { id: 'ob27', title: '行业头部玩家的战略解读。', status: 'pass' },
                    { id: 'ob28', title: '如何评估潜在合作伙伴？', status: 'fail' },
                    { id: 'ob29', title: '市场细分的维度与方法。', status: 'pass' },
                    { id: 'ob30', title: '竞品用户反馈的收集与分析。', status: 'pass' },
                    { id: 'ob31', title: '如何从招聘信息分析竞品动向？', status: 'fail' },
                    { id: 'ob32', title: '行业会议情报的收集技巧。', status: 'pass' },
                    { id: 'ob33', title: '新兴市场的机会识别方法。', status: 'pass' },
                    { id: 'ob34', title: '如何建立持续的竞品监测机制？', status: 'fail' },
                    { id: 'ob35', title: '商业情报汇报的结构与呈现。', status: 'pass' },
                ]
            }
        };

        // 题库选择器状态（MVP只使用题库）
        const qbankState = {
            searchQuery: '',
            selectedIds: new Set(),
            currentPage: 1
        };

        const abilityOrder = new Map(abilitiesSeed.map((a, idx) => [a.id, idx]));

        let abilities = [];

	        const uiState = {
	            route: 'overview',
	            filter: 'all',
	            query: '',
	            todaySubmits: 0,
	            todayKey: null,
	            selectedId: null,
	            isBusy: false,
	            wheelIgnoreSnapUntil: 0,
	            tuningMode: 'single',
	            tuningAbilityId: null,
	            tuningQid: null
	        };

        function cloneSeed() {
            const cloned = JSON.parse(JSON.stringify(abilitiesSeed));
            cloned.forEach(a => {
                a.queue = Array.isArray(a.queue) ? a.queue : [];
                a._queueSeq = 1;
                a.roundTotal = Number.isFinite(a.roundTotal) ? a.roundTotal : Math.max(1, (a.pending || 0) + Math.round(((a.progress || 0) / 100) * ((a.pending || 0) + 1)));
                a.pending = Math.max(0, parseInt(a.pending || 0, 10) || 0);
                a.solved = Math.max(0, parseInt(a.solved || 0, 10) || 0);
                a.progress = recomputeProgress(a);
            });
            return cloned;
        }

        function parseVersion(v) {
            const m = /^v(\\d+)\\.0$/.exec(v || '');
            return m ? parseInt(m[1], 10) : 1;
        }

        function nextVersion(v) {
            return `v${parseVersion(v) + 1}.0`;
        }

        function getTodayKey() {
            const d = new Date();
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        }

        function ensureTodayCounter() {
            const k = getTodayKey();
            if (uiState.todayKey !== k) {
                uiState.todayKey = k;
                uiState.todaySubmits = 0;
            }
        }

	        const queueTemplates = {
		            customer_service: [
		                { tag: '缺边界', title: '保修范围包含哪些情况？不包含哪些？', source: '效果体验点踩', channel: 'playground_downvote', userComment: '没说清楚哪些不保。', kbCoverage: 'missing', gapReason: '缺少保修条款/范围资料' },
		                { tag: '缺时效', title: '跨境订单的退换货时效如何计算？', source: '题库', channel: 'official', kbCoverage: 'missing', gapReason: '缺少跨境退换货政策资料' },
		                { tag: '缺流程', title: '用户要申请发票，具体操作步骤是什么？', source: '题库', channel: 'official', kbCoverage: 'missing', gapReason: '缺少发票申请流程说明' },
		                { tag: '缺同理心', title: '用户说"我不满意"，你要怎么安抚？', source: '用户点踩', channel: 'c_downvote', userComment: '你这太冷了。' },
		                { tag: '缺步骤', title: '用户要修改收货地址，需要哪些信息？', source: '题库', channel: 'official' },
		                { tag: '缺确认', title: '用户反馈物流延迟，你要如何安抚并给出处理路径？', source: '题库', channel: 'official' }
		            ],
		            content_marketing: [
		                { tag: '缺卖点', title: '用 3 个要点总结这款耳机的核心卖点。', source: '题库', channel: 'official', kbCoverage: 'missing', gapReason: '缺少产品参数/卖点资料' },
		                { tag: '缺场景', title: '这款产品适合哪些使用场景？', source: '题库', channel: 'official', kbCoverage: 'missing', gapReason: '缺少产品场景定位资料' },
		                { tag: '缺结构', title: '为新品蓝牙耳机写一条小红书种草文案。', source: '题库', channel: 'official' },
		                { tag: '缺吸引力', title: '把"限时折扣"写得更有紧迫感。', source: '用户点踩', channel: 'c_downvote', userComment: '不想点。' },
		                { tag: '缺风格', title: '把文案改成"更高级、更克制"的语气。', source: '效果体验点踩', channel: 'playground_downvote', userComment: '像低价促销。' },
		                { tag: '缺行动号召', title: '为活动海报写一句更有转化的 CTA。', source: '题库', channel: 'official' }
		            ],
		            business_intelligence: [
		                { tag: '缺数据', title: '给出三家竞品的价格区间对比。', source: '题库', channel: 'official', kbCoverage: 'missing', gapReason: '缺少竞品价格数据口径/来源' },
		                { tag: '缺依据', title: '你的结论依据是什么？请给出数据口径。', source: '用户点踩', channel: 'c_downvote', userComment: '结论没依据。', kbCoverage: 'missing', gapReason: '缺少结论的证据口径/来源' },
		                { tag: '缺趋势', title: '该品类近 3 年的市场增速是多少？', source: '题库', channel: 'official', kbCoverage: 'missing', gapReason: '缺少市场趋势数据' },
		                { tag: '缺结构', title: '把竞品分析输出成"结论-证据-建议"的结构。', source: '题库', channel: 'official' },
		                { tag: '缺对比', title: '对比三家竞品的目标用户与核心卖点。', source: '题库', channel: 'official' },
		                { tag: '缺风险', title: '给出进入该市场的 3 个主要风险与对策。', source: '题库', channel: 'official' }
		            ]
	        };

        function recomputeProgress(a) {
            const total = Math.max(1, parseInt(a.roundTotal || 0, 10) || 1);
            const solved = Math.max(0, Math.min(total, parseInt(a.solved || 0, 10) || 0));
            return Math.max(0, Math.min(100, Math.round((solved / total) * 100)));
        }

	        function materializeQueue(a, minCount = 1) {
	            if (!a) return;
	            a.queue = Array.isArray(a.queue) ? a.queue : [];
	            a._queueSeq = a._queueSeq || 1;

            const want = Math.max(0, Math.min(Math.max(0, a.pending || 0), minCount));
            const templateList = queueTemplates[a.id] || [{ tag: '待进化', title: '请优化该能力的回答质量。', source: '评测发现' }];

	            while (a.queue.length < want) {
	                const t = templateList[(a._queueSeq - 1) % templateList.length];
	                const id = `auto_${a.id}_${a._queueSeq++}`;
		                a.queue.push({
		                    id,
		                    source: t.source,
		                    channel: t.channel,
		                    tag: t.tag,
		                    title: t.title,
		                    userComment: t.userComment,
		                    agentAnswer: t.agentAnswer,
		                    kbCoverage: t.kbCoverage,
		                    gapReason: t.gapReason
		                });
		            }
		        }

        function computeStatus(a) {
            if ((a.progress || 0) >= 100) return 'evolvable';
            if ((a.pending || 0) === 0) return 'empty';
            return 'normal';
        }

        function escapeHtml(s) {
            return String(s)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        function hexToRgb(hex) {
            const h = (hex || '').trim().replace('#', '');
            if (!/^[0-9a-fA-F]{6}$/.test(h)) return { r: 99, g: 102, b: 241 };
            return {
                r: parseInt(h.slice(0, 2), 16),
                g: parseInt(h.slice(2, 4), 16),
                b: parseInt(h.slice(4, 6), 16)
            };
        }

        function rgbToHex({ r, g, b }) {
            const clamp = (n) => Math.max(0, Math.min(255, Math.round(n)));
            const to2 = (n) => clamp(n).toString(16).padStart(2, '0');
            return `#${to2(r)}${to2(g)}${to2(b)}`.toUpperCase();
        }

        function mixHex(a, b, ratioB) {
            const ra = hexToRgb(a);
            const rb = hexToRgb(b);
            const t = Math.max(0, Math.min(1, ratioB));
            return rgbToHex({
                r: ra.r * (1 - t) + rb.r * t,
                g: ra.g * (1 - t) + rb.g * t,
                b: ra.b * (1 - t) + rb.b * t
            });
        }

        function hexToRgba(hex, alpha) {
            const { r, g, b } = hexToRgb(hex);
            const a = Math.max(0, Math.min(1, alpha));
            return `rgba(${r}, ${g}, ${b}, ${a})`;
        }

        function sortAbilities(list) {
            return [...list].sort((a, b) => {
                const oa = abilityOrder.get(a.id) ?? 0;
                const ob = abilityOrder.get(b.id) ?? 0;
                return oa - ob;
            });
        }

        function filterAbilities(list) {
            const q = uiState.query.trim().toLowerCase();
            return list.filter(a => {
                const status = computeStatus(a);
                if (uiState.filter !== 'all' && status !== uiState.filter) return false;
                if (!q) return true;
                return (a.name + ' ' + a.description).toLowerCase().includes(q);
            });
        }

        function getVisibleList() {
            return sortAbilities(filterAbilities(abilities));
        }

        function ensureSelected(list) {
            if (list.length === 0) {
                uiState.selectedId = null;
                return null;
            }

            if (uiState.selectedId && list.some(a => a.id === uiState.selectedId)) {
                return uiState.selectedId;
            }

            uiState.selectedId = list[0].id;
            return uiState.selectedId;
        }

	        function updateSummaryMetrics() {
	            ensureTodayCounter();
	            const evolvableCount = abilities.filter(a => computeStatus(a) === 'evolvable').length;
	            const pendingTotal = abilities.reduce((sum, a) => sum + (a.pending || 0), 0);
	            document.getElementById('metricEvolvable').textContent = String(evolvableCount);
	            document.getElementById('metricPending').textContent = String(pendingTotal);
	            document.getElementById('metricToday').textContent = String(uiState.todaySubmits);
	        }

	        function updateResultHint() {}

	        function updateRouteUi() {
	            document.body.classList.toggle('route-tuning', uiState.route === 'tuning');
	            const title = document.getElementById('topbarTitle');
	            if (title) {
	                if (uiState.route === 'tuning') {
	                    const a = abilities.find(x => x.id === uiState.tuningAbilityId);
	                    title.textContent = '进化工作台';
	                } else {
	                    title.textContent = 'Agent进化';
	                }
	            }
	        }

	        function goOverview() {
	            uiState.route = 'overview';
	            uiState.tuningMode = 'single';
	            uiState.tuningAbilityId = null;
	            uiState.tuningQid = null;
	            updateRouteUi();
	            renderAll({ scrollToSelected: false, behavior: 'auto', preserveWheelScroll: true });
	        }

	        function enterTuningPage(abilityId, qid = null) {
	            const a = abilities.find(x => x.id === abilityId);
	            if (!a) return;
	            uiState.selectedId = abilityId;
	            uiState.route = 'tuning';
	            uiState.tuningMode = 'continuous';
	            uiState.tuningAbilityId = abilityId;
	            uiState.tuningQid = qid;
	            updateRouteUi();
	            renderTuningPage();
	        }

	        function renderAll({ scrollToSelected = false, behavior = 'smooth', preserveWheelScroll = true } = {}) {
	            if (uiState.route !== 'overview') return;
	            const list = getVisibleList();
	            updateSummaryMetrics();
	            ensureSelected(list);
	            updateResultHint();
	            renderAbilitySwitch(list);
	            renderDetail(list.find(a => a.id === uiState.selectedId) || null);
	        }

	        function renderAbilitySwitch(list) {
	            const host = document.getElementById('abilitySwitchHost');
	            if (!host) return;
	            host.innerHTML = '';

	            if (!list.length) {
	                const empty = document.createElement('div');
	                empty.className = 'card';
	                empty.style.gridColumn = '1 / -1';
	                empty.innerHTML = `
	                    <div style="display:flex;align-items:center;gap:10px;">
	                        <div style="width:44px;height:44px;border-radius:16px;background:var(--eva-primary-bg);display:flex;align-items:center;justify-content:center;font-size:20px;">&#128269;</div>
	                        <div>
	                            <div style="font-weight:900;">未找到匹配能力</div>
	                            <div style="font-size:12px;color:var(--eva-text-secondary);margin-top:2px;">请调整筛选或搜索条件。</div>
	                        </div>
	                    </div>
	                `;
	                host.appendChild(empty);
	                return;
	            }

	            list.forEach(a => host.appendChild(renderAbilityTile(a)));
	            updateAbilitySwitchActive();
	        }

	        function renderAbilityTile(a) {
	            const status = computeStatus(a);
	            const statusChip = status === 'evolvable'
	                ? `<span class="chip success">&#9679; 可升级</span>`
	                : status === 'empty'
	                    ? `<span class="chip warning">&#9679; 队列为空</span>`
	                    : `<span class="chip primary">&#9679; 进行中</span>`;

	            const btn = document.createElement('button');
	            btn.type = 'button';
	            btn.className = 'ability-tile';
	            btn.dataset.abilityId = a.id;
	            btn.dataset.status = status;

	            btn.style.setProperty('--ability-color', a.color);
	            btn.style.setProperty('--ability-color-light', mixHex(a.color, '#FFFFFF', 0.45));
	            btn.style.setProperty('--ability-color-bg', hexToRgba(a.color, 0.10));
	            btn.style.setProperty('--ability-color-border', hexToRgba(a.color, 0.24));
	            btn.style.setProperty('--ability-color-glow', hexToRgba(a.color, 0.26));

	            btn.innerHTML = `
	                <div class="head">
	                    <div class="left">
	                        <div class="i">${a.icon}</div>
	                        <div style="min-width:0;">
	                            <div class="n">${escapeHtml(a.name)}</div>
	                        </div>
	                    </div>
	                    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px;">
	                        ${statusChip}
		                        <span class="version-badge">
		                            <span style="opacity:.85;">&#128227;</span>
		                            <span class="version-roller" data-role="tileVersionRoller"><span>${escapeHtml(a.version)}</span><span>${escapeHtml(a.version)}</span></span>
		                        </span>
		                    </div>
		                </div>
		                <div>
		                    <div class="progress-track" aria-label="进化进度">
		                        <div class="progress-fill" data-role="tileProgressFill" style="width:${Math.max(0, Math.min(100, a.progress || 0))}%;"></div>
		                    </div>
		                    <div class="progress-meta">
		                        <span class="pct" data-role="tileProgressText">${Math.max(0, Math.min(100, a.progress || 0))}%</span>
		                        <span>待处理 ${a.pending}</span>
		                    </div>
		                </div>
		            `;

	            return btn;
	        }

	        function renderDetail(a) {
	            const host = document.getElementById('abilityDetailHost');
	            if (!host) return;

            if (!a) {
                host.innerHTML = `
                    <div class="detail-body">
                        <div class="callout">
                            <div class="callout-title">&#128269; 未选择能力</div>
                            <div class="callout-desc">请选择一个能力。</div>
                        </div>
                    </div>
                `;
                return;
            }

            host.style.setProperty('--ability-color', a.color);
            host.style.setProperty('--ability-color-light', mixHex(a.color, '#FFFFFF', 0.45));
            host.style.setProperty('--ability-color-bg', hexToRgba(a.color, 0.10));
            host.style.setProperty('--ability-color-border', hexToRgba(a.color, 0.24));
            host.style.setProperty('--ability-color-glow', hexToRgba(a.color, 0.26));
            host.dataset.status = computeStatus(a);

            const status = computeStatus(a);
            const tag = status === 'evolvable'
                ? `<span class="tag tag-success tag-evolvable">可升级</span>`
                : status === 'empty'
                    ? `<span class="tag tag-warning">队列为空</span>`
                    : `<span class="tag tag-primary">进行中</span>`;

	            const evolveEnabled = status === 'evolvable';
	            const canTune = !evolveEnabled && (a.pending || 0) > 0;
	            const tuneCtaHtml = canTune
	                ? `<button class="btn btn-primary action-start-tuning" type="button" data-ability-id="${escapeHtml(a.id)}">开始进化</button>`
	                : '';
	            const evolveCtaHtml = evolveEnabled
	                ? `<button class="btn btn-primary btn-evolve-cta action-evolve" type="button" data-ability-id="${escapeHtml(a.id)}">&#10024; 升级</button>`
	                : '';

	            // 计算知识缺口数量
	            const gapCount = Array.isArray(a.queue) ? a.queue.filter(q => q.kbCoverage === 'missing' || q.gapReason).length : 0;

	            // 知识缺口横幅
	            const gapBarHtml = gapCount > 0 ? `
	                <div class="detail-gap-bar">
	                    <span class="detail-gap-bar-icon">⚠️</span>
	                    <span class="detail-gap-bar-text">「${escapeHtml(a.name)}」有 <strong>${gapCount}</strong> 道题目因知识缺口受阻，建议先补充知识库再继续进化</span>
	                    <span class="detail-gap-bar-actions">
	                        <button class="btn btn-xs btn-ghost" type="button" onclick="this.closest('.detail-gap-bar').style.display='none'">忽略提示</button>
	                        <button class="btn btn-xs btn-secondary" type="button" onclick="toast('info','跳转','正在打开知识库…')">去补充</button>
	                    </span>
	                </div>
	            ` : '';

	            if ((a.pending || 0) > 0) materializeQueue(a, 10);

	            // 队列内容：根据状态区分
	            let queueHtml = '';
	            if (a.queue && a.queue.length) {
	                // 有题目（MVP移除来源标签，只保留题目内容和知识缺口标签）
	                queueHtml = a.queue.slice(0, 10).map((q) => {
	                    const titleHtml = renderQueueTitleInline(q, 'queue-q-title');
	                    return `
	                        <button class="queue-item queue-click" type="button" data-action="open-tuning" data-ability-id="${escapeHtml(a.id)}" data-qid="${escapeHtml(q.id)}">
	                            <div>
	                                <div class="queue-q">${titleHtml}</div>
	                            </div>
	                            <div class="queue-actions">
	                                <span class="chev" aria-hidden="true">&#8250;</span>
	                            </div>
	                        </button>
	                    `;
	                }).join('');
	            } else if (evolveEnabled) {
	                // 100% 可升级：绿色正向引导
	                queueHtml = `
	                    <div class="queue-success-guide">
	                        <div class="queue-success-icon">🎉</div>
	                        <div class="queue-success-title">进化已完成</div>
	                        <div class="queue-success-desc">该能力已准备就绪，点击右上角「升级」让 Agent 更强大</div>
	                    </div>
	                `;
	            } else {
	                // 未满 100% 且队列空：紧迫感引导
	                queueHtml = `
	                    <div class="queue-empty-guide">
	                        <div class="queue-empty-icon">📚</div>
	                        <div class="queue-empty-title">进化题目已用完</div>
	                        <div class="queue-empty-desc">补充更多题目，推动能力进化</div>
	                        <button class="queue-empty-btn" type="button" data-action="open-qbank-overview" data-ability-id="${escapeHtml(a.id)}">
	                            <span>➕</span> 从题库补充
	                        </button>
	                    </div>
	                `;
	            }

            host.innerHTML = `
                <div class="detail-header">
                    <div class="detail-main">
                        <div class="icon">${a.icon}</div>
                        <div style="min-width:0;">
                            <div class="name">
                                <span style="min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(a.name)}</span>
                                ${tag}
                            </div>
                            ${a.description ? `<div class="desc">${escapeHtml(a.description)}</div>` : ''}
                        </div>
                    </div>
                    <div class="detail-actions">
                        <span class="version-badge">
                            <span style="opacity:.85;">&#128227;</span>
                            <span class="version-roller" data-role="detailVersionRoller"><span>${escapeHtml(a.version)}</span><span>${escapeHtml(a.version)}</span></span>
                        </span>
                        <div style="display:flex; gap:10px;">
                            ${tuneCtaHtml}
                            ${evolveCtaHtml}
                        </div>
                    </div>
	                    <div class="detail-progress">
	                        <div class="progress-track" aria-label="进化进度">
	                            <div class="progress-fill" data-role="detailProgressFill" style="width:${Math.max(0, Math.min(100, a.progress))}%;"></div>
	                        </div>
	                        <div class="progress-meta">
	                            <span class="pct" data-role="detailProgressText">${a.progress}%</span>
	                            <span data-role="detailPendingText">· 待处理 ${a.pending}${status === 'evolvable' ? '' : ' · 达 100% 可升级'}</span>
	                        </div>
	                    </div>
	                </div>

                <div class="detail-body">
                    ${gapBarHtml}
                    <div class="detail-grid">
                        <div class="detail-section">
                            <h4>&#128203; 待处理题目</h4>
                            <div class="queue-list">${queueHtml}</div>
                        </div>

                        <div class="detail-side">
                            <div class="detail-section">
                                <h4>&#128202; 概览</h4>
                                <div class="stats">
                                    <div class="stat"><div class="k">已处理</div><div class="v">${a.solved}</div></div>
                                    <div class="stat"><div class="k">待处理</div><div class="v">${a.pending}</div></div>
                                    <div class="stat"><div class="k">最近进化</div><div class="v">${escapeHtml(a.lastTunedAt)}</div></div>
                                    <div class="stat"><div class="k">当前版本</div><div class="v" data-role="detailVersionText">${escapeHtml(a.version)}</div></div>
                                </div>
                            </div>

                            <div class="detail-section">
                                <h4>&#128338; 升级记录</h4>
                                <div class="timeline">${renderHistory(a)}</div>
                            </div>

                            <div class="detail-section">
                                <h4>&#128218; 知识库概况</h4>
                                <div class="stats" style="grid-template-columns:1fr 1fr;">
                                    <div class="stat"><div class="k">文档数</div><div class="v">46</div></div>
                                    <div class="stat"><div class="k">节点数</div><div class="v">1,284</div></div>
                                    <div class="stat"><div class="k">完整性</div><div class="v">78%</div></div>
                                    <div class="stat"><div class="k">知识缺口</div><div class="v">12</div></div>
                                </div>
                                <div class="inline-note" style="margin-top:8px;">
                                    知识完整性影响进化质量，进而影响进化效果。建议保持 ≥ 85%，完整性越高进化效果越好。
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderHistory(a) {
            const list = (a.history || []).slice().reverse().slice(0, 3);
	            if (!list.length) {
	                return `<div class="inline-note">暂无升级记录。完成进化并升级后，会在这里沉淀每次版本升级记录。</div>`;
	            }
            return list.map(h => `
                <div class="timeline-item">
                    <div class="dot"></div>
                    <div>
                        <div class="t">${escapeHtml(h.from)} &#8594; ${escapeHtml(h.to)} <span style="margin-left:8px;color:var(--eva-text-tertiary);font-weight:700;">${escapeHtml(h.at)}</span></div>
                        <div class="d">进化题目 ${h.stats.total} · 采纳回答 ${h.stats.chosen} · 自答 ${h.stats.custom} · 移除 ${h.stats.removed}</div>
                    </div>
                </div>
            `).join('');
        }

	        function updateAbilitySwitchActive() {
	            document.querySelectorAll('.ability-tile').forEach(el => {
	                el.classList.toggle('is-active', el.dataset.abilityId === uiState.selectedId);
	            });
	        }

	        function setSelected(abilityId, { scrollIntoView = true, behavior = 'smooth' } = {}) {
	            if (!abilityId || abilityId === uiState.selectedId) return;
	            uiState.selectedId = abilityId;
	            updateAbilitySwitchActive();
	            const list = getVisibleList();
	            updateResultHint(list);
	            renderDetail(list.find(a => a.id === abilityId) || null);
	        }

        function prevAbility() {
            const list = getVisibleList();
            if (list.length === 0) return;
            const idx = Math.max(0, list.findIndex(a => a.id === uiState.selectedId));
            const prev = list[(idx - 1 + list.length) % list.length];
            setSelected(prev.id, { scrollIntoView: true });
        }

        function nextAbility() {
            const list = getVisibleList();
            if (list.length === 0) return;
            const idx = Math.max(0, list.findIndex(a => a.id === uiState.selectedId));
            const next = list[(idx + 1) % list.length];
            setSelected(next.id, { scrollIntoView: true });
        }

	        // ========== 交互：轮播 ==========

	        // 展开/收起推荐回答（全局函数，直接绑定到按钮避免 label 干扰）
	        function toggleCandExpand(btn, evt) {
	            evt.stopPropagation();
	            evt.preventDefault();
	            const target = btn.dataset.expandTarget;
	            const content = document.querySelector(`[data-expand-content="${target}"]`);
	            if (content) {
	                const isCollapsed = content.classList.contains('collapsed');
	                content.classList.toggle('collapsed');
	                btn.textContent = isCollapsed ? '收起 ▲' : '展开 ▼';
	            }
	        }

		        document.addEventListener('click', (e) => {
		            if (uiState.route === 'tuning') {
		                const qItem = e.target.closest('.wb-item');
		                if (qItem && qItem.dataset.qid) {
		                    setTuningQuestion(qItem.dataset.qid);
		                    return;
		                }

		                const actionBtn = e.target.closest('[data-tune-action]');
		                if (actionBtn) {
		                    handleTuneAction(actionBtn.dataset.tuneAction || '', actionBtn);
		                    return;
		                }
		            }

		            const abilityTile = e.target.closest('.ability-tile');
		            if (abilityTile) {
		                setSelected(abilityTile.dataset.abilityId, { scrollIntoView: true });
		                return;
		            }

		            const startBtn = e.target.closest('.action-start-tuning');
		            if (startBtn) {
		                const abilityId = startBtn.dataset.abilityId || uiState.selectedId;
		                if (!abilityId) return;
		                enterTuningPage(abilityId, null);
		                return;
		            }

		            const queueClick = e.target.closest('[data-action="open-tuning"]');
		            if (queueClick) {
		                const abilityId = queueClick.dataset.abilityId || uiState.selectedId;
		                const qid = queueClick.dataset.qid || null;
		                if (!abilityId) return;
		                enterTuningPage(abilityId, qid);
		                return;
		            }

		            // 一级页面：从题库补充
		            const qbankOverviewBtn = e.target.closest('[data-action="open-qbank-overview"]');
		            if (qbankOverviewBtn) {
		                const abilityId = qbankOverviewBtn.dataset.abilityId;
		                if (!abilityId) return;
		                openQbankModalFromOverview(abilityId);
		                return;
		            }

		            const evolveBtn = e.target.closest('.action-evolve');
		            if (evolveBtn) {
		                const abilityId = evolveBtn.dataset.abilityId || uiState.selectedId;
		                if (!abilityId) return;
		                // 直接执行进化，不再弹出确认弹窗
		                directEvolution(abilityId);
		            }
		        });

		        document.addEventListener('keydown', (e) => {
		            if (uiState.route !== 'tuning') return;
		            if (e.key === 'Escape') {
		                e.preventDefault();
		                goOverview();
		                return;
		            }

		            const active = document.activeElement;
		            const isTyping = !!(active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA'));
		            if (isTyping) return;

		            if (e.key === 'Enter') {
		                const primary = document.querySelector('#tuningHost [data-tune-action=\"primary\"]');
		                if (primary) {
		                    e.preventDefault();
		                    primary.click();
		                }
			            } else if (e.key === 'g' || e.key === 'G') {
			                const gap = document.querySelector('#tuningHost [data-tune-action=\"gap-details\"]');
			                if (gap) {
			                    e.preventDefault();
			                    gap.click();
			                }
		            }
		        });

		        document.addEventListener('change', (e) => {
		            if (uiState.route !== 'tuning') return;
		            const cand = e.target && e.target.closest && e.target.closest('input[name="cand"]');
		            if (!cand) return;
		            const a = abilities.find(x => x.id === uiState.tuningAbilityId);
		            if (!a) return;
		            const qid = uiState.tuningQid;
		            const q = qid && a.queue ? (a.queue.find(x => x.id === qid) || null) : null;
		            if (!q) return;
		            const state = ensureTuningState(a, q.id);
		            state.selectedCandidate = cand.value || 'A';
		            const area = document.getElementById('tuneCustomArea');
		            if (area) area.style.display = (state.selectedCandidate === 'custom') ? '' : 'none';
		            if (state.selectedCandidate === 'custom') {
		                setTimeout(() => document.getElementById('tuneCustomAnswer')?.focus(), 0);
		            }
		        });

	        // ========== Modal ==========
	        function onOverlayClick(e) {
	            if (e.target.id === 'modalOverlay') {
	                closeModal();
	            }
	        }

	        function openModal({ title, bodyHtml, footerHtml, size, variant }) {
	            const overlay = document.getElementById('modalOverlay');
	            const root = document.getElementById('modalRoot');
	            document.getElementById('modalTitle').textContent = title;
	            document.getElementById('modalBody').innerHTML = bodyHtml || '';
	            document.getElementById('modalFooter').innerHTML = footerHtml || '';

	            root.classList.toggle('small', size === 'small');
	            root.classList.toggle('large', size === 'large');
	            root.classList.toggle('qbank-modal', size === 'qbank-modal');
	            root.classList.toggle('workbench', variant === 'workbench');
	            overlay.classList.add('active');
	        }

	        function closeModal() {
	            document.getElementById('modalOverlay').classList.remove('active');
	            const root = document.getElementById('modalRoot');
	            root.classList.remove('small', 'large', 'workbench', 'qbank-modal');
	            document.getElementById('modalBody').innerHTML = '';
	            document.getElementById('modalFooter').innerHTML = '';
	        }

        // ========== Toast ==========
        function toast(type, title, msg, timeoutMs = 2200) {
            const container = document.getElementById('toastContainer');
            const el = document.createElement('div');
            el.className = `toast ${type || 'info'}`;
            el.innerHTML = `
                <div class="icon">${type === 'success' ? '&#10003;' : type === 'warning' ? '&#9888;' : type === 'error' ? '&#10005;' : '&#8505;'}</div>
                <div class="content">
                    <div class="title">${escapeHtml(title || '')}</div>
                    <div class="msg">${escapeHtml(msg || '')}</div>
                </div>
                <div class="close" title="关闭">&times;</div>
            `;
            el.querySelector('.close').onclick = () => el.remove();
            container.appendChild(el);
            setTimeout(() => el.remove(), timeoutMs);
        }

        // 居中大Toast（升级成功）
        function toastCenterSuccess(title, desc, timeoutMs = 3000) {
            // 移除已存在的
            document.querySelectorAll('.toast-center-overlay').forEach(el => el.remove());

            const overlay = document.createElement('div');
            overlay.className = 'toast-center-overlay';
            overlay.innerHTML = `
                <div class="toast-center">
                    <div class="tc-icon">🎉</div>
                    <div class="tc-title">${escapeHtml(title)}</div>
                    <div class="tc-desc">${desc}</div>
                </div>
            `;

            // 点击任意处关闭
            overlay.addEventListener('click', () => overlay.remove());

            document.body.appendChild(overlay);
            setTimeout(() => overlay.remove(), timeoutMs);
        }

        function toastWithUndo(title, msg, undoCallback, timeoutMs = 4000) {
            const container = document.getElementById('toastContainer');
            const el = document.createElement('div');
            el.className = 'toast info';
            el.innerHTML = `
                <div class="icon">&#8505;</div>
                <div class="content">
                    <div class="title">${escapeHtml(title || '')}</div>
                    <div class="msg">${escapeHtml(msg || '')}</div>
                </div>
                <button class="btn btn-xs btn-ghost" style="margin-left:auto;flex-shrink:0;">撤销</button>
                <div class="close" title="关闭">&times;</div>
            `;
            el.querySelector('.close').onclick = () => el.remove();
            el.querySelector('.btn').onclick = () => {
                el.remove();
                if (typeof undoCallback === 'function') undoCallback();
            };
            container.appendChild(el);
            setTimeout(() => el.remove(), timeoutMs);
        }

        // 延迟执行Toast：倒计时结束后才执行confirmCallback，点撤销则取消执行
        function toastWithCountdown(title, msg, confirmCallback, cancelCallback, timeoutMs = 2500) {
            const container = document.getElementById('toastContainer');
            const el = document.createElement('div');
            el.className = 'toast info';
            el.style.position = 'relative';
            el.style.overflow = 'hidden';
            el.innerHTML = `
                <div class="icon">&#9203;</div>
                <div class="content">
                    <div class="title">${escapeHtml(title || '')}</div>
                    <div class="msg">${escapeHtml(msg || '')}</div>
                </div>
                <button class="btn btn-xs btn-ghost" style="margin-left:auto;flex-shrink:0;">撤销</button>
                <div class="countdown-bar" style="position:absolute;bottom:0;left:0;height:3px;background:var(--eva-primary);width:100%;transition:width ${timeoutMs}ms linear;"></div>
            `;
            container.appendChild(el);

            let cancelled = false;
            const bar = el.querySelector('.countdown-bar');
            // 触发reflow后开始动画
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    if (bar) bar.style.width = '0%';
                });
            });

            const timer = setTimeout(() => {
                if (!cancelled) {
                    el.remove();
                    if (typeof confirmCallback === 'function') confirmCallback();
                }
            }, timeoutMs);

            el.querySelector('.btn').onclick = () => {
                cancelled = true;
                clearTimeout(timer);
                el.remove();
                if (typeof cancelCallback === 'function') cancelCallback();
            };
        }

	        // ========== 业务：进化（进化工作台二级页） ==========
	        function inferChannel(q) {
	            const s = String(q?.source || '');
	            if (q?.channel) return q.channel;
	            if (s.includes('用户点踩')) return 'c_downvote';
	            if (s.includes('效果体验点踩')) return 'playground_downvote';
	            if (s.includes('题库')) return 'official';
	            if (s.includes('评测发现')) return 'official';
	            return 'official';
	        }

	        function channelLabel(channel) {
	            if (channel === 'c_downvote') return '用户点踩';
	            if (channel === 'playground_downvote') return '效果体验点踩';
	            if (channel === 'downvote') return '用户点踩'; // 兼容旧数据
	            return '题库';
	        }

	        function channelTag(channel) {
	            // 点踩用红色，题库用蓝色
	            if (channel === 'c_downvote' || channel === 'downvote') return `<span class="tag tag-error">用户点踩</span>`;
	            if (channel === 'playground_downvote') return `<span class="tag tag-error">效果体验点踩</span>`;
	            return `<span class="tag tag-info">题库</span>`;
	        }

	        function getSourceDetail(q) {
	            const src = String(q?.source || '').trim();
	            if (!src) return '';
	            const base = channelLabel(inferChannel(q));
	            if (src === base) return '';
	            if (src.includes(base)) return '';
	            return src;
	        }

		        function renderQueueMeta(q) {
		            const isGap = isSystemKnowledgeGap(q);
		            // MVP只显示知识缺口标签，其他问题类型标签移除
		            return isGap ? `<span class="tag tag-error">知识缺口</span>` : '';
		        }

		        function renderQueueTitleInline(q, titleClassName) {
		            const tag = renderQueueMeta(q);
		            const title = `<span class="${titleClassName}">${escapeHtml(q.title)}</span>`;
		            return tag ? `${tag}${title}` : title;
		        }

		        function renderQuestionMeta(q) {
		            const ch = inferChannel(q);
		            const isGap = isSystemKnowledgeGap(q);
		            const sourceTag = channelTag(ch);

		            // 来源：始终显示
		            const sourceRow = `<div class="meta-row"><span class="meta-label">来源</span><span class="meta-value">${sourceTag}</span></div>`;

		            // 问题类型：仅知识缺口时显示
		            const typeRow = isGap
		                ? `<div class="meta-row"><span class="meta-label">问题类型</span><span class="meta-value"><span class="tag tag-error">知识缺口</span></span></div>`
		                : '';

		            // 用户评论：有则展示带背景的引用块，无则显示「无」
		            const commentHtml = q?.userComment
		                ? `<span class="meta-comment">💬 ${escapeHtml(q.userComment)}</span>`
		                : `<span class="meta-value" style="color:var(--eva-text-tertiary);">无</span>`;

		            return `
		                ${sourceRow}
		                ${typeRow}
		                <div class="meta-row" style="align-items:flex-start;"><span class="meta-label">用户评论</span>${commentHtml}</div>
		            `;
		        }

	        function ensureTuningState(a, qid) {
	            a._tuneState = a._tuneState || {};
	            if (!a._tuneState[qid]) {
	                a._tuneState[qid] = {
	                    stage: 'choose', // choose | feedback | generating | candidates | custom
	                    feedbackText: '', // 点评输入内容
	                    feedbackHistory: [], // 点评历史（用于迭代）
	                    selectedCandidate: 'A',
	                    candidates: [],
	                    gapRiskAccepted: false
	                };
	            }
	            return a._tuneState[qid];
	        }

	        function getActiveTuningQuestion(a) {
	            if (!a) return null;
	            const qid = uiState.tuningQid;
	            if (qid && a.queue && a.queue.some(q => q.id === qid)) return qid;
	            return a.queue && a.queue.length ? a.queue[0].id : null;
	        }

	        function setTuningQuestion(qid) {
	            const a = abilities.find(x => x.id === uiState.tuningAbilityId);
	            if (!a) return;
	            if (!a.queue || !a.queue.some(q => q.id === qid)) return;
	            uiState.tuningQid = qid;
	            renderTuningPage();
	        }

	        function validateCustomAnswer(text) {
	            const t = String(text || '').trim();
	            if (t.length < 16) return { ok: false, reason: '答案过短' };
	            if (!/[\\u4e00-\\u9fa5A-Za-z]/.test(t)) return { ok: false, reason: '缺少有效内容' };
	            return { ok: true, reason: '' };
	        }

		        function isSystemKnowledgeGap(q) {
		            if (!q) return false;
		            if (q.kbCoverage === 'missing') return true;
		            if (q.systemKnowledgeGap === true) return true;
		            return false;
		        }

	        function generateCandidates(a, q, rating, tags) {
	            const tagHint = (tags || []).slice(0, 2).join('、');
	            const r = (rating === 'good' || rating === 'bad' || rating === 'mid') ? rating : 'mid';
	            const base = q?.title || '问题';
	            const channel = channelLabel(inferChannel(q));
	            const prefix = r === 'good' ? '更完整、更可执行' : r === 'bad' ? '更稳妥、更严谨' : '更清晰、更直接';
	            return [
	                `（${channel}）我理解你的情况。针对「${base}」，我先帮你确认关键信息，然后给你明确的处理步骤与时间预期。${tagHint ? `重点补齐：${tagHint}。` : ''}`,
	                `（${prefix}）关于「${base}」，我建议按 3 步处理：1) 先确认必要信息；2) 给出可选方案与边界；3) 告知下一步与预计时间。`,
	                `（更友好）我能理解这让人很困扰。关于「${base}」，我这边马上为你核对，并把对应规则与可执行方案一次性说明清楚。`
	            ];
	        }

	        function generateCandidatesFromFeedback(a, q, feedbackText, feedbackHistory) {
	            const base = q?.title || '问题';
	            const feedback = feedbackText || '';
	            const historyHint = (feedbackHistory || []).length > 0
	                ? `（结合历史点评：${feedbackHistory.slice(-2).join('；')}）`
	                : '';

	            // 根据点评内容生成更针对性的推荐回答
	            const feedbackLower = feedback.toLowerCase();
	            let style1 = '更精准';
	            let style2 = '更完整';
	            let style3 = '更友好';

	            if (feedbackLower.includes('数据') || feedbackLower.includes('具体')) {
	                style1 = '补充具体数据';
	            }
	            if (feedbackLower.includes('步骤') || feedbackLower.includes('流程')) {
	                style2 = '明确操作步骤';
	            }
	            if (feedbackLower.includes('语气') || feedbackLower.includes('态度')) {
	                style3 = '调整表达语气';
	            }

	            return [
	                `（${style1}）针对「${base}」，根据您的点评"${feedback.slice(0, 30)}${feedback.length > 30 ? '…' : ''}"，我重新整理回答：首先明确核心信息，然后给出可验证的数据支撑，最后说明后续步骤。${historyHint}`,
	                `（${style2}）关于「${base}」，我补充完善如下：1) 问题背景确认；2) 详细解决方案（含边界情况）；3) 预期结果与时间节点。`,
	                `（${style3}）我理解您的关注点。关于「${base}」，让我更清晰地说明：这个问题的关键在于…，建议的处理方式是…，如有疑问随时告诉我。`
	            ];
	        }

	        function applyRemoveFromQueue(a, qid) {
	            if (!a || !a.queue) return;
	            const idx = a.queue.findIndex(q => q.id === qid);
	            if (idx >= 0) a.queue.splice(idx, 1);
	            if (a._tuneState && a._tuneState[qid]) delete a._tuneState[qid];
	        }

	        function withQueueRemovalAnimation(fn) {
	            const active = document.querySelector('#tuningHost .wb-item.active');
	            if (!active) return fn();
	            active.classList.add('leaving');
	            setTimeout(fn, 160);
	        }

	        function pulseTuningProgress() {
	            const el = document.getElementById('tuneProgress');
	            if (!el) return;
	            el.classList.remove('pulse');
	            void el.offsetWidth;
	            el.classList.add('pulse');
	            setTimeout(() => el.classList.remove('pulse'), 920);
	        }

	        function scrollTuningQueueToActive() {
	            const el = document.querySelector('#tuningHost .wb-item.active');
	            if (!el) return;
	            el.scrollIntoView({ block: 'nearest' });
	        }

	        function tuneRemove(abilityId, qid) {
	            const a = abilities.find(x => x.id === abilityId);
	            if (!a) return;

	            const removedQ = a.queue ? a.queue.find(q => q.id === qid) : null;
	            const title = removedQ?.title || '此题';

	            // 延迟执行：倒计时2.5s后才真正移除
	            toastWithCountdown(
	                '即将移除',
	                title.length > 20 ? title.slice(0, 20) + '…' : title,
	                // confirmCallback：倒计时结束，真正执行移除
	                () => {
	                    withQueueRemovalAnimation(() => {
	                        if (!a.tuningStats) a.tuningStats = { total: 0, chosen: 0, custom: 0, removed: 0 };
	                        a.tuningStats.total += 1;
	                        a.tuningStats.removed += 1;

	                        a.pending = Math.max(0, (a.pending || 0) - 1);
	                        a.progress = recomputeProgress(a);
	                        applyRemoveFromQueue(a, qid);

	                        renderAll({ scrollToSelected: false, behavior: 'auto', preserveWheelScroll: true });
	                        renderTuningPage();
	                        pulseTuningProgress();
	                        scrollTuningQueueToActive();
	                        toast('success', '已移除', title.length > 15 ? title.slice(0, 15) + '…' : title);
	                    });
	                },
	                // cancelCallback：点撤销，取消移除，停留当前题
	                () => {
	                    toast('info', '已取消', '继续当前题目');
	                },
	                2500
	            );
	        }

	        function tuneMarkGap(abilityId, qid) {
	            const a = abilities.find(x => x.id === abilityId);
	            if (!a) return;
	            withQueueRemovalAnimation(() => {
	                if (!a.tuningStats) a.tuningStats = { total: 0, chosen: 0, custom: 0, removed: 0 };
	                a.tuningStats.total += 1;
	                a.tuningStats.removed += 1;

	                a.pending = Math.max(0, (a.pending || 0) - 1);
	                a.progress = recomputeProgress(a);
	                applyRemoveFromQueue(a, qid);

	                renderAll({ scrollToSelected: false, behavior: 'auto', preserveWheelScroll: true });
	                renderTuningPage();
	                pulseTuningProgress();
	                scrollTuningQueueToActive();

	                openModal({
	                    title: '此题为知识缺口',
	                    bodyHtml: `
	                        <div class="callout">
	                            <div class="callout-title">&#9888; 需要先补充资料</div>
	                            <div class="callout-desc">请先去知识库补充资料，再回来继续进化。</div>
	                        </div>
	                    `,
	                    footerHtml: `
	                        <button class="btn btn-secondary" type="button" onclick="closeModal()">知道了</button>
	                        <button class="btn btn-primary" type="button" onclick="toast('info','跳转','正在打开知识库…')">去知识库</button>
	                    `,
	                    size: 'small'
	                });
	            });
	        }

	        function tuneComplete(abilityId, qid, { method } = {}) {
	            const a = abilities.find(x => x.id === abilityId);
	            if (!a) return;
	            withQueueRemovalAnimation(() => {
	                if (!a.tuningStats) a.tuningStats = { total: 0, chosen: 0, custom: 0, removed: 0 };
	                a.tuningStats.total += 1;
	                if (method === 'custom') a.tuningStats.custom += 1;
	                else a.tuningStats.chosen += 1;

	                if (a.pending > 0) a.pending -= 1;
	                a.solved += 1;
	                a.progress = recomputeProgress(a);
	                applyRemoveFromQueue(a, qid);

	                ensureTodayCounter();
	                uiState.todaySubmits += 1;

	                renderAll({ scrollToSelected: false, behavior: 'auto', preserveWheelScroll: true });
	                renderTuningPage();
	                pulseTuningProgress();
	                scrollTuningQueueToActive();

	                toast('success', '已提交', `进化完成 · ${a.name} ${a.progress}%`);
	                if (a.progress >= 100) {
	                    toast('success', '已可升级', `${a.name} 已达 100%`, 2400);
	                }
	            });
	        }

	        function renderTuningQueue(a, activeQid) {
	            const list = Array.isArray(a.queue) ? a.queue.slice(0, 40) : [];

	            // 空状态：显眼的引导入口
	            if (!list.length) {
	                return `
	                    <div class="wb-empty-guide">
	                        <div class="wb-empty-guide-icon">📚</div>
	                        <div class="wb-empty-guide-title">进化题目已用完</div>
	                        <div class="wb-empty-guide-desc">补充更多题目，推动能力进化</div>
	                        <button class="wb-empty-guide-btn" type="button" data-tune-action="open-qbank">
	                            <span>➕</span><span class="text"> 从题库补充</span>
	                        </button>
	                    </div>
	                `;
	            }

	            // 渲染来源标签（右侧详情用）
	            function renderSourceTag(q) {
	                if (q.fromQbank) {
	                    return '<span class="source-tag from-qbank">题库</span>';
	                } else if (q.channel === 'c_downvote' || q.channel === 'downvote') {
	                    return '<span class="source-tag from-downvote">用户点踩</span>';
	                } else if (q.channel === 'playground_downvote') {
	                    return '<span class="source-tag from-downvote">效果体验点踩</span>';
	                }
	                return '';
	            }

	            // 列表项 + 底部补充按钮（队列只显示标题+知识缺口标签）
	            const items = list.map((q) => {
	                const isActive = q.id === activeQid;
	                const titleHtml = renderQueueTitleInline(q, 't-title');
	                return `
	                    <button class="wb-item ${isActive ? 'active' : ''}" type="button" data-qid="${escapeHtml(q.id)}">
	                        <div class="t">${titleHtml}</div>
	                    </button>
	                `;
	            }).join('');

	            // 底部常驻按钮
	            const addBtn = `
	                <button class="wb-add-from-qbank" type="button" data-tune-action="open-qbank">
	                    <span class="icon">➕</span><span class="text"> 从题库补充</span>
	                </button>
	            `;

	            return items + addBtn;
	        }

		        function renderTuningMain(a, q) {
			            const evolvable = (a.progress || 0) >= 100;
			            const stage = q ? ensureTuningState(a, q.id).stage : 'choose';
			            const state = q ? ensureTuningState(a, q.id) : null;
			            const gapCount = Array.isArray(a.queue) ? a.queue.filter(isSystemKnowledgeGap).length : 0;

			            const headerRight = `
			                <div class="wb-progress" id="tuneProgress">
			                    <div class="progress-track" style="min-width:200px;" aria-label="进化进度">
			                        <div class="progress-fill" style="width:${Math.max(0, Math.min(100, a.progress || 0))}%;"></div>
			                    </div>
			                    <div class="progress-meta" style="margin-top:8px;">
			                        <span style="font-size:12px;color:var(--eva-text-tertiary);">能力进化进度</span>
			                        <span class="pct" style="font-size:18px;font-weight:900;color:${evolvable ? 'var(--eva-success)' : 'var(--eva-primary)'};margin-left:6px;">${Math.max(0, Math.min(100, a.progress || 0))}%</span>
			                    </div>
			                </div>
			            `;

		            const questionBlock = q ? `
		                <div class="callout" style="min-height:140px;">
		                    <div class="callout-title">&#128203; 题目</div>
		                    <div class="callout-desc" style="margin-top:8px;font-size:13px;color:var(--eva-text-primary);line-height:1.7;">${escapeHtml(q.title)}</div>
		                    ${renderQuestionMeta(q)}
		                </div>
		            ` : `
		                <div class="callout">
		                    <div class="callout-title">&#128235; 队列为空</div>
		                    <div class="callout-desc">暂无可升级题目。</div>
		                </div>
		            `;

		            const agentAnswer = q?.agentAnswer || '好的，我帮您查一下订单情况。请问您的订单号是多少？';

	            const gapReason = q?.gapReason ? escapeHtml(q.gapReason) : '';
	            const isGap = q && isSystemKnowledgeGap(q);
	            const gapAccepted = state?.gapRiskAccepted;

			            const choosePanel = q ? `
			                <div class="callout tune-mode">
			                    <div class="callout-title">&#127919; 选择进化方式</div>
			                    <div class="callout-desc"></div>
			                    ${(isGap && !gapAccepted) ? `
			                        <div class="gap-blocking-bar">
			                            <div class="gap-blocking-icon">⚠️</div>
			                            <div class="gap-blocking-content">
			                                <div class="gap-blocking-title">知识缺口</div>
			                                <div class="gap-blocking-desc">知识库资料不足，建议先补充后再进化</div>
			                            </div>
			                            <div class="gap-blocking-actions">
			                                <button class="btn btn-xs btn-ghost" type="button" data-tune-action="accept-gap-risk">忽略，继续进化</button>
			                                <button class="btn btn-xs btn-secondary" type="button" data-tune-action="go-kb">去补充</button>
			                            </div>
			                        </div>
			                        <div style="display:flex;justify-content:flex-end;margin-top:10px;">
			                            <button class="btn btn-ghost" type="button" data-tune-action="remove">移除此题</button>
			                        </div>
			                    ` : `
			                    <div class="mode-grid">
			                        <button class="mode-card is-primary" type="button" data-tune-action="choose-eval">
			                            <span class="ic" style="background:var(--eva-primary-bg);border-color:rgba(99,102,241,0.22);color:var(--eva-primary);">&#128172;</span>
			                            <span style="min-width:0;">
			                                <div class="t">点评Agent回答</div>
			                                <div class="s">点评后系统将生成 3 个推荐回答</div>
			                            </span>
			                        </button>
			                        <button class="mode-card" type="button" data-tune-action="choose-custom">
			                            <span class="ic" style="background:var(--eva-border-light);color:var(--eva-text-secondary);">&#9997;</span>
			                            <span style="min-width:0;">
			                                <div class="t">直接输入正确答案</div>
			                                <div class="s">校验通过后将认定为已进化</div>
			                            </span>
			                        </button>
			                    </div>
			                    <div style="display:flex;justify-content:flex-end;margin-top:10px;">
			                        <button class="btn btn-ghost" type="button" data-tune-action="remove">移除此题</button>
			                    </div>
			                    `}
			                </div>
			            ` : '';

		            const feedbackPanel = q ? `
		                <div class="tune-panel">
		                    <div class="h">&#128172; 点评Agent回答</div>
		                    <div class="d">哪里不对？应该怎样改进？</div>
		                    <div class="tune-form">
		                        <textarea class="input" id="tuneFeedbackInput" rows="3" placeholder="例如：回答太笼统，应该给出具体的价格区间和数据来源">${escapeHtml(state.feedbackText || '')}</textarea>
		                        ${state.feedbackHistory && state.feedbackHistory.length > 0 ? `
		                            <div class="feedback-history">
		                                <div class="history-label">历史点评</div>
		                                ${state.feedbackHistory.map((h, i) => `<div class="history-item">${i + 1}. ${escapeHtml(h)}</div>`).join('')}
		                            </div>
		                        ` : ''}
		                        <div class="tune-row" style="justify-content:space-between;align-items:center;">
		                            <button class="btn btn-ghost" type="button" data-tune-action="remove">移除此题</button>
		                            <div style="display:flex;gap:8px;">
		                                <button class="btn btn-ghost" type="button" data-tune-action="go-custom">直接输入正确答案</button>
		                                <button class="btn btn-primary" type="button" data-tune-action="primary" data-next="generate">生成推荐回答</button>
		                            </div>
		                        </div>
		                    </div>
		                </div>
		            ` : '';

		            const generatingPanel = q ? `
		                <div class="tune-panel">
		                    <div class="h">&#8987; 正在生成推荐回答</div>
		                    <div class="d">根据您的点评生成 3 个推荐回答…</div>
		                    ${state.feedbackText ? `<div class="feedback-preview">点评：${escapeHtml(state.feedbackText)}</div>` : ''}
		                </div>
		            ` : '';

		            const candidatesPanel = q ? `
		                <div class="tune-panel">
		                    <div class="h">选择合适的回答</div>
		                    <div class="d">选择最符合预期的推荐回答</div>
		                    <div class="tune-form">
		                        ${state.feedbackText ? `<div class="feedback-preview" style="margin-bottom:8px;">您的点评：${escapeHtml(state.feedbackText)}</div>` : ''}
		                        <div class="options">
		                            ${(['A','B','C']).map((k, idx) => `
		                                <label class="opt">
		                                    <input type="radio" name="cand" value="${k}" ${state.selectedCandidate === k ? 'checked' : ''}>
		                                    <div>
		                                        <div class="t">推荐回答 ${k}</div>
		                                        <div class="cand-wrap">
		                                            <div class="cand-content collapsed" data-expand-content="${k}">${escapeHtml((state.candidates || [])[idx] || '（生成中…）')}</div>
		                                            <span class="expand-btn" data-expand-target="${k}" onclick="toggleCandExpand(this, event)">展开 ▼</span>
		                                        </div>
		                                    </div>
		                                </label>
		                            `).join('')}
		                        </div>
		                        <div class="tune-row" style="justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
		                            <button class="btn btn-ghost" type="button" data-tune-action="remove">移除此题</button>
		                            <div style="display:flex;gap:8px;flex-wrap:wrap;">
		                                <button class="btn btn-ghost" type="button" data-tune-action="edit-feedback">修改点评</button>
		                                <button class="btn btn-ghost" type="button" data-tune-action="go-custom">直接输入正确答案</button>
		                                <button class="btn btn-primary" type="button" data-tune-action="primary" data-next="submit-candidate">确认选择</button>
		                            </div>
		                        </div>
		                    </div>
		                </div>
		            ` : '';

		            const customPanel = q ? `
		                <div class="tune-panel">
		                    <div class="h">自行输入正确答案</div>
		                    <div class="d">校验通过后，直接认定为已进化</div>
		                    <div class="tune-form">
		                        <textarea class="input" id="tuneDirectAnswer" rows="4" placeholder="请输入正确答案"></textarea>
		                        <div class="tune-row" style="justify-content:space-between;align-items:center;">
		                            <button class="btn btn-ghost" type="button" data-tune-action="remove">移除此题</button>
		                            <div style="display:flex;gap:8px;">
		                                <button class="btn btn-ghost" type="button" data-tune-action="go-feedback">点评Agent回答</button>
		                                <button class="btn btn-primary" type="button" data-tune-action="primary" data-next="submit-custom">校验并提交</button>
		                            </div>
		                        </div>
		                    </div>
		                </div>
		            ` : '';

		            const stagePanel = evolvable
		                ? `
		                    <div class="tune-panel">
		                        <div class="h">&#10024; 已满足进化条件</div>
		                        <div class="d">${escapeHtml(a.version)} &#8594; <b>${escapeHtml(nextVersion(a.version))}</b></div>
		                    </div>
		                `
		                : stage === 'choose'
		                    ? choosePanel
		                    : stage === 'feedback'
		                        ? feedbackPanel
		                        : stage === 'generating'
		                            ? generatingPanel
		                            : stage === 'candidates'
		                                ? candidatesPanel
		                                : customPanel;

		            const disableTune = !q || evolvable;
		            const primaryHtml = evolvable
		                ? `<button class="btn btn-primary btn-evolve-cta" type="button" data-tune-action="evolve">&#10024; 升级</button>`
		                : '';

			            const skipHtml = '';

			            return `
			                <div class="wb-top">
			                    <div class="wb-top-left">
		                        <div class="wb-title">
		                            <span style="font-size:18px;line-height:1;">${a.icon}</span>
		                            <span style="min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(a.name)}</span>
		                            <span class="version-badge" style="margin-left:4px;">
		                                <span style="opacity:.85;">&#128227;</span>
		                                <span>${escapeHtml(a.version)}</span>
		                            </span>
		                        </div>
		                        <div class="wb-sub">待处理 ${a.pending} · 已处理 ${a.solved}</div>
		                    </div>
		                    <div class="wb-top-right">${headerRight}</div>
		                </div>

			                <div class="wb-question">
			                    ${questionBlock}
			                    <div class="qa-box">
			                        <div class="qa-head">
			                            <div class="label">&#129302; Agent 回答</div>
			                        </div>
		                        <div class="qa-body">
		                            <div class="bubble">${escapeHtml(agentAnswer)}</div>
		                        </div>
		                    </div>
			                    ${stagePanel}
			                </div>

			                ${(skipHtml || primaryHtml) ? `<div class="tune-actionbar"><div class="right">${skipHtml}${primaryHtml}</div></div>` : ''}
			            `;
			        }

		        function renderTuningPage() {
	            const host = document.getElementById('tuningHost');
	            const abilityId = uiState.tuningAbilityId;
	            const a = abilities.find(x => x.id === abilityId);
	            if (!host || !a) return;

	            if ((a.pending || 0) > 0) materializeQueue(a, 10);
	            const activeQid = getActiveTuningQuestion(a);
	            uiState.tuningQid = activeQid;
	            const q = activeQid && a.queue ? (a.queue.find(x => x.id === activeQid) || null) : null;

		            host.style.setProperty('--ability-color', a.color);
		            host.style.setProperty('--ability-color-light', mixHex(a.color, '#FFFFFF', 0.45));
		            host.style.setProperty('--ability-color-bg', hexToRgba(a.color, 0.10));
		            host.style.setProperty('--ability-color-border', hexToRgba(a.color, 0.24));

		            host.innerHTML = `
		                <div class="wb tuning-wb" style="--ability-color:${a.color};--ability-color-light:${mixHex(a.color, '#FFFFFF', 0.45)};--ability-color-bg:${hexToRgba(a.color, 0.10)};--ability-color-border:${hexToRgba(a.color, 0.24)};">
		                    <div class="wb-side">
		                        <div class="wb-side-head">
	                            <div>
	                                <div class="wb-side-title">待处理题目 (${a.pending})</div>
	                                <button class="demo-clear-btn" type="button" data-tune-action="demo-clear-queue" title="清空队列（仅用于产品演示）">🧹 清空（演示）</button>
	                            </div>
	                        </div>
	                        <div class="wb-list">${renderTuningQueue(a, activeQid)}</div>
	                    </div>
	                    <div class="wb-main">${renderTuningMain(a, q)}</div>
	                </div>
	            `;
		        }

		        function gapModalAcceptRisk() {
		            const a = abilities.find(x => x.id === uiState.tuningAbilityId);
		            if (!a) return;
		            const qid = uiState.tuningQid;
		            const q = qid && a.queue ? (a.queue.find(x => x.id === qid) || null) : null;
		            if (!q) return;
		            const state = ensureTuningState(a, q.id);
		            state.gapRiskAccepted = true;
		            closeModal();
		            renderTuningPage();
		            toast('info', '继续进化', '本题将不补知识库（自担风险）', 2200);
		        }

		        function gapModalGoKb() {
		            closeModal();
		            toast('info', '跳转', '正在打开知识库…');
		        }

		        // ========== 题库补充 Modal ==========

		        // 从一级页面打开题库 Modal
		        function openQbankModalFromOverview(abilityId) {
		            uiState.tuningAbilityId = abilityId;
		            openQbankModal();
		        }

		        function openQbankModal() {
		            const a = abilities.find(x => x.id === uiState.tuningAbilityId);
		            if (!a) return;

		            // 重置状态（MVP只使用题库，不区分自建/官方）
		            qbankState.tab = 'official';
		            qbankState.statusFilter = 'all';
		            qbankState.searchQuery = '';
		            qbankState.selectedIds = new Set();
		            qbankState.currentPage = 1; // 分页

		            renderQbankModal(a);
		        }

		        function getQbankList(abilityId, tab) {
		            const bank = questionBanks[tab];
		            return bank && bank[abilityId] ? bank[abilityId] : [];
		        }

		        function getFilteredQbankList(a) {
		            // MVP只使用题库
		            let list = getQbankList(a.id, 'official');

		            // 搜索筛选（移除状态筛选，MVP不需要）
		            if (qbankState.searchQuery.trim()) {
		                const query = qbankState.searchQuery.toLowerCase();
		                list = list.filter(q => q.title.toLowerCase().includes(query));
		            }

		            return list;
		        }

		        function isInQueue(a, qbankId) {
		            // 检查题目是否已在队列中（MVP只使用题库）
		            const prefix = 'qbank_o_';
		            return a.queue && a.queue.some(q => q.id === prefix + qbankId);
		        }

		        function renderQbankModal(a) {
		            const filteredList = getFilteredQbankList(a);

		            // 分页参数
		            const pageSize = 20;
		            const totalPages = Math.ceil(filteredList.length / pageSize) || 1;
		            const currentPage = Math.min(qbankState.currentPage || 1, totalPages);
		            const startIdx = (currentPage - 1) * pageSize;
		            const pageList = filteredList.slice(startIdx, startIdx + pageSize);

		            const selectableList = filteredList.filter(q => !isInQueue(a, q.id));
		            const allSelectableSelected = selectableList.length > 0 && selectableList.every(q => {
		                const fullId = 'qbank_o_' + q.id;
		                return qbankState.selectedIds.has(fullId);
		            });

		            const statusTagMap = {
		                pass: '', // 已通过不显示任何标签
		                fail: '<span class="qbank-item-tag suggest">知识缺口</span> ' // 句首显示
		            };

		            const listHtml = pageList.length === 0
		                ? `<div class="qbank-empty"><div class="qbank-empty-icon">📭</div><div class="qbank-empty-text">暂无符合条件的题目</div></div>`
		                : pageList.map(q => {
		                    const fullId = 'qbank_o_' + q.id;
		                    const inQueue = isInQueue(a, q.id);
		                    const isSelected = qbankState.selectedIds.has(fullId);
		                    const disabledClass = inQueue ? 'disabled' : '';
		                    const selectedClass = isSelected ? 'selected' : '';
		                    const statusTag = statusTagMap[q.status] || '';
		                    return `
		                        <label class="qbank-item ${disabledClass} ${selectedClass}" data-qbank-id="${fullId}">
		                            <input type="checkbox" ${isSelected ? 'checked' : ''} ${inQueue ? 'disabled' : ''}>
		                            <div class="qbank-item-content">
		                                <div class="qbank-item-title">${statusTag}${escapeHtml(q.title)}</div>
		                                <div class="qbank-item-meta">
		                                    ${inQueue ? '<span class="qbank-item-tag in-queue">已在队列</span>' : ''}
		                                </div>
		                            </div>
		                        </label>
		                    `;
		                }).join('');

		            // 分页控件
		            const paginationHtml = totalPages > 1 ? `
		                <div class="qbank-pagination">
		                    <button class="btn btn-xs btn-ghost" type="button" onclick="qbankGotoPage(${currentPage - 1})" ${currentPage <= 1 ? 'disabled' : ''}>上一页</button>
		                    <span class="qbank-page-info">${currentPage} / ${totalPages}</span>
		                    <button class="btn btn-xs btn-ghost" type="button" onclick="qbankGotoPage(${currentPage + 1})" ${currentPage >= totalPages ? 'disabled' : ''}>下一页</button>
		                </div>
		            ` : '';

		            openModal({
		                title: '补充题目',
		                size: 'qbank-modal',
		                bodyHtml: `
		                    <div class="qbank-filters" style="border-bottom: 1px solid var(--eva-border); padding-bottom: 12px; margin-bottom: 12px;">
		                        <input type="text" class="qbank-search" id="qbankSearch" placeholder="搜索题目..." value="${escapeHtml(qbankState.searchQuery)}" style="flex:1;">
		                        <span class="qbank-count">${filteredList.length} 题</span>
		                    </div>
		                    <div class="qbank-list-wrap">
		                        <label class="qbank-select-all" id="qbankSelectAll">
		                            <input type="checkbox" ${allSelectableSelected ? 'checked' : ''} ${selectableList.length === 0 ? 'disabled' : ''}>
		                            全选当前结果 (${selectableList.length} 题可选)
		                        </label>
		                        ${listHtml}
		                        ${paginationHtml}
		                    </div>
		                `,
		                footerHtml: `
		                    <div class="qbank-footer-info">已选 <strong>${qbankState.selectedIds.size}</strong> 题</div>
		                    <div class="qbank-footer-actions">
		                        <button class="btn btn-ghost" type="button" onclick="closeModal()">取消</button>
		                        <button class="btn btn-primary" type="button" onclick="confirmAddFromQbank()" ${qbankState.selectedIds.size === 0 ? 'disabled' : ''}>添加</button>
		                    </div>
		                `,
		                variant: ''
		            });

		            // 绑定事件
		            setTimeout(() => {
		                // 搜索
		                const searchInput = document.getElementById('qbankSearch');
		                if (searchInput) {
		                    searchInput.addEventListener('input', () => {
		                        qbankState.searchQuery = searchInput.value;
		                        qbankState.currentPage = 1; // 搜索时重置到第一页
		                        renderQbankModal(a);
		                    });
		                }

		                // 全选
		                const selectAllLabel = document.getElementById('qbankSelectAll');
		                if (selectAllLabel) {
		                    selectAllLabel.addEventListener('click', (e) => {
		                        if (e.target.tagName === 'INPUT') return;
		                        const cb = selectAllLabel.querySelector('input');
		                        if (cb && !cb.disabled) {
		                            cb.checked = !cb.checked;
		                            handleQbankSelectAll(a, cb.checked);
		                        }
		                    });
		                    const cb = selectAllLabel.querySelector('input');
		                    if (cb) {
		                        cb.addEventListener('change', () => {
		                            handleQbankSelectAll(a, cb.checked);
		                        });
		                    }
		                }

		                // 单个选择
		                document.querySelectorAll('.qbank-item').forEach(item => {
		                    item.addEventListener('click', (e) => {
		                        if (item.classList.contains('disabled')) return;
		                        if (e.target.tagName === 'INPUT') return;
		                        const cb = item.querySelector('input');
		                        if (cb && !cb.disabled) {
		                            cb.checked = !cb.checked;
		                            handleQbankItemToggle(a, item.dataset.qbankId, cb.checked);
		                        }
		                    });
		                    const cb = item.querySelector('input');
		                    if (cb) {
		                        cb.addEventListener('change', () => {
		                            handleQbankItemToggle(a, item.dataset.qbankId, cb.checked);
		                        });
		                    }
		                });
		            }, 50);
		        }

		        // 分页跳转
		        function qbankGotoPage(page) {
		            const a = abilities.find(x => x.id === uiState.tuningAbilityId);
		            if (!a) return;
		            qbankState.currentPage = Math.max(1, page);
		            renderQbankModal(a);
		        }

		        function handleQbankSelectAll(a, checked) {
		            const filteredList = getFilteredQbankList(a);

		            filteredList.forEach(q => {
		                if (isInQueue(a, q.id)) return;
		                const fullId = 'qbank_o_' + q.id;
		                if (checked) {
		                    qbankState.selectedIds.add(fullId);
		                } else {
		                    qbankState.selectedIds.delete(fullId);
		                }
		            });

		            renderQbankModal(a);
		        }

		        function handleQbankItemToggle(a, fullId, checked) {
		            if (checked) {
		                qbankState.selectedIds.add(fullId);
		            } else {
		                qbankState.selectedIds.delete(fullId);
		            }
		            renderQbankModal(a);
		        }

		        function confirmAddFromQbank() {
		            const a = abilities.find(x => x.id === uiState.tuningAbilityId);
		            if (!a || qbankState.selectedIds.size === 0) return;

		            const addedCount = qbankState.selectedIds.size;
		            const wasEmpty = !a.queue || a.queue.length === 0;
		            let firstAddedId = null;

		            // 添加选中的题目到队列（MVP只使用题库）
		            qbankState.selectedIds.forEach(fullId => {
		                const qbankId = fullId.replace('qbank_o_', '');
		                const list = getQbankList(a.id, 'official');
		                const qbankItem = list.find(q => q.id === qbankId);

		                if (qbankItem && !isInQueue(a, qbankId)) {
		                    const newQ = {
		                        id: fullId,
		                        source: '题库',
		                        channel: 'official',
		                        tag: '待评测',
		                        title: qbankItem.title,
		                        agentAnswer: '（待生成回答）',
		                        fromQbank: true
		                    };
		                    a.queue = a.queue || [];
		                    a.queue.push(newQ);
		                    if (!firstAddedId) firstAddedId = fullId;
		                }
		            });

		            // 更新 pending 计数
		            a.pending = (a.queue || []).length;

		            // 如果之前队列为空，自动选中第一个添加的题目（仅二级页面）
		            if (uiState.route === 'tuning' && wasEmpty && firstAddedId) {
		                uiState.tuningQid = firstAddedId;
		            }

		            closeModal();

		            // 根据当前页面刷新对应视图
		            if (uiState.route === 'tuning') {
		                renderTuningPage();
		            } else {
		                renderDetail(a);
		                renderAll(); // 刷新左侧卡片的 pending 数字
		            }

		            toast('success', '添加成功', `已添加 ${addedCount} 道题目到进化队列`, 2500);
		        }

		        function handleTuneAction(action, el) {
		            const a = abilities.find(x => x.id === uiState.tuningAbilityId);
		            if (!a) return;
	            const qid = uiState.tuningQid;
	            const q = qid && a.queue ? (a.queue.find(x => x.id === qid) || null) : null;
	            if (action === 'back') {
	                goOverview();
	                return;
	            }
	            if (action === 'open-qbank') {
	                openQbankModal();
	                return;
	            }
	            if (action === 'demo-clear-queue') {
	                // 演示用：清空当前队列
	                a.queue = [];
	                a.pending = 0;
	                uiState.tuningQid = null;
	                renderTuningPage();
	                toast('info', '演示模式', '队列已清空，可测试空状态效果', 2000);
	                return;
	            }
	            if (!q) return;

	            const state = ensureTuningState(a, q.id);
	            if (action === 'accept-gap-risk') {
	                state.gapRiskAccepted = true;
	                renderTuningPage();
	                return;
	            }
		            if (action === 'go-kb') {
		                toast('info', '跳转', '正在打开知识库…');
		                return;
		            }
		            if (action === 'gap-details') {
		                const reason = q?.gapReason ? `（${escapeHtml(q.gapReason)}）` : '';
		                openModal({
		                    title: '系统判定：知识库覆盖不足',
		                    bodyHtml: `
		                        <div class="callout" style="border-style:dashed;">
		                            <div class="callout-title">&#9888; 为什么会提示知识缺口？</div>
		                            <div class="callout-desc">系统检测该题依赖知识库资料，但当前覆盖不足${reason}，可能导致回答不准确或缺少关键细节。</div>
		                        </div>
		                        <div class="callout" style="margin-top:10px;">
		                            <div class="callout-title">&#128161; 建议的处理方式</div>
		                            <div class="callout-desc">优先补充知识库后再进化；若你确认不需要知识库覆盖，也可以继续进化（不补知识库，自担风险）。</div>
		                        </div>
		                    `,
		                    footerHtml: `
		                        <button class="btn btn-ghost" type="button" onclick="closeModal()">关闭</button>
		                        <button class="btn btn-secondary" type="button" onclick="gapModalAcceptRisk()">继续进化（自担风险）</button>
		                        <button class="btn btn-primary" type="button" onclick="gapModalGoKb()">去补充知识库</button>
		                    `,
		                    size: 'small'
		                });
		                return;
		            }

		            if (action === 'remove') return tuneRemove(a.id, q.id);
		            if (action === 'evolve') return directEvolution(a.id);

	            if (action === 'choose-eval') {
	                state.stage = 'feedback';
	                renderTuningPage();
	                return;
	            }
	            if (action === 'choose-custom') {
	                state.stage = 'custom';
	                renderTuningPage();
	                return;
	            }
	            if (action === 'back-stage') {
	                state.stage = 'choose';
	                renderTuningPage();
	                return;
	            }
	            if (action === 'go-custom') {
	                state.stage = 'custom';
	                renderTuningPage();
	                return;
	            }
	            if (action === 'go-feedback') {
	                state.stage = 'feedback';
	                renderTuningPage();
	                return;
	            }
	            if (action === 'edit-feedback') {
	                // 回到点评输入阶段，保留原内容
	                state.stage = 'feedback';
	                renderTuningPage();
	                return;
	            }
	            if (action === 'regenerate') {
	                // 将当前点评加入历史，重新生成
	                if (state.feedbackText && state.feedbackText.trim()) {
	                    state.feedbackHistory = state.feedbackHistory || [];
	                    if (!state.feedbackHistory.includes(state.feedbackText.trim())) {
	                        state.feedbackHistory.push(state.feedbackText.trim());
	                    }
	                }
	                state.stage = 'generating';
	                state.candidates = [];
	                renderTuningPage();
	                setTimeout(() => {
	                    state.candidates = generateCandidatesFromFeedback(a, q, state.feedbackText, state.feedbackHistory);
	                    state.selectedCandidate = 'A';
	                    state.stage = 'candidates';
	                    renderTuningPage();
	                }, 700);
	                return;
	            }

	            if (action === 'primary') {
	                const next = String(el?.dataset?.next || '');
	                if (next === 'generate') {
	                    // 保存点评内容
	                    const feedbackInput = document.getElementById('tuneFeedbackInput');
	                    const feedbackText = (feedbackInput?.value || '').trim();
	                    if (!feedbackText) {
	                        toast('warning', '请输入点评', '告诉我们这个回答哪里不对');
	                        return;
	                    }
	                    state.feedbackText = feedbackText;
	                    state.stage = 'generating';
	                    state.candidates = [];
	                    renderTuningPage();
	                    setTimeout(() => {
	                        state.candidates = generateCandidatesFromFeedback(a, q, state.feedbackText, state.feedbackHistory);
	                        state.selectedCandidate = 'A';
	                        state.stage = 'candidates';
	                        renderTuningPage();
	                    }, 700);
	                    return;
	                }
	                if (next === 'submit-custom') {
	                    const text = (document.getElementById('tuneDirectAnswer')?.value || '').trim();
	                    const v = validateCustomAnswer(text);
	                    if (!v.ok) {
	                        toast('warning', '校验未通过', v.reason);
	                        return;
	                    }
	                    tuneComplete(a.id, q.id, { method: 'custom' });
	                    return;
	                }
	                if (next === 'submit-candidate') {
	                    const selected = document.querySelector('#tuningHost input[name=\"cand\"]:checked')?.value || 'A';
	                    tuneComplete(a.id, q.id, { method: 'chosen', candidate: selected });
	                    return;
	                }
	            }
	        }

        function openKnowledgeGapInfo() {
            openModal({
                title: '知识缺口说明',
                bodyHtml: `
                    <div class="callout">
                        <div class="callout-title">&#8505; 什么是知识缺口？</div>
                        <div class="callout-desc">当题目所需资料在知识库中缺失时，进化无法解决根因。请先补充资料，再继续评测与进化。</div>
                    </div>
                    <div class="callout" style="border-style:dashed;">
                        <div class="callout-title">&#128204; 处理方式</div>
                        <div class="callout-desc">补充资料 &#8594; 重新评测 &#8594; 回到队列继续进化</div>
                    </div>
                `,
                footerHtml: `<button class="btn btn-primary" type="button" onclick="closeModal()">知道了</button>`,
                size: 'small'
            });
        }

        // ========== 业务：进化 ==========
        // 直接进化（无二次确认弹窗，有等待状态）
        async function directEvolution(abilityId) {
            const a = abilities.find(x => x.id === abilityId);
            if (!a) return;

            if (a.progress < 100) {
                toast('warning', '未达进化条件', `${a.name} 需进化至 100% 才可升级（当前 ${a.progress}%）`, 2400);
                return;
            }

            // 找到进化按钮并显示"升级中"状态
            const evolveBtn = document.querySelector(`.action-evolve[data-ability-id="${abilityId}"]`);
            const originalBtnText = evolveBtn ? evolveBtn.innerHTML : '';
            if (evolveBtn) {
                evolveBtn.disabled = true;
                evolveBtn.innerHTML = '<span class="spinner-small"></span> 升级中';
                evolveBtn.classList.add('is-loading');
            }

            // 等待一小段时间模拟处理
            await new Promise(r => setTimeout(r, 800));

            // 执行实际的进化逻辑（复用 confirmEvolution 的核心部分）
            await confirmEvolution(abilityId);

            // 恢复按钮状态（实际上 confirmEvolution 会更新整个UI）
            if (evolveBtn) {
                evolveBtn.disabled = false;
                evolveBtn.innerHTML = originalBtnText;
                evolveBtn.classList.remove('is-loading');
            }
        }

        // 保留原确认弹窗函数（不删除，以备后续恢复）
        function openEvolveConfirmModal(abilityId) {
            const a = abilities.find(x => x.id === abilityId);
            if (!a) return;

            if (a.progress < 100) {
                toast('warning', '未达进化条件', `${a.name} 需进化至 100% 才可升级（当前 ${a.progress}%）`, 2400);
                return;
            }

            const toV = nextVersion(a.version);
            const s = a.tuningStats || { total: 0, chosen: 0, custom: 0, removed: 0 };
            openModal({
                title: '确认升级',
                bodyHtml: `
                    <div class="callout">
                        <div class="callout-title">&#10024; 即将发布新版本</div>
                        <div class="callout-desc">即将将「${escapeHtml(a.name)}」能力升级至 <b>${escapeHtml(toV)}</b>。</div>
                    </div>
                    <div class="callout">
                        <div class="callout-title">&#128202; 本次进化摘要</div>
                        <div class="callout-desc">进化题目数：<b>${s.total || 50}</b> 题 · 采纳回答：<b>${s.chosen || 32}</b> 题 · 自答：<b>${s.custom || 18}</b> 题 · 移除：<b>${s.removed || 0}</b> 题</div>
                    </div>
                    <div class="callout" style="border-style:dashed;">
                        <div class="callout-title">&#128161; 发布后</div>
                        <div class="callout-desc">版本升级至 <b>${escapeHtml(toV)}</b>，进化进度归零，并沉淀本次发布记录。</div>
                    </div>
                `,
                footerHtml: `
                    <button class="btn btn-secondary" type="button" onclick="closeModal()">取消</button>
                    <button class="btn btn-primary" type="button" onclick="confirmEvolution('${abilityId}')">确认升级</button>
                `,
                size: 'small'
            });
        }

        function createSparkles(cardEl) {
            if (!cardEl) return;
            const existing = cardEl.querySelector('.sparkles');
            if (existing) existing.remove();

            const wrap = document.createElement('div');
            wrap.className = 'sparkles';

            const count = 10;
            for (let i = 0; i < count; i++) {
                const s = document.createElement('div');
                s.className = 'sparkle';
                s.style.left = (10 + Math.random() * 80).toFixed(1) + '%';
                s.style.top = (18 + Math.random() * 64).toFixed(1) + '%';
                s.style.animationDelay = (Math.random() * 320).toFixed(0) + 'ms';
                wrap.appendChild(s);
            }

            cardEl.appendChild(wrap);
            setTimeout(() => wrap.remove(), 1100);
        }

	        async function confirmEvolution(abilityId) {
	            const a = abilities.find(x => x.id === abilityId);
	            if (!a) return;
	            closeModal();

	            const tile = document.querySelector(`.ability-tile[data-ability-id="${abilityId}"]`);
	            const tileRoller = tile?.querySelector('[data-role="tileVersionRoller"]');
	            const tileFill = tile?.querySelector('[data-role="tileProgressFill"]');
	            const tileText = tile?.querySelector('[data-role="tileProgressText"]');

	            const detailHost = document.getElementById('abilityDetailHost');
	            const detailRoller = detailHost?.querySelector('[data-role="detailVersionRoller"]');
	            const detailFill = detailHost?.querySelector('[data-role="detailProgressFill"]');
	            const detailText = detailHost?.querySelector('[data-role="detailProgressText"]');

            const fromV = a.version;
	            const toV = nextVersion(a.version);

	            uiState.selectedId = abilityId;
	            if (tile) tile.classList.add('is-evolving');
	            createSparkles(tile);

	            // 版本滚动：把第二行设为目标版本，然后触发滚动
	            const roll = (rollerEl) => {
	                if (!rollerEl) return;
	                const spans = rollerEl.querySelectorAll('span');
	                if (spans.length < 2) return;
	                spans[0].textContent = fromV;
	                spans[1].textContent = toV;
	                rollerEl.classList.add('rolling');
	            };

	            roll(tileRoller);
	            roll(detailRoller);

	            // 进度条不做倒退动画，动效结束后由 renderAll 直接显示新状态

	            await new Promise(r => setTimeout(r, 900));

            a.version = toV;
            a.progress = 0;
            a.pending = Math.max(a.pending, 0);
            a.solved = 0;

            const stats = a.tuningStats || { total: 0, chosen: 0, custom: 0, removed: 0 };
            const today = new Date();
            const at = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
            a.history = a.history || [];
            a.history.push({ from: fromV, to: toV, at, stats: { ...stats } });
            a.tuningStats = { total: 0, chosen: 0, custom: 0, removed: 0 };

            // 结束动画并同步UI
            const stopRoll = (rollerEl) => {
                if (!rollerEl) return;
                rollerEl.classList.remove('rolling');
                const spans = rollerEl.querySelectorAll('span');
                if (spans.length < 2) return;
                spans[0].textContent = toV;
                spans[1].textContent = toV;
            };

	            stopRoll(tileRoller);
		            stopRoll(detailRoller);

	            if (tile) tile.classList.remove('is-evolving');
	            if (uiState.route !== 'overview') {
	                uiState.route = 'overview';
	                uiState.tuningMode = 'single';
	                uiState.tuningAbilityId = null;
	                uiState.tuningQid = null;
	                updateRouteUi();
	            }
	            renderAll({ scrollToSelected: false, behavior: 'auto', preserveWheelScroll: true });

	            // 使用居中Toast代替弹窗
	            toastCenterSuccess(
	                '升级成功！',
	                `「${escapeHtml(a.name)}」已升级至 <b>${escapeHtml(toV)}</b><br>Agent 正在学习新内容，即将生效`,
	                3500
	            );
        }

        // ========== 工具 ==========
	        function resetDemo() {
	            abilities = cloneSeed();
	            uiState.filter = 'all';
	            uiState.query = '';
	            uiState.selectedId = null;
	            uiState.todayKey = getTodayKey();
	            uiState.todaySubmits = 0;
	            uiState.route = 'overview';
	            uiState.tuningMode = 'single';
	            uiState.tuningAbilityId = null;
	            uiState.tuningQid = null;
	            uiState.filter = 'all';
	            uiState.query = '';
	            updateRouteUi();
	            renderAll({ scrollToSelected: true, behavior: 'auto', preserveWheelScroll: false });
	            toast('info', '已重置', '演示数据已恢复为初始状态');
	        }

        // ========== 页面初始化 ==========
	        document.addEventListener('DOMContentLoaded', () => {
	            abilities = cloneSeed();
	            uiState.todayKey = getTodayKey();
	            updateRouteUi();

            // 原型工具默认隐藏：?tools=1 显示；?mode=artboard 或 ?view=artboard 同时启用
	            const urlParams = new URLSearchParams(window.location.search || '');
	            const wantsArtboard = (urlParams.get('mode') === 'artboard') || (urlParams.get('view') === 'artboard');
	            const wantsTools = (urlParams.get('tools') === '1') || wantsArtboard;
	            if (wantsTools) document.body.classList.add('proto-tools');
	            if (wantsArtboard) switchMode('artboard');

            // 动态为每个画板添加下载按钮
            document.querySelectorAll('.artboard').forEach(artboard => {
                const label = artboard.querySelector('.artboard-label');
                const labelId = label?.querySelector('.artboard-label-id');
                if (!label || !labelId) return;

                const rightContainer = document.createElement('div');
                rightContainer.className = 'artboard-label-right';

                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'artboard-download-btn';
                downloadBtn.innerHTML = '&#128229;';
                downloadBtn.title = '下载为PNG图片';
                downloadBtn.onclick = (e) => {
                    e.stopPropagation();
                    downloadArtboard(artboard.id);
                };

                rightContainer.appendChild(downloadBtn);
                rightContainer.appendChild(labelId);
                label.appendChild(rightContainer);
            });

	            renderAll({ scrollToSelected: true, behavior: 'auto', preserveWheelScroll: false });
	        });
    </script>
</body>
</html>
